<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>Tavern Ledger ‚Äî D&D Character Forge</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@700&family=Cinzel:wght@400;600&family=Crimson+Text:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
<style>
/* =============================================================================
   CSS VARIABLES & RESET
============================================================================= */
:root {
  --gold:   #c9a84c;
  --gold2:  #e8c96a;
  --dark:   #0d0b07;
  --dark2:  #1a1510;
  --dark3:  #251e14;
  --dark4:  #2e2518;
  --parch:  #f0e6c8;
  --parch2: #e8d9a8;
  --red:    #8b2020;
  --ink:    #2a1f0a;
}
*, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
html { scroll-behavior: smooth; }
body {
  background: var(--dark);
  color: var(--parch);
  font-family: 'Crimson Text', serif;
  font-size: 17px;
  min-height: 100vh;
  background-image:
    radial-gradient(ellipse at 20% 50%, rgba(201,168,76,.05) 0%, transparent 60%),
    radial-gradient(ellipse at 80% 20%, rgba(139,32,32,.05) 0%, transparent 50%);
}
h1, h2, h3, h4 { font-family: 'Cinzel', serif; }

/* =============================================================================
   PAGE TRANSITIONS
============================================================================= */
.page { opacity: 0; transition: opacity .35s ease; }
.page.active { display: block; }
#app-page { display: block; }
.page.visible { opacity: 1; }

/* =============================================================================
   AUTH PAGE
============================================================================= */
#auth-page {
  display: flex; align-items: center; justify-content: center;
  min-height: 100vh; padding: 16px;
  position: fixed; inset: 0;
  background: var(--dark);
  z-index: 500;
  background-image:
    radial-gradient(ellipse at 20% 50%, rgba(201,168,76,.05) 0%, transparent 60%),
    radial-gradient(ellipse at 80% 20%, rgba(139,32,32,.05) 0%, transparent 50%);
}
.auth-wrap { width: 100%; max-width: 420px; }
.auth-logo { text-align: center; margin-bottom: 28px; }
.auth-logo .title { font-family: 'Cinzel Decorative', serif; color: var(--gold); font-size: 2rem; display: block; }
.auth-logo .sub   { color: var(--parch2); font-style: italic; font-size: 1rem; }
.auth-box {
  background: var(--dark2);
  border: 1px solid rgba(201,168,76,.5);
  padding: 32px;
  animation: fadeUp .4s ease;
}
@keyframes fadeUp { from { opacity:0; transform:translateY(16px); } to { opacity:1; transform:none; } }
.auth-tabs { display: flex; margin-bottom: 24px; border-bottom: 1px solid rgba(201,168,76,.4); }
.auth-tab {
  flex: 1; padding: 10px;
  background: none; border: none;
  color: var(--parch2); font-family: 'Cinzel', serif;
  cursor: pointer; font-size: .9rem; transition: .2s;
  position: relative;
}
.auth-tab.active { color: var(--gold); }
.auth-tab.active::after {
  content: ''; position: absolute; bottom: -1px; left: 0; right: 0;
  height: 2px; background: var(--gold);
}

/* =============================================================================
   FORM ELEMENTS
============================================================================= */
label {
  display: block; font-family: 'Cinzel', serif;
  font-size: .78rem; color: var(--gold2);
  margin-bottom: 4px; letter-spacing: .05em;
}
input[type=text], input[type=password], input[type=email],
input[type=number], select, textarea {
  width: 100%; background: var(--dark3);
  border: 1px solid rgba(201,168,76,.35);
  color: var(--parch); padding: 10px 12px;
  font-family: 'Crimson Text', serif; font-size: 1rem;
  margin-bottom: 14px; outline: none; transition: .2s;
  border-radius: 2px; -webkit-appearance: none; appearance: none;
}
input:focus, select:focus, textarea:focus {
  border-color: var(--gold);
  background: var(--dark4);
}
select option { background: var(--dark3); }
textarea { resize: vertical; min-height: 80px; }

/* =============================================================================
   BUTTONS
============================================================================= */
.btn {
  display: inline-flex; align-items: center; justify-content: center;
  gap: 6px; padding: 11px 20px;
  font-family: 'Cinzel', serif; font-size: .85rem;
  cursor: pointer; border: none; transition: .2s;
  letter-spacing: .05em; border-radius: 2px; white-space: nowrap;
}
.btn-gold   { background: var(--gold);  color: var(--dark); font-weight: 700; }
.btn-gold:hover, .btn-gold:active { background: var(--gold2); }
.btn-outline { background: transparent; border: 1px solid var(--gold); color: var(--gold); }
.btn-outline:hover, .btn-outline:active { background: rgba(201,168,76,.12); }
.btn-red   { background: var(--red);    color: var(--parch); }
.btn-red:hover { background: #a02525; }
.btn-green { background: #1a5c1a;       color: var(--parch); }
.btn-green:hover { background: #226622; }
.btn-sm   { padding: 6px 12px; font-size: .78rem; }
.btn-full { width: 100%; }
.err { color: #e05555; font-size: .88rem; margin-bottom: 10px; font-style: italic; }

/* =============================================================================
   NAVIGATION
============================================================================= */
#nav {
  background: var(--dark2);
  border-bottom: 1px solid rgba(201,168,76,.5);
  padding: 0 16px;
  display: flex; align-items: center; justify-content: space-between;
  position: sticky; top: 0; z-index: 200;
  min-height: 52px;
}
.nav-logo  { font-family: 'Cinzel Decorative', serif; color: var(--gold); font-size: 1rem; flex-shrink: 0; }
.nav-links { display: flex; gap: 0; overflow-x: auto; -webkit-overflow-scrolling: touch; }
.nav-links::-webkit-scrollbar { display: none; }
.nav-link {
  padding: 14px 12px; color: var(--parch2);
  font-family: 'Cinzel', serif; font-size: .75rem;
  cursor: pointer; border-bottom: 2px solid transparent; transition: .2s;
  letter-spacing: .04em;
  background: none; border-top: none; border-left: none; border-right: none;
  white-space: nowrap; flex-shrink: 0;
}
.nav-link:hover, .nav-link.active { color: var(--gold); border-bottom-color: var(--gold); }
.nav-right  { display: flex; align-items: center; gap: 8px; flex-shrink: 0; }
.nav-user   { color: var(--parch2); font-size: .85rem; font-style: italic; display: none; }
@media (min-width: 600px) { .nav-user { display: block; } }

/* Hamburger (mobile) */
.hamburger {
  display: none; flex-direction: column; gap: 4px;
  cursor: pointer; padding: 8px;
  background: none; border: none;
}
.hamburger span { width: 22px; height: 2px; background: var(--gold); transition: .2s; }
@media (max-width: 600px) {
  .hamburger { display: flex; }
  .nav-links {
    position: fixed; top: 52px; left: 0; right: 0;
    background: var(--dark2); border-bottom: 1px solid var(--gold);
    flex-direction: column; padding: 8px 0; display: none; z-index: 199;
  }
  .nav-links.open { display: flex; }
  .nav-link { padding: 12px 20px; border-bottom: 1px solid rgba(201,168,76,.1); font-size: .9rem; }
  .nav-link:last-child { border-bottom: none; }
}

/* =============================================================================
   LAYOUT ‚Äî MAIN, GRID
============================================================================= */
.main { padding: 20px 16px; max-width: 1100px; margin: 0 auto; }
@media (min-width: 768px) { .main { padding: 28px 24px; } }
.page-title    { font-family: 'Cinzel Decorative', serif; color: var(--gold); font-size: 1.5rem; margin-bottom: 4px; }
.page-subtitle { color: var(--parch2); font-style: italic; margin-bottom: 24px; font-size: .95rem; }

.grid-2 { display: grid; grid-template-columns: 1fr 1fr;           gap: 14px; }
.grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr;       gap: 12px; }
.grid-4 { display: grid; grid-template-columns: repeat(4, 1fr);    gap: 10px; }
.grid-6 { display: grid; grid-template-columns: repeat(6, 1fr);    gap: 10px; }
@media (max-width: 600px) {
  .grid-2 { grid-template-columns: 1fr; }
  .grid-3 { grid-template-columns: 1fr 1fr; }
  .grid-4 { grid-template-columns: repeat(2, 1fr); }
  .grid-6 { grid-template-columns: repeat(3, 1fr); }
}
@media (max-width: 380px) {
  .grid-3 { grid-template-columns: 1fr; }
  .grid-6 { grid-template-columns: repeat(2, 1fr); }
}

/* =============================================================================
   CARDS
============================================================================= */
.card { background: var(--dark2); border: 1px solid rgba(201,168,76,.25); padding: 16px; margin-bottom: 14px; }
.card-title { font-family: 'Cinzel', serif; color: var(--gold); font-size: .9rem; margin-bottom: 12px; padding-bottom: 6px; border-bottom: 1px solid rgba(201,168,76,.2); }

/* Character cards */
.char-card { background: var(--dark2); border: 1px solid rgba(201,168,76,.25); padding: 16px; margin-bottom: 10px; transition: .2s; }
.char-card:hover { border-color: rgba(201,168,76,.6); }
.char-name { font-family: 'Cinzel', serif; color: var(--gold); font-size: 1.05rem; }
.char-info { color: var(--parch2); font-size: .88rem; font-style: italic; margin: 4px 0; }
.char-actions { display: flex; gap: 6px; flex-wrap: wrap; margin-top: 10px; }

/* Stat boxes */
.stat-box { background: var(--dark3); border: 1px solid rgba(201,168,76,.4); padding: 10px 6px; text-align: center; }
.stat-label  { font-family: 'Cinzel', serif; font-size: .65rem; color: var(--gold2); letter-spacing: .04em; display: block; margin-bottom: 3px; }
.stat-score  { font-size: 1.6rem; font-weight: 700; color: var(--parch); line-height: 1; }
.stat-mod    { color: var(--gold); font-size: .9rem; margin-top: 2px; }
.stat-input-sm { width: 100%; text-align: center; font-size: 1.3rem; padding: 4px; margin-bottom: 0; }

/* Combat stats */
.cs { background: var(--dark3); border: 1px solid rgba(201,168,76,.4); padding: 10px 6px; text-align: center; }
.cs-val { font-size: 1.5rem; font-family: 'Cinzel', serif; color: var(--parch); line-height: 1; }
.cs-lbl { font-family: 'Cinzel', serif; font-size: .62rem; color: var(--gold2); letter-spacing: .04em; margin-top: 3px; }

/* =============================================================================
   SKILLS, SAVES, SPELLS, EQUIPMENT, FEATURES
============================================================================= */
.skill-row { display: flex; align-items: center; gap: 6px; padding: 3px 0; border-bottom: 1px solid rgba(201,168,76,.08); }
.skill-row input[type=checkbox] { width: 15px; height: 15px; accent-color: var(--gold); flex-shrink: 0; }
.skill-name  { flex: 1; font-size: .9rem; }
.skill-bonus { font-family: 'Cinzel', serif; color: var(--gold); font-size: .85rem; min-width: 28px; text-align: right; }
.prof-dot    { width: 9px; height: 9px; border-radius: 50%; border: 1px solid var(--gold); display: inline-block; flex-shrink: 0; }
.prof-dot.filled { background: var(--gold); }

.spell-item   { background: var(--dark3); border: 1px solid rgba(201,168,76,.18); padding: 9px; margin-bottom: 7px; }
.spell-header { display: flex; justify-content: space-between; align-items: center; cursor: pointer; gap: 8px; }
.spell-name   { font-family: 'Cinzel', serif; color: var(--gold); font-size: .9rem; }
.spell-body   { display: none; margin-top: 8px; font-size: .88rem; color: var(--parch2); }
.spell-body.open { display: block; }
.conc-badge   { font-size: .7rem; background: rgba(201,168,76,.2); border: 1px solid var(--gold); color: var(--gold); padding: 1px 5px; border-radius: 2px; flex-shrink: 0; }

.equip-row   { display: flex; align-items: center; gap: 6px; padding: 5px 0; border-bottom: 1px solid rgba(201,168,76,.1); flex-wrap: wrap; }
.equip-name  { flex: 1; min-width: 100px; }
.equip-qty, .equip-wt-in { width: 52px; margin: 0; padding: 5px; text-align: center; }

.feature-item { background: var(--dark3); border: 1px solid rgba(201,168,76,.15); padding: 9px; margin-bottom: 5px; }
.feature-name { font-family: 'Cinzel', serif; color: var(--gold2); font-size: .88rem; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
.feature-desc { display: none; margin-top: 6px; font-size: .86rem; color: var(--parch2); line-height: 1.5; }
.feature-desc.open { display: block; }

/* =============================================================================
   SPELL SLOTS & HP
============================================================================= */
.slot-row { display: flex; align-items: center; gap: 6px; margin-bottom: 7px; flex-wrap: wrap; }
.slot-pip  { width: 18px; height: 18px; border-radius: 50%; border: 1px solid var(--gold); cursor: pointer; transition: .2s; flex-shrink: 0; }
.slot-pip.used  { background: var(--dark3); }
.slot-pip.avail { background: var(--gold); }

.hp-bar  { height: 7px; background: var(--dark3); border: 1px solid rgba(201,168,76,.2); margin-top: 5px; }
.hp-fill { height: 100%; background: linear-gradient(90deg, #8b2020, #c03030); transition: .4s; }

/* Death saves */
.save-pip { width: 15px; height: 15px; border-radius: 50%; border: 1px solid; cursor: pointer; flex-shrink: 0; }
.save-success { border-color: #55a055; }
.save-success.filled { background: #55a055; }
.save-fail    { border-color: #e05555; }
.save-fail.filled    { background: #e05555; }

/* Inspiration */
.inspiration-pip {
  width: 28px; height: 28px; border-radius: 50%;
  border: 2px solid var(--gold); cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  font-size: .7rem; color: var(--gold); transition: .2s;
}
.inspiration-pip.active { background: var(--gold); color: var(--dark); }

/* =============================================================================
   ATTACKS TABLE
============================================================================= */
.attack-row {
  display: grid;
  grid-template-columns: 2fr 1fr 1fr 1.5fr auto;
  gap: 6px; align-items: center; padding: 5px 0;
  border-bottom: 1px solid rgba(201,168,76,.1);
}
.attack-row input { margin: 0; padding: 5px; }
@media (max-width: 500px) { .attack-row { grid-template-columns: 1fr 1fr auto; } }

/* =============================================================================
   TABS
============================================================================= */
.tab-bar {
  display: flex; flex-wrap: nowrap; overflow-x: auto;
  border-bottom: 1px solid rgba(201,168,76,.3); margin-bottom: 18px;
  -webkit-overflow-scrolling: touch;
}
.tab-bar::-webkit-scrollbar        { height: 3px; }
.tab-bar::-webkit-scrollbar-thumb  { background: var(--gold); }
.tab-btn {
  padding: 9px 14px; background: none; border: none;
  color: var(--parch2); font-family: 'Cinzel', serif;
  font-size: .75rem; cursor: pointer; letter-spacing: .04em;
  border-bottom: 2px solid transparent; transition: .2s;
  white-space: nowrap; flex-shrink: 0;
}
.tab-btn:hover, .tab-btn.active { color: var(--gold); border-bottom-color: var(--gold); }
.tab-panel        { display: none; }
.tab-panel.active { display: block; }

/* =============================================================================
   ABILITY METHOD BUTTONS
============================================================================= */
.method-btn {
  padding: 8px 14px; background: var(--dark3);
  border: 1px solid rgba(201,168,76,.3);
  color: var(--parch); font-family: 'Cinzel', serif;
  font-size: .75rem; cursor: pointer; transition: .2s;
  margin: 0 6px 6px 0;
}
.method-btn.active { background: rgba(201,168,76,.18); border-color: var(--gold); color: var(--gold); }

/* =============================================================================
   MULTICLASS
============================================================================= */
.mc-entry { background: var(--dark3); border: 1px solid rgba(201,168,76,.2); padding: 10px; margin-bottom: 8px; display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }

/* =============================================================================
   DICE
============================================================================= */
.die-btn {
  width: 64px; height: 64px;
  background: var(--dark3); border: 2px solid rgba(201,168,76,.45);
  color: var(--gold); font-family: 'Cinzel', serif; font-size: .85rem;
  cursor: pointer; transition: .2s;
  display: flex; align-items: center; justify-content: center;
  clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%);
  flex-shrink: 0;
}
.die-btn:hover, .die-btn:active { background: var(--gold); color: var(--dark); }
.roll-result {
  background: var(--dark3); border: 1px solid var(--gold);
  padding: 16px; margin: 14px 0;
  font-family: 'Cinzel', serif; color: var(--gold);
  min-height: 70px;
  display: flex; align-items: center; justify-content: center;
  gap: 10px; flex-wrap: wrap; text-align: center;
}
.roll-history { background: var(--dark3); border: 1px solid rgba(201,168,76,.2); padding: 12px; max-height: 220px; overflow-y: auto; }
.roll-entry   { padding: 3px 0; border-bottom: 1px solid rgba(201,168,76,.1); font-size: .86rem; color: var(--parch2); }

/* =============================================================================
   CAMPAIGNS
============================================================================= */
.campaign-card  { background: var(--dark2); border: 1px solid rgba(201,168,76,.25); padding: 16px; margin-bottom: 12px; }
.cp-tab { background:none; border:none; border-bottom:2px solid transparent; color:var(--parch2); font-family:'Cinzel',serif; font-size:.72rem; padding:5px 12px; cursor:pointer; transition:.15s; }
.cp-tab:hover { color:var(--gold); }
.cp-tab.active { color:var(--gold); border-bottom-color:var(--gold); }
.cp-panel { }
.campaign-name  { font-family: 'Cinzel', serif; color: var(--gold); font-size: 1.05rem; margin-bottom: 5px; }
.journal-entry  { background: var(--dark3); border-left: 3px solid var(--gold); padding: 10px; margin-bottom: 6px; }
.journal-date   { color: var(--gold2); font-size: .78rem; font-family: 'Cinzel', serif; margin-bottom: 3px; }

/* =============================================================================
   REFERENCE
============================================================================= */
.ref-item  { background: var(--dark3); border: 1px solid rgba(201,168,76,.15); padding: 8px; margin-bottom: 5px; }
.ref-name  { font-family: 'Cinzel', serif; color: var(--gold2); font-size: .86rem; cursor: pointer; }
.ref-desc  { display: none; margin-top: 5px; font-size: .85rem; color: var(--parch2); line-height: 1.5; }
.ref-desc.open { display: block; }

/* =============================================================================
   MODALS
============================================================================= */
.modal-bg {
  display: none; position: fixed; inset: 0;
  background: rgba(0,0,0,.88); z-index: 300;
  align-items: flex-start; justify-content: center;
  padding: 16px; overflow-y: auto;
}
.modal-bg.open { display: flex; }
.modal {
  background: var(--dark2); border: 1px solid rgba(201,168,76,.5);
  padding: 24px; width: 100%; max-width: 860px;
  position: relative; margin: auto;
}
.modal-title { font-family: 'Cinzel Decorative', serif; color: var(--gold); font-size: 1.1rem; margin-bottom: 18px; padding-right: 30px; }
.modal-close { position: absolute; top: 12px; right: 12px; background: none; border: none; color: var(--parch2); font-size: 1.1rem; cursor: pointer; padding: 6px; line-height: 1; }

/* =============================================================================
   BADGES & MISC UTILITIES
============================================================================= */
.badge        { display: inline-block; padding: 1px 7px; font-family: 'Cinzel', serif; font-size: .68rem; border: 1px solid; margin-right: 3px; margin-bottom: 2px; }
.badge-gold   { border-color: var(--gold);   color: var(--gold); }
.badge-red    { border-color: var(--red);    color: #e05555; }
.badge-green  { border-color: #2a6a2a;       color: #55a055; }
.badge-blue   { border-color: #2a4a8a;       color: #6080d0; }

.section-h { font-family: 'Cinzel', serif; color: var(--gold); font-size: .88rem; margin: 18px 0 10px; padding-bottom: 5px; border-bottom: 1px solid rgba(201,168,76,.2); }
.muted     { color: var(--parch2); font-style: italic; font-size: .9rem; }
.gold      { color: var(--gold); }
.divider   { border: none; border-top: 1px solid rgba(201,168,76,.2); margin: 14px 0; }
.flex-between { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 8px; }
.tags      { display: flex; flex-wrap: wrap; gap: 4px; margin-top: 6px; }
.input-row { display: flex; gap: 8px; align-items: flex-end; flex-wrap: wrap; }
.input-row > *         { flex: 1; min-width: 80px; }
.input-row > .btn      { flex: 0; margin-bottom: 0; }
.input-row input,
.input-row select      { margin-bottom: 0; }

/* Custom scrollbar */
::-webkit-scrollbar       { width: 5px; height: 5px; }
::-webkit-scrollbar-track { background: var(--dark); }
::-webkit-scrollbar-thumb { background: var(--gold); border-radius: 3px; }
</style>
</head>
<body>

<!-- ============================================================
     AUTH PAGE
============================================================ -->
<div id="auth-page" class="page active visible">
  <div id="auth-screen" style="display:flex;align-items:center;justify-content:center;min-height:100vh;padding:16px">
    <div class="auth-wrap">
      <div class="auth-logo">
        <span class="title">Tavern Ledger</span>
        <span class="sub">D&D Character Forge</span>
      </div>
      <div class="auth-box">
        <div class="auth-tabs">
          <button class="auth-tab active" onclick="switchAuthTab('login',this)">Sign In</button>
          <button class="auth-tab" onclick="switchAuthTab('register',this)">Create Account</button>
        </div>
        <!-- Login form -->
        <div id="auth-login">
          <label>Username</label>
          <input type="text" id="login-user" placeholder="Your name, traveler..." autocomplete="username">
          <label>Password</label>
          <input type="password" id="login-pass" placeholder="Secret passphrase..." autocomplete="current-password">
          <div id="login-err" class="err" style="display:none"></div>
          <button class="btn btn-gold btn-full" onclick="doLogin()">Enter the Tavern</button>
          <button class="btn btn-outline btn-full" style="margin-top:8px" onclick="doGuest()">‚öî Play as Guest (no account needed)</button>
          <p style="color:var(--parch2);font-size:.8rem;margin-top:10px;font-style:italic">
            ‚ö† Accounts are stored in your browser. For cross-device access, use the same browser or export your characters.
          </p>
        </div>
        <!-- Register form -->
        <div id="auth-register" style="display:none">
          <label>Username</label>
          <input type="text" id="reg-user" placeholder="Choose a name..." autocomplete="username">
          <label>Email (optional)</label>
          <input type="email" id="reg-email" placeholder="your@email.com" autocomplete="email">
          <label>Password</label>
          <input type="password" id="reg-pass" placeholder="At least 6 characters..." autocomplete="new-password">
          <label>Confirm Password</label>
          <input type="password" id="reg-pass2" placeholder="Repeat password..." autocomplete="new-password">
          <div id="reg-err" class="err" style="display:none"></div>
          <button class="btn btn-gold btn-full" onclick="doRegister()">Begin Your Journey</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ============================================================
     APP PAGE
============================================================ -->
<div id="app-page" class="page">

  <!-- Navigation -->
  <div id="nav">
    <div class="nav-logo">‚öî Tavern Ledger</div>
    <nav class="nav-links" id="nav-links">
      <button class="nav-link active" onclick="showSection('characters');closeNav()">Characters</button>
      <button class="nav-link" onclick="showSection('dice');closeNav()">Dice Roller</button>
      <button class="nav-link" onclick="showSection('campaigns');closeNav()">Campaigns</button>
      <button class="nav-link" onclick="showSection('reference');closeNav()">Reference</button>
      <button class="nav-link" onclick="showSection('dmtools');closeNav()">‚öî DM Tools</button>
    </nav>
    <div class="nav-right">
      <span class="nav-user" id="nav-username"></span>
      <button class="btn btn-outline btn-sm" onclick="doLogout()">Leave</button>
      <button class="hamburger" onclick="toggleNav()" aria-label="Menu">
        <span></span><span></span><span></span>
      </button>
    </div>
  </div>

  <!-- ‚îÄ‚îÄ CHARACTERS ‚îÄ‚îÄ -->
  <div id="section-characters" class="main">
    <div class="page-title">Your Characters</div>
    <div class="page-subtitle">All adventurers bound to your account</div>
    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:18px">
      <button class="btn btn-gold" onclick="openCharCreator()">+ New Character</button>
      <button class="btn btn-outline btn-sm" onclick="exportCharacters()" title="Download all characters as JSON">‚¨á Export All</button>
      <label class="btn btn-outline btn-sm" style="cursor:pointer" title="Import characters from JSON file">‚¨Ü Import
        <input type="file" accept=".json" style="display:none" onchange="importCharacters(event)">
      </label>
    </div>
    <div id="char-list"></div>
  </div>

  <!-- ‚îÄ‚îÄ DICE ROLLER ‚îÄ‚îÄ -->
  <div id="section-dice" class="main" style="display:none">
    <div class="page-title">Dice Roller</div>
    <div class="page-subtitle">May fortune favor the bold</div>
    <div class="grid-2">
      <div class="card">
        <div class="card-title">Roll Dice</div>
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:10px;flex-wrap:wrap">
          <input type="number" id="dice-qty" value="1" min="1" max="99" style="width:56px;margin:0">
          <span class="muted">√ó</span>
          <input type="number" id="dice-mod" value="0" style="width:56px;margin:0" placeholder="Mod">
          <span class="muted">modifier</span>
        </div>
        <div style="display:flex;flex-wrap:wrap;gap:8px;justify-content:flex-start;margin:12px 0">
          <button class="die-btn" onclick="rollDice(4)">d4</button>
          <button class="die-btn" onclick="rollDice(6)">d6</button>
          <button class="die-btn" onclick="rollDice(8)">d8</button>
          <button class="die-btn" onclick="rollDice(10)">d10</button>
          <button class="die-btn" onclick="rollDice(12)">d12</button>
          <button class="die-btn" onclick="rollDice(20)">d20</button>
          <button class="die-btn" onclick="rollDice(100)">d%</button>
        </div>
        <div class="roll-result" id="roll-result"><span class="muted" style="font-size:.9rem">Click a die to roll</span></div>
      </div>
      <div class="card">
        <div class="card-title">Quick Rolls</div>
        <div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:14px">
          <button class="btn btn-outline btn-sm" onclick="quickRoll('Advantage',20,2,'high')">Advantage</button>
          <button class="btn btn-outline btn-sm" onclick="quickRoll('Disadvantage',20,2,'low')">Disadvantage</button>
          <button class="btn btn-outline btn-sm" onclick="rollAbilityScores()">4d6 Ability Scores</button>
          <button class="btn btn-outline btn-sm" onclick="rollDeathSave()">Death Save</button>
        </div>
        <div class="card-title">Roll History</div>
        <div class="roll-history" id="roll-history"></div>
        <button class="btn btn-outline btn-sm" style="margin-top:8px" onclick="clearHistory()">Clear</button>
      </div>
    </div>
  </div>

  <!-- ‚îÄ‚îÄ CAMPAIGNS ‚îÄ‚îÄ -->
  <div id="section-campaigns" class="main" style="display:none">
    <div class="page-title">Campaigns</div>
    <div class="page-subtitle">Track your adventures</div>
    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:18px">
      <button class="btn btn-gold" onclick="openNewCampaign()">+ New Campaign</button>
      <button class="btn btn-outline" onclick="openJoinCampaign()">üîë Join with Code</button>
    </div>
    <div id="campaign-list"></div>
  </div>

  <!-- ‚îÄ‚îÄ DM TOOLS ‚îÄ‚îÄ -->
  <div id="section-dmtools" class="main" style="display:none">
    <div class="page-title">DM Tools</div>
    <div class="page-subtitle">Run your session like a pro</div>

    <!-- Initiative Tracker -->
    <div class="card" style="margin-bottom:14px">
      <div class="card-title">‚öî Initiative Tracker</div>
      <div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:10px">
        <input type="text"   id="init-name"  placeholder="Name (player or enemy)..." style="flex:2;margin:0">
        <input type="number" id="init-roll"  placeholder="Init roll" style="width:80px;margin:0">
        <input type="number" id="init-hp"    placeholder="HP" style="width:70px;margin:0">
        <input type="number" id="init-ac"    placeholder="AC" style="width:60px;margin:0">
        <select id="init-type" style="margin:0;width:100px">
          <option value="player">Player</option>
          <option value="enemy">Enemy</option>
          <option value="ally">Ally</option>
        </select>
        <button class="btn btn-gold btn-sm" onclick="addInitEntry()">Add</button>
        <button class="btn btn-outline btn-sm" onclick="rollAllInit()">üé≤ Roll All</button>
        <button class="btn btn-red btn-sm" onclick="clearInitTracker()">Clear</button>
      </div>
      <div id="init-round" style="font-family:'Cinzel',serif;font-size:.8rem;color:var(--gold2);margin-bottom:6px"></div>
      <div id="init-list"></div>
      <div style="display:flex;gap:6px;margin-top:8px">
        <button class="btn btn-outline btn-sm" onclick="nextInitTurn()">‚ñ∂ Next Turn</button>
        <button class="btn btn-outline btn-sm" onclick="prevInitTurn()">‚óÄ Prev</button>
        <button class="btn btn-outline btn-sm" onclick="nextInitRound()">‚è≠ Next Round</button>
      </div>
    </div>

    <!-- Party View -->
    <div class="card" style="margin-bottom:14px">
      <div class="card-title">üõ° Party Overview</div>
      <div id="party-view-list">
        <div class="muted">Characters linked to campaigns will appear here.</div>
      </div>
      <button class="btn btn-outline btn-sm" style="margin-top:8px" onclick="refreshPartyView()">‚Ü∫ Refresh</button>
    </div>

    <!-- NPC / Monster Stat Blocks -->
    <div class="card" style="margin-bottom:14px">
      <div class="card-title">üëæ NPC & Monster Stat Blocks</div>
      <div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:10px;align-items:flex-end">
        <div style="flex:2"><label style="font-size:.78rem">Name</label><input type="text" id="npc-name" placeholder="Goblin Scout..." style="margin:0"></div>
        <div><label style="font-size:.78rem">HP</label><input type="number" id="npc-hp" placeholder="HP" style="width:65px;margin:0"></div>
        <div><label style="font-size:.78rem">AC</label><input type="number" id="npc-ac" placeholder="AC" style="width:60px;margin:0"></div>
        <div><label style="font-size:.78rem">Speed</label><input type="number" id="npc-speed" placeholder="30" style="width:65px;margin:0"></div>
        <div><label style="font-size:.78rem">CR</label><input type="text" id="npc-cr" placeholder="1/4" style="width:55px;margin:0"></div>
      </div>
      <div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:8px">
        <input type="text" id="npc-attacks" placeholder="Attacks: Scimitar +4, 1d6+2 slashing..." style="flex:1;margin:0">
        <input type="text" id="npc-traits"  placeholder="Traits: Nimble Escape, Darkvision 60ft..." style="flex:1;margin:0">
      </div>
      <div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:8px">
        <select id="npc-type" style="margin:0">
          <option>Beast</option><option>Humanoid</option><option>Undead</option>
          <option>Fiend</option><option>Celestial</option><option>Dragon</option>
          <option>Construct</option><option>Elemental</option><option>Fey</option>
          <option>Giant</option><option>Monstrosity</option><option>Ooze</option>
          <option>Plant</option><option>Aberration</option>
        </select>
        <input type="text" id="npc-notes" placeholder="Notes..." style="flex:1;margin:0">
        <button class="btn btn-gold btn-sm" onclick="addNPC()">Add NPC</button>
      </div>
      <div id="npc-list"></div>
    </div>

    <!-- Tactical Grid Map -->
    <div class="card">
      <div class="card-title">üó∫ Tactical Map</div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px;align-items:center">
        <label style="margin:0;font-size:.82rem">Grid:</label>
        <select id="map-size" onchange="resizeMap()" style="margin:0;width:100px">
          <option value="16">16√ó16</option>
          <option value="20" selected>20√ó20</option>
          <option value="24">24√ó24</option>
          <option value="30">30√ó30</option>
        </select>
        <label style="margin:0;font-size:.82rem">Tool:</label>
        <select id="map-tool" style="margin:0;width:120px">
          <option value="token">ü™ô Token</option>
          <option value="wall">üß± Wall</option>
          <option value="difficult">üåø Difficult</option>
          <option value="water">üíß Water</option>
          <option value="erase">üóë Erase</option>
        </select>
        <input type="text" id="map-token-label" placeholder="Token label..." style="width:110px;margin:0">
        <input type="color" id="map-token-color" value="#c9a84c" style="width:36px;height:30px;padding:2px;margin:0;background:none;border:1px solid rgba(201,168,76,.3);cursor:pointer">
        <button class="btn btn-outline btn-sm" onclick="clearMap()">Clear</button>
        <button class="btn btn-outline btn-sm" onclick="undoMap()">‚Ü© Undo</button>
      </div>
      <div style="overflow:auto;max-width:100%">
        <canvas id="tactical-map" style="display:block;cursor:crosshair;border:1px solid rgba(201,168,76,.3)"></canvas>
      </div>
      <div style="font-size:.78rem;color:var(--parch2);margin-top:6px">Click to place. Right-click a token to remove. Each square = 5ft.</div>
    </div>
  </div>

  <!-- ‚îÄ‚îÄ REFERENCE ‚îÄ‚îÄ -->
  <div id="section-reference" class="main" style="display:none">
    <div class="page-title">Quick Reference</div>
    <div class="page-subtitle">Rules at a glance</div>
    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:16px">
      <button class="btn btn-gold btn-sm" onclick="openModal('spell-lookup-modal');filterSpellDB()">üìñ Spell Lookup</button>
      <button class="btn btn-gold btn-sm" onclick="openModal('shop-modal');filterShop()">‚öî Equipment Shop</button>
    </div>
    <div class="grid-2">
      <div class="card"><div class="card-title">Conditions</div><div id="conditions-list"></div></div>
      <div class="card"><div class="card-title">Actions in Combat</div><div id="actions-list"></div></div>
    </div>
    <div class="grid-2">
      <div class="card"><div class="card-title">Cover & Vision</div><div id="cover-list"></div></div>
      <div class="card"><div class="card-title">Common DCs</div><div id="dc-list"></div></div>
    </div>
    <div class="card"><div class="card-title">Damage Types</div><div id="dmg-list"></div></div>
    <div class="grid-2" style="margin-top:0">
      <div class="card"><div class="card-title">Common Weapons</div><div id="weapons-list"></div></div>
      <div class="card"><div class="card-title">Armor & AC</div><div id="armor-list"></div></div>
    </div>
  </div>
</div>

<!-- ============================================================
     SPELL LOOKUP MODAL
============================================================ -->
<div class="modal-bg" id="spell-lookup-modal">
  <div class="modal" style="max-width:780px">
    <div class="modal-title">üìñ Spell Lookup</div>
    <button class="modal-close" onclick="closeModal('spell-lookup-modal')">‚úï</button>
    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px">
      <input type="text" id="spell-search-db" placeholder="Search by name..." style="flex:2;margin:0" oninput="filterSpellDB()">
      <select id="spell-filter-class" onchange="filterSpellDB()" style="margin:0">
        <option value="">All Classes</option>
        <option>Artificer</option><option>Bard</option><option>Cleric</option><option>Druid</option>
        <option>Paladin</option><option>Ranger</option><option>Sorcerer</option><option>Warlock</option><option>Wizard</option>
      </select>
      <select id="spell-filter-level" onchange="filterSpellDB()" style="margin:0;width:90px">
        <option value="">All Levels</option>
        <option value="0">Cantrip</option><option value="1">1st</option><option value="2">2nd</option>
        <option value="3">3rd</option><option value="4">4th</option><option value="5">5th</option>
        <option value="6">6th</option><option value="7">7th</option><option value="8">8th</option><option value="9">9th</option>
      </select>
      <select id="spell-filter-school" onchange="filterSpellDB()" style="margin:0">
        <option value="">All Schools</option>
        <option>Abjuration</option><option>Conjuration</option><option>Divination</option><option>Enchantment</option>
        <option>Evocation</option><option>Illusion</option><option>Necromancy</option><option>Transmutation</option>
      </select>
    </div>
    <div id="spell-db-results" style="max-height:420px;overflow-y:auto"></div>
  </div>
</div>

<!-- ============================================================
     EQUIPMENT SHOP MODAL
============================================================ -->
<div class="modal-bg" id="shop-modal">
  <div class="modal" style="max-width:700px">
    <div class="modal-title">‚öî Equipment Shop</div>
    <button class="modal-close" onclick="closeModal('shop-modal')">‚úï</button>
    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px">
      <input type="text" id="shop-search" placeholder="Search items..." style="flex:2;margin:0" oninput="filterShop()">
      <select id="shop-filter-cat" onchange="filterShop()" style="margin:0">
        <option value="">All Categories</option>
        <option>Simple Weapons</option><option>Martial Weapons</option><option>Light Armor</option>
        <option>Medium Armor</option><option>Heavy Armor</option><option>Shields</option>
        <option>Adventuring Gear</option><option>Tools</option><option>Mounts</option>
      </select>
    </div>
    <div id="shop-results" style="max-height:420px;overflow-y:auto"></div>
  </div>
</div>

<!-- ============================================================
     CHARACTER CREATOR MODAL
============================================================ -->
<div class="modal-bg" id="creator-modal">
  <div class="modal" style="max-width:920px">
    <div class="modal-title" id="creator-title">Create New Character</div>
    <button class="modal-close" onclick="closeModal('creator-modal')">‚úï</button>
    <div class="tab-bar">
      <button class="tab-btn active" onclick="creatorTab('basics',this)">Basics</button>
      <button class="tab-btn" onclick="creatorTab('abilities',this)">Abilities</button>
      <button class="tab-btn" onclick="creatorTab('combat',this)">Combat</button>
      <button class="tab-btn" onclick="creatorTab('skills',this)">Skills</button>
      <button class="tab-btn" onclick="creatorTab('spells',this)">Spells</button>
      <button class="tab-btn" onclick="creatorTab('equipment',this)">Equipment</button>
      <button class="tab-btn" onclick="creatorTab('features',this)">Features</button>
      <button class="tab-btn" onclick="creatorTab('personality',this)">Personality</button>
      <button class="tab-btn" onclick="creatorTab('notes',this)">Notes</button>
    </div>

    <!-- ‚îÄ‚îÄ BASICS TAB ‚îÄ‚îÄ -->
    <div class="tab-panel active" id="creator-basics">
      <div class="grid-2">
        <div>
          <label>Character Name</label>
          <input type="text" id="c-name" placeholder="Name your hero...">
          <label>Race</label>
          <select id="c-race" onchange="updateRaceInfo()">
            <option value="">‚Äî Select Race ‚Äî</option>
            <optgroup label="Player's Handbook">
              <option>Dragonborn</option><option>Dwarf (Hill)</option><option>Dwarf (Mountain)</option>
              <option>Elf (High)</option><option>Elf (Wood)</option><option>Elf (Drow)</option>
              <option>Gnome (Forest)</option><option>Gnome (Rock)</option><option>Half-Elf</option>
              <option>Half-Orc</option><option>Halfling (Lightfoot)</option><option>Halfling (Stout)</option>
              <option>Human</option><option>Human (Variant)</option><option>Tiefling</option>
            </optgroup>
            <optgroup label="Volo's / Mordenkainen's">
              <option>Aasimar</option><option>Bugbear</option><option>Firbolg</option>
              <option>Goblin</option><option>Goliath</option><option>Hobgoblin</option>
              <option>Kenku</option><option>Kobold</option><option>Lizardfolk</option>
              <option>Orc</option><option>Tabaxi</option><option>Triton</option>
              <option>Yuan-ti Pureblood</option>
            </optgroup>
            <optgroup label="Elemental Evil / Other">
              <option>Aarakocra</option><option>Air Genasi</option><option>Earth Genasi</option>
              <option>Fire Genasi</option><option>Water Genasi</option><option>Tortle</option>
            </optgroup>
            <optgroup label="Eberron">
              <option>Warforged</option><option>Changeling</option><option>Kalashtar</option>
              <option>Shifter (Beasthide)</option><option>Shifter (Longtooth)</option>
              <option>Shifter (Swiftstride)</option><option>Shifter (Wildhunt)</option>
            </optgroup>
            <optgroup label="Mythic Odysseys / Other">
              <option>Leonin</option><option>Satyr</option><option>Simic Hybrid</option>
              <option>Vedalken</option><option>Loxodon</option><option>Minotaur</option>
              <option>Locathah</option><option>Verdan</option>
            </optgroup>
            <optgroup label="Homebrew / Setting-Specific">
              <option>Centaur</option><option>Fairy</option><option>Harengon</option>
              <option>Owlfolk</option><option>Rabbitfolk</option>
            </optgroup>
          </select>
          <div id="race-info" class="muted" style="margin-top:-10px;margin-bottom:12px;font-size:.82rem"></div>
          <label>Subrace / Variant</label>
          <select id="c-subrace" onchange="updateSubraceInfo()">
            <option value="">‚Äî Select Race First ‚Äî</option>
          </select>
          <div id="subrace-info" style="margin-top:-10px;margin-bottom:12px;font-size:.82rem"></div>
          <label>Class</label>
          <select id="c-class" onchange="updateClassInfo()">
            <option value="">‚Äî Select Class ‚Äî</option>
            <option>Artificer</option><option>Barbarian</option><option>Bard</option>
            <option>Cleric</option><option>Druid</option><option>Fighter</option>
            <option>Monk</option><option>Paladin</option><option>Ranger</option>
            <option>Rogue</option><option>Sorcerer</option><option>Warlock</option><option>Wizard</option>
          </select>
          <div id="class-info" class="muted" style="margin-top:-10px;margin-bottom:12px;font-size:.82rem"></div>
          <label>Subclass</label>
          <select id="c-subclass" onchange="updateSubclassInfo()"><option value="">‚Äî Select Class First ‚Äî</option></select>
          <div id="subclass-info"></div>
        </div>
        <div>
          <label>Level (1‚Äì20)</label>
          <input type="number" id="c-level" value="1" min="1" max="20" onchange="updateLevel();updateClassInfo(document.getElementById('c-subclass').value||undefined)">
          <label>Background</label>
          <select id="c-background" onchange="updateBackgroundInfo()">
            <option value="">‚Äî Select Background ‚Äî</option>
            <option>Acolyte</option><option>Charlatan</option><option>Criminal</option>
            <option>Entertainer</option><option>Folk Hero</option><option>Guild Artisan</option>
            <option>Hermit</option><option>Knight</option><option>Noble</option>
            <option>Outlander</option><option>Sage</option><option>Sailor</option>
            <option>Soldier</option><option>Urchin</option><option>Pirate</option>
            <option>Spy</option><option>Gladiator</option><option>Haunted One</option>
            <option>Far Traveler</option><option>Inheritor</option><option>Urban Bounty Hunter</option>
            <option>Mercenary Veteran</option><option>City Watch</option><option>Clan Crafter</option>
            <option>Courtier</option><option>Faction Agent</option><option>Gate Warden</option>
          </select>
          <div id="bg-info" class="muted" style="margin-top:-10px;margin-bottom:12px;font-size:.82rem"></div>
          <label>Alignment</label>
          <select id="c-alignment">
            <option value="">‚Äî Select ‚Äî</option>
            <option>Lawful Good</option><option>Neutral Good</option><option>Chaotic Good</option>
            <option>Lawful Neutral</option><option>True Neutral</option><option>Chaotic Neutral</option>
            <option>Lawful Evil</option><option>Neutral Evil</option><option>Chaotic Evil</option>
          </select>
          <label>Experience Points</label>
          <input type="number" id="c-xp" value="0" min="0">
          <label>Portrait URL (optional)</label>
          <input type="text" id="c-portrait" placeholder="https://...">
        </div>
      </div>
      <div class="grid-3">
        <div><label>Age</label><input type="text" id="c-age" placeholder="28"></div>
        <div><label>Height</label><input type="text" id="c-height" placeholder="5'11&quot;"></div>
        <div><label>Weight</label><input type="text" id="c-weight" placeholder="160 lbs"></div>
      </div>
      <div class="grid-3">
        <div><label>Eyes</label><input type="text" id="c-eyes" placeholder="Amber"></div>
        <div><label>Hair</label><input type="text" id="c-hair" placeholder="Black"></div>
        <div><label>Skin</label><input type="text" id="c-skin" placeholder="Olive"></div>
      </div>
      <div class="section-h">Multiclassing</div>
      <div id="mc-list"></div>
      <button class="btn btn-outline btn-sm" onclick="addMulticlass()">+ Add Multiclass</button>
      <div class="section-h" style="margin-top:16px">Build Summary</div>
      <div id="build-summary" class="muted" style="font-size:.88rem">Choose a race, class, background and level to see your build summary.</div>
    </div>

    <!-- ‚îÄ‚îÄ ABILITIES TAB ‚îÄ‚îÄ -->
    <div class="tab-panel" id="creator-abilities">
      <div class="section-h">Ability Score Method</div>
      <div style="margin-bottom:14px">
        <button class="method-btn active" onclick="setAbilityMethod('standard',this)">Standard Array</button>
        <button class="method-btn" onclick="setAbilityMethod('pointbuy',this)">Point Buy</button>
        <button class="method-btn" onclick="setAbilityMethod('roll',this)">Roll 4d6</button>
        <button class="method-btn" onclick="setAbilityMethod('manual',this)">Manual</button>
      </div>
      <div id="ability-method-info" class="muted" style="margin-bottom:10px;font-size:.85rem"></div>
      <div id="point-buy-remaining" style="display:none;margin-bottom:10px;font-family:'Cinzel',serif;color:var(--gold);font-size:.9rem"></div>
      <div class="grid-6" id="ability-grid"></div>
      <div class="section-h">Racial Ability Bonuses</div>
      <div id="racial-bonuses" class="muted">Select a race to see racial bonuses.</div>
      <div class="section-h">ASI / Feat Opportunities</div>
      <div id="asi-list" class="muted">Select a class and level to see ASI options.</div>
    </div>

    <!-- ‚îÄ‚îÄ COMBAT TAB ‚îÄ‚îÄ -->
    <div class="tab-panel" id="creator-combat">
      <div class="grid-4" style="margin-bottom:14px">
        <div class="cs">
          <div class="cs-lbl">Armor Class</div>
          <input type="number" id="c-ac" value="10" class="stat-input-sm" style="background:transparent;border:none;color:var(--parch);text-align:center;width:100%;font-size:1.5rem;font-family:'Cinzel',serif">
        </div>
        <div class="cs" style="cursor:pointer" onclick="rollInitiative()" title="Click to roll initiative!">
          <div class="cs-lbl">Initiative</div>
          <div class="cs-val" id="c-init-display">+0</div>
          <div style="font-size:.65rem;color:var(--gold2);margin-top:2px">Click to Roll</div>
        </div>
        <div class="cs">
          <div class="cs-lbl">Speed (ft)</div>
          <input type="number" id="c-speed" value="30" class="stat-input-sm" style="background:transparent;border:none;color:var(--parch);text-align:center;width:100%;font-size:1.5rem;font-family:'Cinzel',serif">
        </div>
        <div class="cs"><div class="cs-lbl">Prof Bonus</div><div class="cs-val" id="c-prof-display">+2</div></div>
      </div>
      <div class="grid-3" style="margin-bottom:6px">
        <div><label>Max HP</label><input type="number" id="c-maxhp" value="0" min="0" onchange="updateHP()"></div>
        <div><label>Current HP</label><input type="number" id="c-curhp" value="0" onchange="updateHP()"></div>
        <div><label>Temp HP</label><input type="number" id="c-temphp" value="0"></div>
      </div>
      <div style="margin-bottom:10px">
        <button class="btn btn-outline btn-sm" onclick="autoCalcHP()" title="Calculate average Max HP from class hit die + CON modifier √ó level">‚ö° Auto-Calculate Max HP</button>
        <span id="hp-calc-hint" class="muted" style="font-size:.8rem;margin-left:8px"></span>
      </div>
      <div class="hp-bar"><div class="hp-fill" id="hp-fill" style="width:100%"></div></div>
      <div class="grid-2" style="margin-top:14px">
        <div>
          <label>Hit Die Type</label>
          <select id="c-hitdie">
            <option value="6">d6</option><option value="8" selected>d8</option>
            <option value="10">d10</option><option value="12">d12</option>
          </select>
        </div>
        <div><label>Hit Dice Remaining</label><input type="number" id="c-hitdice-remain" value="1" min="0"></div>
      </div>
      <div style="display:flex;align-items:center;gap:10px;margin-top:10px;flex-wrap:wrap">
        <label style="margin:0;display:inline">Inspiration:</label>
        <div class="inspiration-pip" id="insp-pip" onclick="toggleInspiration()">‚òÖ</div>
        <label style="margin:0;display:inline">Exhaustion Level:</label>
        <select id="c-exhaustion" style="width:80px;margin:0">
          <option value="0">0</option><option value="1">1</option><option value="2">2</option>
          <option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option>
        </select>
      </div>
      <div class="section-h">Death Saving Throws</div>
      <div style="display:flex;gap:20px;flex-wrap:wrap">
        <div>
          <div style="font-family:'Cinzel',serif;font-size:.75rem;color:#55a055;margin-bottom:5px">Successes</div>
          <div style="display:flex;gap:5px" id="death-success"></div>
        </div>
        <div>
          <div style="font-family:'Cinzel',serif;font-size:.75rem;color:#e05555;margin-bottom:5px">Failures</div>
          <div style="display:flex;gap:5px" id="death-fail"></div>
        </div>
      </div>
      <div class="section-h">Attacks & Actions</div>
      <div id="attack-header" style="display:grid;grid-template-columns:2fr 1fr 1fr 1.5fr auto;gap:6px;padding:4px 0;margin-bottom:4px">
        <span style="font-family:'Cinzel',serif;font-size:.72rem;color:var(--gold2)">Name</span>
        <span style="font-family:'Cinzel',serif;font-size:.72rem;color:var(--gold2)">Bonus</span>
        <span style="font-family:'Cinzel',serif;font-size:.72rem;color:var(--gold2)">Damage</span>
        <span style="font-family:'Cinzel',serif;font-size:.72rem;color:var(--gold2)">Type</span>
        <span></span>
      </div>
      <div id="attack-list"></div>
      <button class="btn btn-outline btn-sm" style="margin-top:8px" onclick="addAttack()">+ Add Attack</button>
      <div class="section-h">Active Conditions</div>
      <div id="condition-tracker" style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:4px"></div>
      <div id="condition-detail" style="font-size:.82rem;color:var(--parch2);margin-bottom:8px;min-height:18px;font-style:italic"></div>
      <div class="section-h">Concentration</div>
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:10px">
        <input type="text" id="c-concentration" placeholder="Concentrating on... (spell name)" style="flex:1;margin:0">
        <button class="btn btn-outline btn-sm" onclick="document.getElementById('c-concentration').value=''">‚úï Drop</button>
      </div>
      <div class="section-h">Rest</div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn btn-outline btn-sm" onclick="shortRest()">Short Rest (recover hit dice)</button>
        <button class="btn btn-green btn-sm" onclick="longRest()">Long Rest (full recovery)</button>
      </div>
      <div id="rest-msg" class="muted" style="margin-top:6px;font-size:.85rem"></div>
    </div>

    <!-- ‚îÄ‚îÄ SKILLS TAB ‚îÄ‚îÄ -->
    <div class="tab-panel" id="creator-skills">
      <div class="grid-2">
        <div>
          <div class="section-h">Saving Throws</div>
          <div id="saving-throws-list"></div>
          <div class="section-h">Passive Scores</div>
          <div id="passive-scores" style="font-family:'Cinzel',serif;font-size:.85rem;color:var(--gold)"></div>
        </div>
        <div>
          <div class="section-h">Skills <span style="font-size:.7rem;color:var(--parch2);font-family:'Crimson Text',serif">(‚òë = proficient, ‚òë‚òë = expertise)</span></div>
          <div id="skills-list"></div>
        </div>
      </div>
      <div class="section-h">Languages</div>
      <textarea id="c-languages" placeholder="Common, Elvish, Dwarvish..." style="min-height:50px"></textarea>
      <div class="section-h">Tool & Weapon Proficiencies</div>
      <textarea id="c-profs" placeholder="Thieves' tools, longswords, martial weapons..." style="min-height:50px"></textarea>
      <div class="section-h">Armor Proficiencies</div>
      <div style="display:flex;flex-wrap:wrap;gap:6px">
        <label style="display:flex;align-items:center;gap:4px;cursor:pointer"><input type="checkbox" id="prof-light"  style="width:auto;margin:0"> Light</label>
        <label style="display:flex;align-items:center;gap:4px;cursor:pointer"><input type="checkbox" id="prof-medium" style="width:auto;margin:0"> Medium</label>
        <label style="display:flex;align-items:center;gap:4px;cursor:pointer"><input type="checkbox" id="prof-heavy"  style="width:auto;margin:0"> Heavy</label>
        <label style="display:flex;align-items:center;gap:4px;cursor:pointer"><input type="checkbox" id="prof-shield" style="width:auto;margin:0"> Shields</label>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ SPELLS TAB ‚îÄ‚îÄ -->
    <div class="tab-panel" id="creator-spells">
      <div class="grid-2" style="margin-bottom:14px">
        <div>
          <label>Spellcasting Ability</label>
          <select id="c-spell-ability" onchange="updateSpellStats()">
            <option value="">None</option>
            <option value="INT">Intelligence</option>
            <option value="WIS">Wisdom</option>
            <option value="CHA">Charisma</option>
          </select>
        </div>
        <div style="padding-top:24px;font-family:'Cinzel',serif;font-size:.85rem">
          <span class="muted">Spell Save DC: </span><span id="spell-dc" class="gold">‚Äî</span>&nbsp;&nbsp;
          <span class="muted">Attack Bonus: </span><span id="spell-atk" class="gold">‚Äî</span>
        </div>
      </div>
      <div class="section-h">Spell Slots</div>
      <div id="spell-slots-ui"></div>
      <div class="section-h">Add Spell</div>
      <div style="margin-bottom:8px">
        <button class="btn btn-outline btn-sm" onclick="openModal('spell-lookup-modal');filterSpellDB()">üìñ Browse Spell Database</button>
      </div>
      <div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:12px">
        <button class="btn btn-outline btn-sm" onclick="openAddSpell(0)">+ Cantrip</button>
        <button class="btn btn-outline btn-sm" onclick="openAddSpell(1)">+ 1st</button>
        <button class="btn btn-outline btn-sm" onclick="openAddSpell(2)">+ 2nd</button>
        <button class="btn btn-outline btn-sm" onclick="openAddSpell(3)">+ 3rd</button>
        <button class="btn btn-outline btn-sm" onclick="openAddSpell(4)">+ 4th</button>
        <button class="btn btn-outline btn-sm" onclick="openAddSpell(5)">+ 5th</button>
        <button class="btn btn-outline btn-sm" onclick="openAddSpell(6)">+ 6th</button>
        <button class="btn btn-outline btn-sm" onclick="openAddSpell(7)">+ 7th</button>
        <button class="btn btn-outline btn-sm" onclick="openAddSpell(8)">+ 8th</button>
        <button class="btn btn-outline btn-sm" onclick="openAddSpell(9)">+ 9th</button>
      </div>
      <div class="section-h">Spellbook / Known Spells</div>
      <div style="margin-bottom:8px">
        <input type="text" id="spell-search" placeholder="Search spells..." style="margin:0" oninput="renderSpellList()">
      </div>
      <div id="spell-list"></div>
    </div>

    <!-- ‚îÄ‚îÄ EQUIPMENT TAB ‚îÄ‚îÄ -->
    <div class="tab-panel" id="creator-equipment">
      <div class="grid-2" style="margin-bottom:14px">
        <div>
          <label>Copper (CP)</label><input type="number" id="c-cp" value="0" min="0" onchange="updateCurrency()">
          <label>Silver (SP)</label><input type="number" id="c-sp" value="0" min="0" onchange="updateCurrency()">
          <label>Electrum (EP)</label><input type="number" id="c-ep" value="0" min="0" onchange="updateCurrency()">
        </div>
        <div>
          <label>Gold (GP)</label><input type="number" id="c-gp" value="0" min="0" onchange="updateCurrency()">
          <label>Platinum (PP)</label><input type="number" id="c-pp" value="0" min="0" onchange="updateCurrency()">
          <div style="margin-top:10px;font-family:'Cinzel',serif;font-size:.82rem">
            <span class="muted">Total GP equiv: </span><span id="total-gp" class="gold">0</span><br>
            <span class="muted">Carry Capacity: </span><span id="carry-cap" class="gold">‚Äî</span><br>
            <span class="muted">Total Weight: </span><span id="total-weight" class="gold">0</span> lbs<br>
            <span id="encumbrance-status" style="font-style:italic;color:#55a055"></span>
          </div>
        </div>
      </div>
      <div style="margin-bottom:8px">
        <button class="btn btn-outline btn-sm" onclick="openModal('shop-modal');filterShop()">‚öî Browse Equipment Shop</button>
      </div>
      <div class="section-h">Inventory</div>
      <div id="equip-list"></div>
      <div class="input-row" style="margin-top:10px">
        <input type="text"   id="new-equip-name" placeholder="Item name...">
        <input type="number" id="new-equip-qty"  value="1" style="max-width:60px">
        <input type="number" id="new-equip-wt"   value="0" placeholder="lbs" style="max-width:60px">
        <input type="text"   id="new-equip-note" placeholder="Notes...">
        <button class="btn btn-gold btn-sm" onclick="addEquipItem()">Add</button>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ FEATURES TAB ‚îÄ‚îÄ -->
    <div class="tab-panel" id="creator-features">
      <div class="section-h">Class & Race Features</div>
      <div id="features-list"></div>
      <div class="section-h">Feats</div>
      <div id="feats-list"></div>
      <div class="input-row" style="margin-bottom:14px">
        <select id="feat-picker" style="flex:2" onchange="showFeatInfo()"><option value="">‚Äî Add a Feat ‚Äî</option></select>
        <button class="btn btn-gold btn-sm" onclick="addFeatFromList()">Add</button>
      </div>
      <div class="section-h">Custom Features</div>
      <div id="custom-features-list"></div>
      <div class="input-row" style="margin-top:8px">
        <input type="text" id="new-feat-name" placeholder="Feature name...">
        <textarea id="new-feat-desc" placeholder="Description..." style="min-height:38px;flex:2"></textarea>
        <button class="btn btn-gold btn-sm" onclick="addCustomFeature()">Add</button>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ PERSONALITY TAB ‚îÄ‚îÄ -->
    <div class="tab-panel" id="creator-personality">
      <div class="grid-2">
        <div>
          <label>Personality Traits</label>
          <textarea id="c-traits" placeholder="How does your character act?"></textarea>
          <label>Ideals</label>
          <textarea id="c-ideals" placeholder="What drives your character?"></textarea>
        </div>
        <div>
          <label>Bonds</label>
          <textarea id="c-bonds" placeholder="What ties does your character have?"></textarea>
          <label>Flaws</label>
          <textarea id="c-flaws" placeholder="What are your character's weaknesses?"></textarea>
        </div>
      </div>
      <label>Backstory</label>
      <textarea id="c-backstory" style="min-height:130px" placeholder="Tell your character's story..."></textarea>
      <label>Allies & Organizations</label>
      <textarea id="c-allies" placeholder="Friends, enemies, factions..."></textarea>
      <label>Additional Traits / Notes</label>
      <textarea id="c-extra-traits" placeholder="Other details..."></textarea>
    </div>

    <!-- ‚îÄ‚îÄ NOTES TAB ‚îÄ‚îÄ -->
    <div class="tab-panel" id="creator-notes">
      <label>Session Notes</label>
      <textarea id="c-notes" style="min-height:160px" placeholder="Notes from your sessions..."></textarea>
      <label>Quest Log</label>
      <textarea id="c-quests" style="min-height:100px" placeholder="Active quests, clues, goals..."></textarea>
      <label>Treasure & Loot</label>
      <textarea id="c-treasure" placeholder="Special items, art objects, gems..."></textarea>
    </div>

    <div style="margin-top:18px;display:flex;gap:8px;justify-content:flex-end;flex-wrap:wrap">
      <button class="btn btn-outline" onclick="closeModal('creator-modal')">Cancel</button>
      <button class="btn btn-gold" onclick="saveCharacter()">Save Character</button>
    </div>
  </div>
</div>

<!-- ============================================================
     ADD SPELL MODAL
============================================================ -->
<div class="modal-bg" id="spell-modal">
  <div class="modal" style="max-width:580px">
    <div class="modal-title">Add Spell</div>
    <button class="modal-close" onclick="closeModal('spell-modal')">‚úï</button>
    <div class="grid-2">
      <div>
        <label>Spell Name</label><input type="text" id="new-spell-name" placeholder="Fireball">
        <label>Level</label><input type="number" id="new-spell-level" value="0" min="0" max="9">
        <label>School</label>
        <select id="new-spell-school">
          <option>Abjuration</option><option>Conjuration</option><option>Divination</option>
          <option>Enchantment</option><option>Evocation</option><option>Illusion</option>
          <option>Necromancy</option><option>Transmutation</option>
        </select>
        <label>Casting Time</label><input type="text" id="new-spell-cast"  placeholder="1 action">
        <label>Range</label>       <input type="text" id="new-spell-range" placeholder="150 feet">
      </div>
      <div>
        <label>Components</label>      <input type="text" id="new-spell-comp" placeholder="V, S, M (...)">
        <label>Duration</label>        <input type="text" id="new-spell-dur"  placeholder="Instantaneous">
        <label>Damage / Effect</label> <input type="text" id="new-spell-dmg"  placeholder="8d6 fire">
        <label>Save</label>            <input type="text" id="new-spell-save" placeholder="DEX save">
        <label>Ritual?</label>
        <select id="new-spell-ritual"><option value="no">No</option><option value="yes">Yes</option></select>
        <label>Concentration?</label>
        <select id="new-spell-conc"><option value="no">No</option><option value="yes">Yes</option></select>
      </div>
    </div>
    <label>Description</label>
    <textarea id="new-spell-desc" style="min-height:70px" placeholder="Spell description..."></textarea>
    <div style="margin-top:14px;text-align:right">
      <button class="btn btn-gold" onclick="saveSpell()">Add Spell</button>
    </div>
  </div>
</div>

<!-- ============================================================
     CAMPAIGN MODAL
============================================================ -->
<div class="modal-bg" id="campaign-modal">
  <div class="modal" style="max-width:640px">
    <div class="modal-title" id="campaign-modal-title">New Campaign</div>
    <button class="modal-close" onclick="closeModal('campaign-modal')">‚úï</button>
    <div id="campaign-modal-body"></div>
  </div>
</div>

<script>
/* =============================================================================
   STATIC DATA ‚Äî ABILITIES & SKILLS
============================================================================= */
const ABILITIES      = ['STR','DEX','CON','INT','WIS','CHA'];
const ABILITY_NAMES  = {STR:'Strength',DEX:'Dexterity',CON:'Constitution',INT:'Intelligence',WIS:'Wisdom',CHA:'Charisma'};
const SKILLS_DATA    = [
  {name:'Acrobatics',     ab:'DEX'},{name:'Animal Handling',ab:'WIS'},{name:'Arcana',       ab:'INT'},
  {name:'Athletics',      ab:'STR'},{name:'Deception',      ab:'CHA'},{name:'History',      ab:'INT'},
  {name:'Insight',        ab:'WIS'},{name:'Intimidation',   ab:'CHA'},{name:'Investigation',ab:'INT'},
  {name:'Medicine',       ab:'WIS'},{name:'Nature',         ab:'INT'},{name:'Perception',   ab:'WIS'},
  {name:'Performance',    ab:'CHA'},{name:'Persuasion',     ab:'CHA'},{name:'Religion',     ab:'INT'},
  {name:'Sleight of Hand',ab:'DEX'},{name:'Stealth',        ab:'DEX'},{name:'Survival',     ab:'WIS'}
];

/* =============================================================================
   STATIC DATA ‚Äî CLASS DATA (hit die, saves, spell ability, ALL subclasses)
============================================================================= */
const CLASS_DATA = {
  Artificer: {
    hd:8, saves:['CON','INT'], spellAb:'INT', isHalf:true,
    subs:['Alchemist','Armorer','Artillerist','Battle Smith','Cartographer']
  },
  Barbarian: {
    hd:12, saves:['STR','CON'], spellAb:null,
    subs:['Path of the Berserker','Path of the Totem Warrior','Path of the Ancestral Guardian',
          'Path of the Battlerager','Path of the Storm Herald','Path of the Zealot',
          'Path of the Beast','Path of Wild Magic','Path of the Juggernaut','Path of the Dragon']
  },
  Bard: {
    hd:8, saves:['DEX','CHA'], spellAb:'CHA',
    subs:['College of Lore','College of Valor','College of Glamour','College of Swords',
          'College of Eloquence','College of Creation','College of Spirits','College of Whispers','College of Tragedy']
  },
  Cleric: {
    hd:8, saves:['WIS','CHA'], spellAb:'WIS',
    subs:['Life Domain','Light Domain','Trickery Domain','Knowledge Domain','War Domain',
          'Nature Domain','Tempest Domain','Death Domain','Forge Domain','Grave Domain',
          'Order Domain','Peace Domain','Twilight Domain','Arcana Domain']
  },
  Druid: {
    hd:8, saves:['INT','WIS'], spellAb:'WIS',
    subs:['Circle of the Land','Circle of the Moon','Circle of Dreams','Circle of the Shepherd',
          'Circle of Spores','Circle of Stars','Circle of Wildfire','Circle of the Primeval','Circle of the Blighted']
  },
  Fighter: {
    hd:10, saves:['STR','CON'], spellAb:null,
    subs:['Champion','Battle Master','Eldritch Knight','Arcane Archer','Cavalier','Samurai',
          'Psi Warrior','Rune Knight','Echo Knight','Purple Dragon Knight','Gunslinger']
  },
  Monk: {
    hd:8, saves:['STR','DEX'], spellAb:null,
    subs:['Way of the Open Hand','Way of Shadow','Way of the Four Elements','Way of the Sun Soul',
          'Way of the Kensei','Way of Mercy','Way of the Astral Self','Way of the Ascendant Dragon',
          'Way of the Drunken Master','Way of the Long Death','Way of the Cobalt Soul']
  },
  Paladin: {
    hd:10, saves:['WIS','CHA'], spellAb:'CHA', isHalf:true,
    subs:['Oath of Devotion','Oath of the Ancients','Oath of Vengeance','Oath of Conquest',
          'Oath of Redemption','Oath of Glory','Oath of the Watchers','Oathbreaker',
          'Oath of Heroism','Oath of the Crown','Oath of Treachery','Oath of the Dragon']
  },
  Ranger: {
    hd:10, saves:['STR','DEX'], spellAb:'WIS', isHalf:true,
    subs:['Hunter','Beast Master','Gloom Stalker','Horizon Walker','Monster Slayer',
          'Fey Wanderer','Swarmkeeper','Drakewarden','Monster Hunter']
  },
  Rogue: {
    hd:8, saves:['DEX','INT'], spellAb:null,
    subs:['Thief','Assassin','Arcane Trickster','Inquisitive','Mastermind','Scout',
          'Swashbuckler','Phantom','Soulknife','Revived','Investigator']
  },
  Sorcerer: {
    hd:6, saves:['CON','CHA'], spellAb:'CHA',
    subs:['Draconic Bloodline','Wild Magic','Shadow Magic','Storm Sorcery','Divine Soul',
          'Aberrant Mind','Clockwork Soul','Lunar Sorcery','Runechild']
  },
  Warlock: {
    hd:8, saves:['WIS','CHA'], spellAb:'CHA', isPact:true,
    subs:['The Archfey','The Fiend','The Great Old One','The Undying','The Celestial',
          'The Hexblade','The Fathomless','The Genie','The Undead','The Seeker']
  },
  Wizard: {
    hd:6, saves:['INT','WIS'], spellAb:'INT',
    subs:['School of Abjuration','School of Conjuration','School of Divination',
          'School of Enchantment','School of Evocation','School of Illusion',
          'School of Necromancy','School of Transmutation','Bladesinging',
          'War Magic','Chronurgy Magic','Graviturgy Magic','Order of Scribes',
          'School of Artifice','School of Psionics','Lore Mastery']
  }
};

/* =============================================================================
   STATIC DATA ‚Äî SUBCLASS DESCRIPTIONS & BACKGROUND AUTO-SKILLS
============================================================================= */
const SUBCLASS_INFO = {
  // Artificer
  'Alchemist':              'Alchemical Savant: bonus to healing/damage spells. Experimental Elixir: create potions each day (healing, swiftness, resilience, boldness, flight, transformation).',
  'Armorer':                'Armor Model: Thunder Gauntlets or Infiltrator Armor. Your armor becomes a spellcasting focus. Extra Attack built-in.',
  'Artillerist':            'Eldritch Cannon: create a Flamethrower, Force Ballista, or Protector turret. Arcane Firearm boosts cantrip damage.',
  'Battle Smith':           'Battle-Ready: INT for weapon attacks. Steel Defender: loyal mechanical pet that fights for you. Extra Attack at 5th.',
  // Barbarian
  'Path of the Berserker':  'Frenzy: bonus action unarmed strike while raging. Mindless Rage: immune to charm/fright while raging. Retaliation: reaction attack when hit.',
  'Path of the Totem Warrior':'Totem Spirit: Bear (resistance to all dmg), Eagle (no OA), Wolf (allies adv vs enemies near you). Totem bonuses scale.',
  'Path of the Ancestral Guardian':'Ancestors protect allies: your attacks can reduce enemy damage to others. Ancestral Protectors marks your first target.',
  'Path of the Battlerager': 'Spiked armor deals damage on grapple. Reckless Abandon adds temp HP on Reckless Attack. Requires Dwarf.',
  'Path of the Storm Herald': 'Aura of lightning, fire, or cold. Desert: fire damage; Sea: lightning; Tundra: temp HP to allies.',
  'Path of the Zealot':      'Divine Fury: extra radiant/necrotic damage. Warrior of the Gods: resurrection spells use no material components. Rage at death.',
  'Path of the Beast':       'Beast Aspect: claws, bite, or tail. Bestial Soul: swim/climb speed or jump. Call the Hunt: allies gain temp HP.',
  'Path of Wild Magic':      'Wild Surge: random magical effects when raging. Magic Awareness: detect spells. Unstable Backlash: redirect damage to Wild Surge.',
  // Bard
  'College of Lore':         'Bonus Proficiencies (3 skills). Cutting Words: reduce enemy attack/check with Bardic Inspiration. Magical Secrets (6th instead of 10th). Peerless Skill.',
  'College of Valor':        'Bonus Proficiencies: medium armor, shields, martial weapons. Combat Inspiration: Bardic die to damage/AC. Extra Attack at 6th.',
  'College of Glamour':      'Mantle of Inspiration: temp HP + free move to allies. Enthralling Performance: charm crowd. Mantle of Majesty: command as bonus action for 1 min.',
  'College of Swords':       'Bonus Proficiency: medium armor, scimitars. Blade Flourish: Defensive, Slashing, Mobile flourishes using Bardic die. Extra Attack.',
  'College of Eloquence':    'Silver Tongue: min 10 on Persuasion/Deception. Unsettling Words: reduce target save. Infectious Inspiration: refund Bardic die when it helps.',
  'College of Creation':     'Mote of Potential: extra effects when Bardic die used. Performance of Creation: create large nonmagical object. Animating Performance: animated objects.',
  'College of Spirits':      'Guiding Whispers: spare the dying cantrip. Spiritual Focus: bonus to spell damage. Tales from Beyond: d6 table random spirit powers.',
  'College of Whispers':     'Psychic Blades: extra psychic damage with Bardic die. Words of Terror: frighten targets. Mantle of Whispers: steal identity of slain humanoid.',
  // Cleric
  'Life Domain':             'Bonus: heavy armor. Disciple of Life: heals restore extra 2+spell level HP. Preserve Life: channel to spread HP among allies.',
  'Light Domain':            'Bonus: light cantrip. Warding Flare: impose disadvantage on attacker. Radiance of the Dawn: channel to deal radiant and dispel darkness.',
  'Trickery Domain':         'Blessing of the Trickster: adv Stealth. Invoke Duplicity: create illusion duplicate. Cloak of Shadows: become invisible.',
  'Knowledge Domain':        'Blessings of Knowledge: 2 languages, 2 skill proficiencies with expertise. Read Thoughts: channel to read minds. Visions of the Past.',
  'War Domain':              'Bonus: heavy armor, martial weapons. War Priest: weapon attack as bonus action. Guided Strike: channel for +10 to hit.',
  'Nature Domain':           'Bonus: heavy armor, 1 druid cantrip. Dampen Elements: reduce elemental damage to ally. Master of Nature: command charmed animals/plants.',
  'Tempest Domain':          'Bonus: heavy armor, martial weapons. Wrath of the Storm: reaction lightning/thunder. Destructive Wrath: maximize thunder/lightning damage.',
  'Death Domain':            'Bonus: martial weapons. Reaper: cantrips hit two targets. Touch of Death: add necrotic damage on kills. Inescapable Destruction: ignore necrotic resistance.',
  'Forge Domain':            'Bonus: heavy armor, smith tools. Artisan\'s Blessing: create metal items. Blessing of the Forge: give item +1 AC or +1 attack.',
  'Grave Domain':            'Circle of Mortality: maximize dice on 0 HP healing. Eyes of the Grave: sense undead. Sentinel at Death\'s Door: cancel crits. Keeper of Souls.',
  'Order Domain':            'Bonus: heavy armor. Voice of Authority: allies attack after you heal them. Order\'s Demand: channel to charm creatures.',
  'Peace Domain':            'Implement of Peace: proficiency in Insight/Performance/Persuasion. Emboldening Bond: bonded allies can add d4 to checks. Balm of Peace.',
  'Twilight Domain':         'Bonus: heavy armor, martial weapons. Eyes of Night: darkvision 300ft, share with allies. Twilight Sanctuary: aura of protection (temp HP or end charm/fear).',
  'Arcana Domain':           'Arcane Initiate: two wizard cantrips. Spell Breaker: dispel lower-level spells when healing. Arcane Mastery: add high-level wizard spells to list.',
  // Druid
  'Circle of the Land':      'Bonus Cantrip. Natural Recovery: recover spell slots on short rest. Land bonus spells by terrain type. Nature\'s Ward: immune charm/fright by fey/elementals.',
  'Circle of the Moon':      'Combat Wild Shape: wildshape as bonus action, expend slots for HP. Elemental Wild Shape: become air/earth/fire/water elemental. Enhanced wild shape CR.',
  'Circle of Dreams':        'Balm of the Summer Court: spend Wild Shape uses to heal. Hearth of Moonlight: protect rest location. Hidden Paths: teleport through trees.',
  'Circle of the Shepherd':  'Speech of the Woods: speak with beasts/plants. Spirit Totem: Hawk/Unicorn/Bear aura in wildshape. Faithful Summons on incapacitation.',
  'Circle of Spores':        'Halo of Spores: reaction necrotic damage. Symbiotic Entity: wildshape charges give temp HP and bonus damage. Spreading Spores. Fungal Infestation.',
  'Circle of Stars':         'Star Map: free Guidance cantrip, Guiding Bolt. Starry Form: Archer/Chalice/Dragon constellation bonuses. Full of Stars: translucence.',
  'Circle of Wildfire':      'Wildfire Spirit familiar for bonus summon damage. Enhanced Bond: teleport and boost spells via spirit. Cauterizing Flames: healing on death.',
  // Fighter
  'Champion':                'Improved Critical: crit on 19-20. Remarkable Athlete: half prof to unproficient STR/DEX/CON checks. Additional Fighting Style. Superior Critical (18-20).',
  'Battle Master':           'Combat Superiority: d8 maneuver dice (scale to d10/d12). Choose 3 maneuvers (trip, disarm, feint, riposte, etc.). Know Your Enemy.',
  'Eldritch Knight':         'Spellcasting (INT, abjuration/evocation focus). Weapon Bond: teleport bonded weapon. War Magic: attack after cantrip. Improved War Magic.',
  'Arcane Archer':           'Arcane Shot (2/rest): Banishing, Beguiling, Bursting, Enfeebling, Grasping, Piercing, Seeking, Shadow arrow effects.',
  'Cavalier':                'Bonus Proficiency. Born to the Saddle: mount advantages. Unwavering Mark: mark and punish enemies who attack others. Hold the Line.',
  'Samurai':                 'Bonus Proficiency. Fighting Spirit: temp HP + advantage on attacks 3/day. Elegant Courtier: WIS + CHA saves. Tireless Spirit. Strength Before Death.',
  'Psi Warrior':             'Psionic Power dice (d6‚Üíd12): Protective Field, Psionic Strike, Telekinetic Movement. Telekinetic Adept: flight + forceful step.',
  'Rune Knight':             'Rune Carving: Cloud/Fire/Frost/Stone/Storm runes with passive and triggered effects. Giant\'s Might: grow Large, bonus damage. Runic Shield. Great Stature.',
  'Echo Knight':             'Manifest Echo: create duplicate, swap positions, attack through it. Unleash Incarnation: extra attacks through echo. Echo Avatar: long-range scouting.',
  'Purple Dragon Knight':    'Rallying Cry: Second Wind heals allies. Royal Envoy: Persuasion expertise. Inspiring Surge: ally attacks on Action Surge. Bulwark: Indomitable for allies.',
  // Monk
  'Way of the Open Hand':    'Open Hand Technique: knock prone, push, deny reactions on Flurry hits. Wholeness of Body: self-heal 3√ó monk level 1/rest. Tranquility. Quivering Palm.',
  'Way of Shadow':           'Shadow Arts: darkness/darkvision/silence/pass without trace. Shadow Step: teleport between shadows. Cloak of Shadows (invisible in dim). Shadow Strike.',
  'Way of the Four Elements':'Elemental Disciplines: spend ki for elemental spells/effects (water whip, flame, earth, air). Ride the Wind, Flames of the Phoenix, etc.',
  'Way of the Sun Soul':     'Radiant Sun Bolt: ranged ki attack. Searing Arc Strike: burning hands with ki. Searing Sunburst: AoE radiant. Sun Shield: light + fire retaliation.',
  'Way of the Kensei':       'Kensei Weapons: chosen weapons become monk weapons. Agile Parry: +2 AC with kensei weapon. Deft Strike: +1d4 damage. Sharpen the Blade: magic bonus.',
  'Way of Mercy':            'Implements of Mercy: Insight/Medicine proficiency, healer kit. Hand of Healing: restore HP with Flurry. Hand of Harm: necrotic damage. Physician\'s Touch.',
  'Way of the Astral Self':  'Arms of the Astral Self: WIS for attacks, bonus action extra attacks. Visage of the Astral Self: darkvision, WIS for Intimidation. Body of the Astral Self.',
  'Way of the Ascendant Dragon':'Draconic Disciple: change damage to acid/cold/fire/lightning/poison, speak Draconic. Breath of the Dragon. Wings Unfurled: fly speed.',
  'Way of the Drunken Master':'Drunken Technique: Tumble + +10ft speed on Flurry. Tipsy Sway: redirect attacks. Drunkard\'s Luck: adv when both dice show same. Intoxicated Frenzy.',
  'Way of the Long Death':   'Touch of Death: gain temp HP equal to damage dealt to dying creatures. Hour of Reaping: frighten all nearby. Mastery of Death: avoid death with ki. Touch of the Long Death.',
  // Paladin
  'Oath of Devotion':        'Sacred Weapon: +CHA to attacks. Holy Nimbus: 30ft radiant aura harms fiends/undead. Oath spells: Protection from Evil, Aid, Beacon of Hope, Guardian of Faith.',
  'Oath of the Ancients':    'Nature\'s Wrath: restrain target. Turn the Faithless: repel fey/fiends. Elder Champion: regrow limbs, spells as bonus, nature attacks. Spells: Ensnaring Strike, Moonbeam, etc.',
  'Oath of Vengeance':       'Abjure Enemy: frighten one creature. Vow of Enmity: advantage vs target. Relentless Avenger: bonus speed on OA. Soul of Vengeance: bonus attack on Vow target.',
  'Oath of Conquest':        'Conquering Presence: frighten area. Guided Strike: +10 to hit. Aura of Conquest: frightened creatures speed 0, take psychic damage. Invincible Conqueror.',
  'Oath of Redemption':      'Emissary of Peace: +5 to Persuasion. Rebuke the Violent: punish attackers with their own damage. Aura of the Guardian: take ally\'s damage. Protective Spirit.',
  'Oath of Glory':           'Inspiring Smite: distribute temp HP on Divine Smite. Peerless Athlete: adv Athletics/Acrobatics. Aura of Alacrity: speed bonus to allies. Glorious Defense.',
  'Oath of the Watchers':    'Watcher\'s Will: CHA bonus to INT/WIS/CHA saves for allies. Abjure the Extraplanar: turn extraplanar creatures. Aura of the Sentinel: +PB to initiative. Mortal Bulwark.',
  'Oathbreaker':             'Dark Blessing: CHA to death saves. Control Undead. Aura of Hate: CHA to weapon damage + fiends/undead nearby also gain it. Supernatural Resistance. Dread Lord.',
  'Oath of Heroism':         'Peerless Athlete: adv Athletics/Acrobatics. Inspiring Smite: temp HP on smite. Aura of Alacrity: speed boost. Glorious Defense: deflect attacks with CHA.',
  'Oath of the Crown':       'Champion Challenge: pull enemies into duel. Turn the Tide: heal allies at 0 HP. Divine Allegiance: redirect ally damage to yourself. Unyielding Saint: STR/CON saves.',
  // Ranger
  'Hunter':                  'Hunter\'s Prey: Colossus Slayer / Giant Killer / Horde Breaker. Defensive Tactics: Escape the Horde / Multiattack Defense / Steel Will. Multiattack options.',
  'Beast Master':            'Ranger\'s Companion: bond with a beast. Exceptional Training: beast uses your bonus action, can take non-attack actions. Bestial Fury: beast makes 2 attacks.',
  'Gloom Stalker':           'Dread Ambusher: +1d8 on first turn attacks, +10ft speed on first turn. Umbral Sight: invisible in darkness. Iron Mind: WIS save prof. Stalker\'s Flurry.',
  'Horizon Walker':          'Detect Portal: sense planar portals. Planar Warrior: extra force damage. Ethereal Step: ethereal plane briefly. Distant Strike: teleport before attacking.',
  'Monster Slayer':          'Hunter\'s Sense: sense vulnerabilities/immunities. Slayer\'s Prey: bonus damage vs one target. Supernatural Defense: bonus to saves/grapple vs prey. Slayer\'s Counter.',
  'Fey Wanderer':            'Dreadful Strikes: psychic damage. Otherworldly Glamour: CHA bonus to checks, extra language. Beguiling Twist: redirect charm/fright. Fey Reinforcements.',
  'Swarmkeeper':             'Gathered Swarm: bonus attack move/damage. Writhing Tide: fly speed. Mighty Swarm: knock prone/restrain. Swarming Dispersal: escape with temp HP.',
  'Drakewarden':             'Drake Companion: bonded drake fights with you. Bond of Fang and Scale: share drake\'s resistances, ride it. Drake\'s Breath weapon. Perfected Bond: drake grows Large.',
  // Rogue
  'Thief':                   'Fast Hands: bonus action Sleight of Hand/thieves tools/object. Second-Story Work: climb speed, running jump bonus. Supreme Sneak: adv Stealth at half speed. Thief\'s Reflexes.',
  'Assassin':                'Bonus Proficiencies: disguise kit, poisoner\'s kit. Assassinate: adv vs creatures that haven\'t acted + auto-crit on surprised targets. Infiltration Expertise. Impostor.',
  'Arcane Trickster':        'Spellcasting (INT, enchantment/illusion focus). Mage Hand Legerdemain: bonus action hide/pickpocket with mage hand. Magical Ambush: adv on spells vs unaware targets.',
  'Inquisitive':             'Ear for Deceit: min 8 on Insight. Eye for Detail: bonus action Perception/Investigation. Insightful Fighting: Sneak Attack without ally using Insight vs Deception.',
  'Mastermind':              'Master of Intrigue: disguise/forgery kits, 2 languages. Master of Tactics: Help as bonus action from 30ft. Insightful Manipulator. Misdirection. Soul of Deceit.',
  'Scout':                   'Skirmisher: reaction to move half speed when enemy ends near you. Survivalist: Nature/Survival proficiency + expertise. Superior Mobility: +10 speed. Ambush Master.',
  'Swashbuckler':            'Fancy Footwork: no OA after attacking. Rakish Audacity: add CHA to initiative; Sneak Attack without ally if 1v1. Panache. Elegant Maneuver. Master Duelist.',
  'Phantom':                 'Whispers of the Dead: gain skill/tool prof from nearby dead. Wails from the Grave: extra Sneak Attack damage to second target. Tokens of the Departed. Ghost Walk.',
  'Soulknife':               'Psionic Power: Psionic Whispers, Psychic Blades (1d6 psychic finesse thrown), Psychic Veil: invisibility. Rend Mind: stun target on sneak attack.',
  // Sorcerer
  'Draconic Bloodline':      'Dragon Ancestor: choose dragon type for damage resistance and language. Draconic Resilience: +1 HP/level, AC 13+DEX without armor. Elemental Affinity: add CHA to damage. Dragon Wings.',
  'Wild Magic':              'Wild Magic Surge: 1-in-20 random effects after casting. Tides of Chaos: advantage 1/rest (recharges on surge). Bend Luck: spend 2 points to adjust any roll.',
  'Shadow Magic':            'Eyes of the Dark: darkness for 1 point. Strength of the Grave: CON save to stay at 1 HP 1/day. Hound of Ill Omen: summon shadowy hound. Shadow Walk.',
  'Storm Sorcery':           'Wind Speaker: Primordial language. Tempestuous Magic: 10ft fly as bonus after cantrip/spell. Heart of the Storm: resistance + area damage when casting lightning/thunder.',
  'Divine Soul':             'Divine Magic: access to cleric spell list. Favored by the Gods: +2d4 to saves/attacks 1/rest. Empowered Healing: reroll healing dice. Otherworldly Wings.',
  'Aberrant Mind':           'Telepathic Speech: communicate telepathically. Psionic Spells: bonus spells (detect thoughts, etc.). Revelation in Flesh: spend points for wings/swim/see invisible.',
  'Clockwork Soul':          'Clockwork Magic: bonus restoration/protection spells. Restore Balance: cancel adv/disadv. Bulwark of Law: absorb d8s = Sorcery points. Trance of Order.',
  'Lunar Sorcery':           'Moon Fire: sacred flame hits two. Lunar Embodiment: bonus spells per phase. Waxing/Full/Waning moon powers. Lunar Phenomenon: zone of power.',
  // Warlock
  'The Archfey':             'Fey Presence: charm or frighten nearby. Misty Escape: reaction to teleport and become invisible. Beguiling Defenses: immune to charm, reflect it. Dark Delirium.',
  'The Fiend':               'Dark One\'s Blessing: temp HP on kills (= CHA mod + level). Dark One\'s Own Luck: +1d10 to ability check/save 1/rest. Fiendish Resilience: damage resistance choice.',
  'The Great Old One':       'Awakened Mind: telepathy 30ft. Entropic Ward: impose disadv on attacker, gain adv next attack. Thought Shield: psychic resistance, reflect damage.',
  'The Undying':             'Among the Dead: Spare the Dying cantrip. Defy Death: regain HP on 0 HP 1/rest. Undying Nature: no aging, no food/water/air, advantage vs disease. Indestructible Life.',
  'The Celestial':           'Bonus Cantrips: Light, Sacred Flame. Healing Light: pool of d6s (= 1 + Warlock level) for bonus action healing. Radiant Soul: resistance + add CHA to radiant/fire spells.',
  'The Hexblade':            'Hexblade\'s Curse: mark target for bonus damage, crit range, HP on kill. Hex Warrior: medium armor/shields/martial weapons with CHA attacks. Accursed Specter.',
  'The Fathomless':          'Tentacle of the Deeps: summon 10ft tentacle that slows and damages. Gift of the Sea: swim speed, water breathing. Oceanic Soul: resistance to cold, speak with water creatures.',
  'The Genie':               'Genie\'s Vessel: enter tiny vessel for rest. Elemental Gift: resistance (by genie type) + fly speed. Sanctuary Vessel: invite allies. Limited Wish at 17th.',
  'The Undead':              'Form of Dread: frighten creatures, temp HP, death immunity briefly. Grave Touched: ignore resistance to necrotic. Necrotic Husk: necrotic resistance, explosion on death.',
  // Wizard
  'School of Abjuration':    'Abjuration Savant: half cost to copy abjuration spells. Arcane Ward: absorb damage with ward HP pool (2√ó INT mod + Wizard level). Projected Ward. Improved Abjuration.',
  'School of Conjuration':   'Conjuration Savant: half cost. Minor Conjuration: create small objects. Benign Transposition: teleport or swap with ally 1/rest. Focused Conjuration. Durable Summons.',
  'School of Divination':    'Divination Savant. Portent: roll 2d20 at dawn, replace any roll with these results. Expert Divination: recover lower spell slots when casting divination. Third Eye.',
  'School of Enchantment':   'Enchantment Savant. Hypnotic Gaze: charm one creature each short rest. Instinctive Charm: redirect attacks to nearby creatures. Split Enchantment: hit two with enchantments.',
  'School of Evocation':     'Evocation Savant. Sculpt Spells: protect allies from your AoE. Potent Cantrip: half damage on successful save. Empowered Evocation: add INT mod to evocation damage.',
  'School of Illusion':      'Illusion Savant. Improved Minor Illusion: add sound AND image. Malleable Illusions: move existing illusions. Illusory Self: reaction duplicate that absorbs hit. Illusory Reality.',
  'School of Necromancy':    'Necromancy Savant. Grim Harvest: regain HP when spells kill. Undead Thralls: animate dead creates extra zombies with better HP. Inured to Undeath. Command Undead.',
  'School of Transmutation': 'Transmutation Savant. Minor Alchemy: temporarily change material of object. Transmuter\'s Stone: grant darkvision/speed/resist/proficiency aura. Shapechanger. Master Transmuter.',
  'Bladesinging':            'Training in War and Song: light armor + performance proficiency. Bladesong: +INT to AC, +10 speed, advantage on DEX(Acrobatics), concentration saves. Extra Attack. Song of Defense.',
  'War Magic':               'Arcane Deflection: reaction +2 AC / +4 to save. Tactical Wit: add INT to initiative. Power Surge: extra force damage stored from counterspell/dispel.',
  'Chronurgy Magic':         'Chronal Shift: reroll d20 twice per long rest. Temporal Awareness: add INT to initiative. Momentary Stasis: incapacitate target. Convergent Future: guarantee results.',
  'Graviturgy Magic':        'Adjust Density: slow or speed creature. Gravity Well: move creature 5ft after spell. Violent Attraction: add d10 to damage or falling. Event Horizon: pull/slow all nearby.',
  'Order of Scribes':        'Awakened Spellbook: use book as focus, change damage type of spells. Manifest Mind: project spellcasting focus 300ft. Master Scrivener: create 1st/2nd level spell scrolls free.',
  'School of Artifice':      'Bonus tool proficiency. Arcane Armaments: attune to more items. Craft Magical Item: create magical items using spell slots. Artificer\'s Magic: INT for magic item saves.',
  // ‚îÄ‚îÄ HOMEBREW / POPULAR UNOFFICIAL ‚îÄ‚îÄ
  'Cartographer':            '(Homebrew) Map Mastery: advantage on Navigation checks. Territorial Awareness: bonus action to mark an area, granting allies +1 AC and saves while in it. At higher levels, create Cartographic Traps and Shortcut routes.',
  'Path of the Juggernaut':  '(Homebrew) Unstoppable: cannot be knocked prone while raging. Pulverizing Blow: knock enemies back 15ft on hit. Overwhelming Cleave: attack multiple creatures in a line. Juggernaut\'s Rush: charge through enemies.',
  'Path of the Dragon':      '(Homebrew) Draconic Rage: breath weapon during rage, choose damage type. Dragon Hide: natural AC. Frightful Presence: frighten enemies on rage entry. Wings at 14th level.',
  'College of Tragedy':      '(Homebrew) Poetry in Misery: regain Bardic Inspiration when ally fails a check. Sorrowful Fate: impose disadvantage on a death save. Tale of Hubris: exploit enemy crits. Inevitable Demise: escalating damage on cursed targets.',
  'Gunslinger':              '(Critical Role ‚Äî Matt Mercer) Firearm Proficiency. Trick Shots: Disarming, Forceful, Piercing, Winging shots using Grit points. Quickdraw: initiative and quick-draw checks. Lightning Reload. Vicious Intent. Hemorrhaging Critical.',
  'Way of the Cobalt Soul':  '(Critical Role ‚Äî Explorer\'s Guide) Extract Aspects: learn enemy resistances/immunities on hit. Extort Truth: force honesty. Mystical Erudition: bonus languages and INT skills. Mind of Mercury: extra reactions. Debilitating Barrage.',
  'Monster Hunter':          '(Matt Mercer homebrew) Monster\'s Bane: bonus damage vs monstrosities/undead. Supernatural Defense: bonus to saves vs monster abilities. Relentless: advantage on checks vs creatures you\'ve hit. Magic\'s Bane: resistance to spell damage.',
  'Runechild':               '(Tal\'Dorei Campaign Setting) Essence Runes charge up and power abilities. Glyph of Aegis: absorb damage. Sigilic Augmentation: temp ability bonuses. Runic Torrent: expel runes for area damage. Living Rune: transform into rune-empowered form.',
  'The Seeker':              '(UA) Shielding Aurora: resistance to radiant damage and aura of light. Astral Refuge: escape to astral plane briefly. Far Wanderer: fly speed. Astral Sequestration: banish a creature.',
  'Oath of Treachery':       '(UA) Invoke Duplicity-style abilities. Blackguard\'s Escape: disengage as bonus action. Aura of Treachery: enemies within 10ft have disadvantage on saves vs your allies. Blackguard\'s Smite.',
  'Oath of the Dragon':      '(Homebrew) Draconic Smite: smite deals chosen elemental damage. Wyrm\'s Aura: allies gain elemental resistance. Aspect of the Dragon: grow wings, use breath weapon. Dragonic Presence: frighten with your aura.',
  'Circle of the Primeval':  '(2022 UA) Keeper of Old: primal beast companion that grows with you. Prehistoric Conduit: boost companion\'s attacks. Titanic Bond: companion grows Large. Eldritch Wilds: companion becomes Huge.',
  'Circle of the Blighted':  '(Homebrew) Blighted Sapling: create a zone of necrotic terrain. Corrupted Wildshape: necrotic energy melds with beast form. Blight Spores: poison and slow enemies. Death Bloom: massive necrotic AoE.',
  'School of Psionics':      '(UA) Psionic Focus: bonus to one mental ability check type. Psionic Devotion: bonus cantrips powered by mind. Thought Form: shed body and become psionic entity. Mental Discipline: resistance to psychic damage.',
  'Lore Mastery':            '(UA) Lore Master: change damage type of spells. Spell Secrets: alter saving throw type. Alchemical Casting: spend spell slots to empower spells (widened area, longer duration, extra damage). Unerring Accuracy.',
  'Revived':                 '(Van Richten\'s Guide) Tokens of Past Lives: gain proficiency from past life each rest. Bolts from the Blue: reaction to avoid death, gain temp HP. Audience with Death: speak with dying creatures. Ethereal Jaunt: become incorporeal.',
  'Investigator':            '(Ravnica) Eye for Weakness: bonus sneak attack dice on first hit per turn vs unseen target. Probing Investigation: bonus action Insight check. Underworld Connections: gather information from criminal contacts. Versatile Crimestopper.',
};


/* =============================================================================
   STATIC DATA ‚Äî SUBRACE / VARIANT DATA (keyed by race name)
============================================================================= */
const SUBRACE_DATA = {
  'Human':                ['Standard Human (+1 all)', 'Variant Human (feat + 2 stats)', 'Mark of Finding', 'Mark of Handling', 'Mark of Making', 'Mark of Passage', 'Mark of Sentinel'],
  'Dragonborn':           ['Black (Acid)', 'Blue (Lightning)', 'Brass (Fire)', 'Bronze (Lightning)', 'Copper (Acid)', 'Gold (Fire)', 'Green (Poison)', 'Red (Fire)', 'Silver (Cold)', 'White (Cold)', 'Chromatic (Tasha\'s)', 'Metallic (Tasha\'s)', 'Gem (Tasha\'s)'],
  'Dwarf (Hill)':         ['Hill Dwarf (base)', 'Mark of Warding'],
  'Dwarf (Mountain)':     ['Mountain Dwarf (base)', 'Mark of Warding'],
  'Elf (High)':           ['High Elf (base)', 'Sun Elf', 'Moon Elf', 'Mark of Detection', 'Mark of Shadow'],
  'Elf (Wood)':           ['Wood Elf (base)', 'Wild Elf', 'Mark of the Wild'],
  'Elf (Drow)':           ['Drow (base)', 'Seldarine Drow', 'Lolth-Sworn Drow'],
  'Gnome (Forest)':       ['Forest Gnome (base)', 'Mark of Scribing'],
  'Gnome (Rock)':         ['Rock Gnome (base)', 'Deep Gnome (Svirfneblin)', 'Mark of Scribing'],
  'Half-Elf':             ['Standard Half-Elf', 'Aquatic Half-Elf (+swim)', 'Drow Half-Elf', 'Moon/Sun Elf Half-Elf', 'Wood Elf Half-Elf', 'Mark of Detection', 'Mark of Storm'],
  'Half-Orc':             ['Standard Half-Orc', 'Mark of Finding'],
  'Halfling (Lightfoot)': ['Lightfoot (base)', 'Mark of Healing', 'Mark of Hospitality'],
  'Halfling (Stout)':     ['Stout (base)', 'Ghostwise', 'Mark of Healing', 'Mark of Hospitality'],
  'Tiefling':             ['Asmodeus (base)', 'Baalzebul', 'Dispater', 'Fierna', 'Glasya', 'Levistus', 'Mammon', 'Mephistopheles', 'Zariel', 'Feral Tiefling', 'Devil\'s Tongue', 'Hellfire', 'Winged'],
  'Aasimar':              ['Protector Aasimar', 'Scourge Aasimar', 'Fallen Aasimar'],
  'Goliath':              ['Standard Goliath', 'Goliath of the Glacial Sea', 'Goliath of the Stone Fist'],
  'Tabaxi':               ['Standard Tabaxi', 'Tabaxi of the Distant Shore'],
  'Tortle':               ['Standard Tortle', 'Softshell Tortle'],
  'Warforged':            ['Envoy', 'Juggernaut', 'Skirmisher'],
  'Firbolg':              ['Standard Firbolg'],
  'Goblin':               ['Standard Goblin', 'Goblin of the Arid Highlands', 'Mark of Finding'],
  'Kenku':                ['Standard Kenku'],
  'Lizardfolk':           ['Standard Lizardfolk', 'Poison Dusk Lizardfolk'],
  'Triton':               ['Standard Triton'],
  'Bugbear':              ['Standard Bugbear'],
  'Hobgoblin':            ['Standard Hobgoblin', 'Hobgoblin of the Feywild'],
  'Kobold':               ['Standard Kobold'],
  'Orc':                  ['Standard Orc', 'Mark of Finding'],
  'Yuan-ti Pureblood':    ['Standard Yuan-ti', 'Yuan-ti Malison Type 1', 'Yuan-ti Malison Type 2', 'Yuan-ti Malison Type 3'],
  'Changeling':           ['Standard Changeling', 'Becoming Changeling', 'Patience Changeling'],
  'Kalashtar':            ['Standard Kalashtar'],
  'Shifter (Beasthide)':  ['Beasthide Shifter'],
  'Shifter (Longtooth)':  ['Longtooth Shifter'],
  'Shifter (Swiftstride)':['Swiftstride Shifter'],
  'Shifter (Wildhunt)':   ['Wildhunt Shifter'],
  'Air Genasi':           ['Standard Air Genasi'],
  'Earth Genasi':         ['Standard Earth Genasi'],
  'Fire Genasi':          ['Standard Fire Genasi'],
  'Water Genasi':         ['Standard Water Genasi'],
  'Leonin':               ['Standard Leonin'],
  'Satyr':                ['Standard Satyr'],
  'Simic Hybrid':         ['Gills + Amphibious', 'Nimble Climber', 'Underwater Adaptation', 'Grappling Appendages', 'Carapace', 'Acid Spit'],
  'Minotaur':             ['Standard Minotaur', 'Minotaur of Ravnica'],
  'Loxodon':              ['Standard Loxodon'],
  'Aarakocra':            ['Standard Aarakocra'],
  'Vedalken':             ['Standard Vedalken'],
  'Locathah':             ['Standard Locathah'],
  'Verdan':               ['Standard Verdan'],
  'Centaur':             ['Standard Centaur', 'Centaur of Ravnica', 'Centaur of Theros'],
  'Fairy':               ['Standard Fairy'],
  'Harengon':            ['Standard Harengon'],
  'Owlfolk':             ['Standard Owlfolk', 'Snowy Owlfolk', 'Masked Owlfolk', 'Barred Owlfolk'],
  'Rabbitfolk':          ['Standard Rabbitfolk'],
};

// Background skill proficiency auto-apply map
const BG_SKILLS = {
  Acolyte:                ['Insight','Religion'],
  Charlatan:              ['Deception','Sleight of Hand'],
  Criminal:               ['Deception','Stealth'],
  Entertainer:            ['Acrobatics','Performance'],
  'Folk Hero':            ['Animal Handling','Survival'],
  'Guild Artisan':        ['Insight','Persuasion'],
  Hermit:                 ['Medicine','Religion'],
  Knight:                 ['History','Persuasion'],
  Noble:                  ['History','Persuasion'],
  Outlander:              ['Athletics','Survival'],
  Sage:                   ['Arcana','History'],
  Sailor:                 ['Athletics','Perception'],
  Soldier:                ['Athletics','Intimidation'],
  Urchin:                 ['Sleight of Hand','Stealth'],
  Pirate:                 ['Athletics','Perception'],
  Spy:                    ['Deception','Stealth'],
  Gladiator:              ['Acrobatics','Performance'],
  'Haunted One':          ['Arcana','Survival'],
  'Far Traveler':         ['Insight','Perception'],
  Inheritor:              ['Survival'],
  'Urban Bounty Hunter':  ['Deception','Stealth'],
  'Mercenary Veteran':    ['Athletics','Persuasion'],
  'City Watch':           ['Athletics','Insight'],
  'Clan Crafter':         ['History','Insight'],
  Courtier:               ['Insight','Persuasion'],
  'Faction Agent':        ['Insight'],
  'Gate Warden':          ['Athletics','Survival'],
};

// Class armor proficiency auto-apply
const CLASS_ARMOR_PROFS = {
  Artificer:  {light:true, medium:true, heavy:false, shield:true},
  Barbarian:  {light:true, medium:true, heavy:false, shield:true},
  Bard:       {light:true, medium:false,heavy:false, shield:false},
  Cleric:     {light:true, medium:true, heavy:false, shield:true},
  Druid:      {light:true, medium:true, heavy:false, shield:true},
  Fighter:    {light:true, medium:true, heavy:true,  shield:true},
  Monk:       {light:false,medium:false,heavy:false, shield:false},
  Paladin:    {light:true, medium:true, heavy:true,  shield:true},
  Ranger:     {light:true, medium:true, heavy:false, shield:true},
  Rogue:      {light:true, medium:false,heavy:false, shield:false},
  Sorcerer:   {light:false,medium:false,heavy:false, shield:false},
  Warlock:    {light:true, medium:false,heavy:false, shield:false},
  Wizard:     {light:false,medium:false,heavy:false, shield:false},
};

/* =============================================================================
   STATIC DATA ‚Äî RACES, BACKGROUNDS, LEVEL TABLES
============================================================================= */
const RACE_DATA = {
  'Human':               {bonuses:{STR:1,DEX:1,CON:1,INT:1,WIS:1,CHA:1},speed:30,info:'+1 all stats. Extra language & skill.'},
  'Human (Variant)':     {bonuses:{},speed:30,info:'+1 to two stats of choice, one feat, one extra skill proficiency.'},
  'Dragonborn':          {bonuses:{STR:2,CHA:1},speed:30,info:'+2 STR +1 CHA. Breath weapon & damage resistance by dragon type.'},
  'Dwarf (Hill)':        {bonuses:{CON:2,WIS:1},speed:25,info:'+2 CON +1 WIS. +1 HP/level. Poison resistance. Darkvision.'},
  'Dwarf (Mountain)':    {bonuses:{CON:2,STR:2},speed:25,info:'+2 CON +2 STR. Medium & light armor proficiency. Darkvision.'},
  'Elf (High)':          {bonuses:{DEX:2,INT:1},speed:30,info:'+2 DEX +1 INT. One wizard cantrip. Perception proficiency. Trance. Darkvision 60ft.'},
  'Elf (Wood)':          {bonuses:{DEX:2,WIS:1},speed:35,info:'+2 DEX +1 WIS. Speed 35. Mask of the Wild. Darkvision 60ft.'},
  'Elf (Drow)':          {bonuses:{DEX:2,CHA:1},speed:30,info:'+2 DEX +1 CHA. Superior Darkvision 120ft. Sunlight sensitivity. Innate spells.'},
  'Gnome (Forest)':      {bonuses:{INT:2,DEX:1},speed:25,info:'+2 INT +1 DEX. Minor Illusion cantrip. Speak with small beasts. Darkvision.'},
  'Gnome (Rock)':        {bonuses:{INT:2,CON:1},speed:25,info:'+2 INT +1 CON. Tinker clockwork devices. Darkvision.'},
  'Half-Elf':            {bonuses:{CHA:2},speed:30,info:'+2 CHA +1 to two others. Two extra skill proficiencies. Darkvision 60ft.'},
  'Half-Orc':            {bonuses:{STR:2,CON:1},speed:30,info:'+2 STR +1 CON. Relentless Endurance. Savage Attacks. Intimidation. Darkvision 60ft.'},
  'Halfling (Lightfoot)':{bonuses:{DEX:2,CHA:1},speed:25,info:'+2 DEX +1 CHA. Lucky (reroll 1s). Naturally Stealthy.'},
  'Halfling (Stout)':    {bonuses:{DEX:2,CON:1},speed:25,info:'+2 DEX +1 CON. Poison resistance. Stout Resilience.'},
  'Tiefling':            {bonuses:{INT:1,CHA:2},speed:30,info:'+1 INT +2 CHA. Fire resistance. Infernal Legacy (Thaumaturgy, Hellish Rebuke, Darkness).'},
  'Aasimar':             {bonuses:{CHA:2},speed:30,info:'+2 CHA. Necrotic & radiant resistance. Healing Hands. Light cantrip.'},
  'Goliath':             {bonuses:{STR:2,CON:1},speed:30,info:"+2 STR +1 CON. Stone's Endurance (reduce dmg 1/rest). Athletics. Powerful Build."},
  'Tabaxi':              {bonuses:{DEX:2,CHA:1},speed:30,info:'+2 DEX +1 CHA. Feline Agility (double speed burst). Claws 1d4. Climb 20. Darkvision.'},
  'Tortle':              {bonuses:{STR:2,WIS:1},speed:30,info:'+2 STR +1 WIS. Natural AC 17. Shell Defense. Survival proficiency.'},
  'Warforged':           {bonuses:{CON:2},speed:30,info:'+2 CON +1 any. Integrated Protection. Immune to disease/poison/sleep magic.'},
  'Firbolg':             {bonuses:{WIS:2,STR:1},speed:30,info:'+2 WIS +1 STR. Detect Magic, Disguise Self 1/rest. Speak with Beasts/Plants.'},
  'Goblin':              {bonuses:{DEX:2,CON:1},speed:30,info:'+2 DEX +1 CON. Nimble Escape (disengage/hide as bonus action). Fury of the Small. Darkvision.'},
  'Kenku':               {bonuses:{DEX:2,WIS:1},speed:30,info:'+2 DEX +1 WIS. Expert Forgery. Mimicry. Two skill proficiencies.'},
  'Lizardfolk':          {bonuses:{CON:2,WIS:1},speed:30,info:'+2 CON +1 WIS. Natural Armor (13+DEX). Bite attack. Hold Breath. Swim 30.'},
  'Triton':              {bonuses:{STR:1,CON:1,CHA:1},speed:30,info:'+1 STR/CON/CHA. Swim 30ft. Breathe water. Amphibious. Innate spells.'},
  'Air Genasi':          {bonuses:{CON:2,DEX:1},speed:35,info:'+2 CON +1 DEX. Unending Breath. Mingle with the Wind (Levitate).'},
  'Earth Genasi':        {bonuses:{CON:2,STR:1},speed:30,info:'+2 CON +1 STR. Earth Walk. Merge with Stone (Pass without Trace).'},
  'Fire Genasi':         {bonuses:{CON:2,INT:1},speed:30,info:'+2 CON +1 INT. Darkvision. Fire Resistance. Reach to the Blaze (cantrips).'},
  'Water Genasi':        {bonuses:{CON:2,WIS:1},speed:30,info:'+2 CON +1 WIS. Acid resistance. Amphibious. Call to the Wave (spells).'},
  'Bugbear':             {bonuses:{STR:2,DEX:1},speed:30,info:'+2 STR +1 DEX. Surprise Attack. Long-Limbed (5ft extra reach). Stealth proficiency.'},
  'Hobgoblin':           {bonuses:{CON:2,INT:1},speed:30,info:'+2 CON +1 INT. Martial Training (2 weapons, 1 armor). Saving Face (bonus to rolls near allies).'},
  'Kobold':              {bonuses:{DEX:2},speed:30,info:'+2 DEX. Pack Tactics (adv when ally adjacent). Sunlight Sensitivity. Darkvision 60ft.'},
  'Orc':                 {bonuses:{STR:2,CON:1},speed:30,info:'+2 STR +1 CON. Aggressive (bonus move toward enemy). Menacing. Darkvision.'},
  'Yuan-ti Pureblood':   {bonuses:{INT:1,CHA:2},speed:30,info:'+1 INT +2 CHA. Magic Resistance (adv vs spells). Innate spellcasting. Poison immunity.'},
  'Changeling':          {bonuses:{CHA:2},speed:30,info:'+2 CHA +1 to one other. Shapechanger (alter appearance at will). Extra language/skill.'},
  'Kalashtar':           {bonuses:{WIS:2,CHA:1},speed:30,info:'+2 WIS +1 CHA. Dual Mind (adv WIS saves). Psychic abilities. Telepathy.'},
  'Shifter (Beasthide)': {bonuses:{CON:2,STR:1},speed:30,info:'+2 CON +1 STR. Shifting: +1d6 HP, +1 AC. Darkvision 60ft.'},
  'Shifter (Longtooth)': {bonuses:{STR:2,DEX:1},speed:30,info:'+2 STR +1 DEX. Shifting: fangs attack, bonus attack. Darkvision 60ft.'},
  'Shifter (Swiftstride)':{bonuses:{DEX:2,CHA:1},speed:35,info:'+2 DEX +1 CHA. Speed 35. Shifting: speed +10, move without OA. Darkvision.'},
  'Shifter (Wildhunt)':  {bonuses:{WIS:2,DEX:1},speed:30,info:'+2 WIS +1 DEX. Shifting: advantage on all checks vs creatures. Darkvision.'},
  'Leonin':              {bonuses:{CON:2,STR:1},speed:35,info:'+2 CON +1 STR. Speed 35. Claws attack. Daunting Roar (frighten nearby creatures).'},
  'Satyr':               {bonuses:{CHA:2,DEX:1},speed:35,info:'+2 CHA +1 DEX. Speed 35. Magic Resistance. Ram attack. Proficiency in Performance/Persuasion.'},
  'Simic Hybrid':        {bonuses:{CON:2},speed:30,info:'+2 CON +1 any. Two Animal Enhancements of your choice (manta glide, nimble climber, grappling appendages, etc.).'},
  'Minotaur':            {bonuses:{STR:2,CON:1},speed:30,info:'+2 STR +1 CON. Goring Rush (bonus gore attack after Dash). Hammering Horns (shove as bonus). Imposing Presence.'},
  'Loxodon':             {bonuses:{CON:2,WIS:1},speed:30,info:'+2 CON +1 WIS. Trunk (smell, grapple, manipulate). Natural Armor. Powerful Build. Keen Smell.'},
  // Elemental Evil / Locathah Rising / Other
  'Aarakocra':           {bonuses:{DEX:2,WIS:1},speed:25,info:'+2 DEX +1 WIS. Fly speed 50ft. Talons 1d4 slashing. Cannot wear heavy armor while flying.'},
  'Vedalken':            {bonuses:{INT:2,WIS:1},speed:30,info:'+2 INT +1 WIS. Partially Amphibious (hold breath 1hr). Vedalken Dispassion (adv WIS saves). Tireless Precision (expertise in one tool/skill).'},
  'Locathah':            {bonuses:{STR:2,DEX:1},speed:30,info:'+2 STR +1 DEX. Swim 30ft. Natural Armor (13+DEX). Leviathan Will (adv vs charm/fear/paralysis/poison/stun/sleep).'},
  'Verdan':              {bonuses:{CON:1,CHA:2},speed:35,info:'+1 CON +2 CHA. Speed 35. Black Blood Healing (adv vs disease/poison). Telepathic Insight (adv WIS saves). Persuasive (+1d4 Persuasion).'},
  // Homebrew / Setting-Specific / Tasha's newer races
  'Centaur':             {bonuses:{STR:2,WIS:1},speed:40,info:'+2 STR +1 WIS. Speed 40 (hooves). Charge: bonus action gore attack after Dash. Hooves: 1d6 bludgeoning. Equine Build: counts as Large for carry. Natural Affinity: Proficiency in Nature or Survival.'},
  'Fairy':               {bonuses:{},speed:30,info:'+1 to two stats of choice. Fly speed 30ft. Fairy Magic: Druidcraft, Faerie Fire, Enlarge/Reduce 1/day. Small size.'},
  'Harengon':            {bonuses:{},speed:30,info:'+1 to two stats. Hare-Trigger: add PB to initiative. Leporine Senses: Perception proficiency. Lucky Footwork: reaction to negate failure on DEX save. Rabbit Hop: jump PB √ó 5ft as bonus action.'},
  'Owlfolk':             {bonuses:{},speed:30,info:'+1 to two stats. Fly speed 30ft (no heavy armor). Darkvision 120ft. Silent Feathers: proficiency in Stealth. Keen Senses: proficiency in Perception. Maneuverability: no disadvantage in tight spaces while flying.'},
  'Rabbitfolk':          {bonuses:{},speed:35,info:'+1 to two stats. Speed 35. Lucky Footwork (reaction to negate DEX save fail). Leporine Senses (Perception prof). Rabbit Hop (jump bonus action PB √ó 5ft/day).'},
};

const BG_DATA = {
  Acolyte:               {skills:'Insight, Religion',      feature:'Shelter of the Faithful'},
  Charlatan:             {skills:'Deception, Sleight of Hand',feature:'False Identity'},
  Criminal:              {skills:'Deception, Stealth',       feature:'Criminal Contact'},
  Entertainer:           {skills:'Acrobatics, Performance',  feature:'By Popular Demand'},
  'Folk Hero':           {skills:'Animal Handling, Survival',feature:'Rustic Hospitality'},
  'Guild Artisan':       {skills:'Insight, Persuasion',      feature:'Guild Membership'},
  Hermit:                {skills:'Medicine, Religion',        feature:'Discovery'},
  Knight:                {skills:'History, Persuasion',       feature:'Retainers'},
  Noble:                 {skills:'History, Persuasion',       feature:'Position of Privilege'},
  Outlander:             {skills:'Athletics, Survival',       feature:'Wanderer'},
  Sage:                  {skills:'Arcana, History',           feature:'Researcher'},
  Sailor:                {skills:'Athletics, Perception',     feature:"Ship's Passage"},
  Soldier:               {skills:'Athletics, Intimidation',   feature:'Military Rank'},
  Urchin:                {skills:'Sleight of Hand, Stealth',  feature:'City Secrets'},
  Pirate:                {skills:'Athletics, Perception',     feature:'Bad Reputation'},
  Spy:                   {skills:'Deception, Stealth',        feature:'Criminal Contact'},
  Gladiator:             {skills:'Acrobatics, Performance',   feature:'By Popular Demand'},
  'Haunted One':         {skills:'Arcana or Survival',        feature:'Heart of Darkness'},
  'Far Traveler':        {skills:'Insight, Perception',       feature:'All Eyes on You'},
  Inheritor:             {skills:'Survival + one of choice',  feature:'Inheritance'},
  'Urban Bounty Hunter': {skills:'Two from Deception/Insight/Persuasion/Stealth',feature:'Ear to the Ground'},
  'Mercenary Veteran':   {skills:'Athletics, Persuasion',     feature:'Mercenary Life'},
  'City Watch':          {skills:'Athletics, Insight',        feature:'Watcher\'s Eye'},
  'Clan Crafter':        {skills:'History, Insight',          feature:'Respect of the Stout Folk'},
  Courtier:              {skills:'Insight, Persuasion',       feature:'Court Functionary'},
  'Faction Agent':       {skills:'Insight + one faction skill',feature:'Safe Haven'},
  'Gate Warden':         {skills:'Athletics, Survival',       feature:'Planar Experience'},
};

const PROF_BONUS  = [0,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,6,6,6,6];
const STANDARD_ARRAY = [15,14,13,12,10,8];
const PB_COSTS    = {8:0,9:1,10:2,11:3,12:4,13:5,14:7,15:9};

const SPELL_SLOTS = {
  1:[2], 2:[3], 3:[4,2], 4:[4,3], 5:[4,3,2], 6:[4,3,3], 7:[4,3,3,1],
  8:[4,3,3,2], 9:[4,3,3,3,1], 10:[4,3,3,3,2], 11:[4,3,3,3,2,1],
  12:[4,3,3,3,2,1], 13:[4,3,3,3,2,1,1], 14:[4,3,3,3,2,1,1],
  15:[4,3,3,3,2,1,1,1], 16:[4,3,3,3,2,1,1,1], 17:[4,3,3,3,2,1,1,1,1],
  18:[4,3,3,3,3,1,1,1,1], 19:[4,3,3,3,3,2,1,1,1], 20:[4,3,3,3,3,2,2,1,1]
};
const WARLOCK_SLOTS      = {1:[1],2:[2],3:[2],4:[2],5:[2],6:[2],7:[2],8:[2],9:[2],10:[2],11:[3],12:[3],13:[3],14:[3],15:[3],16:[3],17:[4],18:[4],19:[4],20:[4]};
const WARLOCK_SLOT_LEVEL = {1:1,2:1,3:2,4:2,5:3,6:3,7:4,8:4,9:5,10:5,11:5,12:5,13:5,14:5,15:5,16:5,17:5,18:5,19:5,20:5};

const ASI_LEVELS = {
  Artificer:[4,8,12,16,19], Barbarian:[4,8,12,16,19], Bard:[4,8,12,16,19],
  Cleric:[4,8,12,16,19],    Druid:[4,8,12,16,19],     Fighter:[4,6,8,12,14,16,19],
  Monk:[4,8,12,16,19],      Paladin:[4,8,12,16,19],   Ranger:[4,8,12,16,19],
  Rogue:[4,8,10,12,16,18,19],Sorcerer:[4,8,12,16,19], Warlock:[4,8,12,16,19],
  Wizard:[4,8,12,16,19]
};

/* =============================================================================
   STATIC DATA ‚Äî CLASS FEATURES BY LEVEL
============================================================================= */
const CLASS_FEATURES = {
  Barbarian: {
    1:['Rage (2/rest, +2 dmg, resist B/P/S)','Unarmored Defense (AC=10+DEX+CON)'],
    2:['Reckless Attack','Danger Sense (adv DEX saves vs visible effects)'],
    3:['Primal Path (subclass)'],
    4:['ASI'],
    5:['Extra Attack','Fast Movement (+10 speed while not wearing heavy armor)'],
    6:['Path Feature'],
    7:['Feral Instinct (adv initiative; act even when surprised if you rage)'],
    8:['ASI'],
    9:['Brutal Critical (1 extra die on crit)'],
    10:['Path Feature'],
    11:['Relentless Rage (DC 10+ CON save to stay at 1 HP when dropped)'],
    12:['ASI'],
    13:['Brutal Critical (2 extra dice on crit)'],
    14:['Path Feature'],
    15:['Persistent Rage (rage ends only if knocked unconscious or you choose)'],
    16:['ASI'],
    17:['Brutal Critical (3 extra dice on crit)'],
    18:['Indomitable Might (STR checks minimum = STR score)'],
    19:['ASI'],
    20:['Primal Champion (+4 STR, +4 CON, unlimited rage)']
  },
  Fighter: {
    1:['Fighting Style','Second Wind (1d10+level HP, bonus action, 1/rest)'],
    2:['Action Surge (1/rest, take another action)'],
    3:['Martial Archetype (subclass)'],
    4:['ASI'],
    5:['Extra Attack (attack twice)'],
    6:['ASI'],
    7:['Archetype Feature'],
    8:['ASI'],
    9:['Indomitable (reroll a failed save, 1/long rest)'],
    10:['Archetype Feature'],
    11:['Extra Attack (attack three times)'],
    12:['ASI'],
    13:['Indomitable (2/long rest)'],
    14:['ASI'],
    15:['Archetype Feature'],
    16:['ASI'],
    17:['Action Surge (2/rest)','Indomitable (3/long rest)'],
    18:['Archetype Feature'],
    19:['ASI'],
    20:['Extra Attack (attack four times)']
  },
  Rogue: {
    1:['Expertise (double proficiency on 2 skills)','Sneak Attack 1d6','Thieves\' Cant'],
    2:['Cunning Action (Dash/Disengage/Hide as bonus action)'],
    3:['Roguish Archetype (subclass)','Sneak Attack 2d6'],
    4:['ASI'],
    5:['Uncanny Dodge (reaction: half damage from attack)','Sneak Attack 3d6'],
    6:['Expertise (2 more skills doubled)'],
    7:['Evasion (DEX save: no damage on success, half on fail)','Sneak Attack 4d6'],
    8:['ASI'],
    9:['Archetype Feature','Sneak Attack 5d6'],
    10:['ASI'],
    11:['Reliable Talent (min 10 on proficient checks)','Sneak Attack 6d6'],
    12:['ASI'],
    13:['Archetype Feature','Sneak Attack 7d6'],
    14:['Blindsense 10ft'],
    15:['Slippery Mind (gain WIS save proficiency)','Sneak Attack 8d6'],
    16:['ASI'],
    17:['Archetype Feature','Sneak Attack 9d6'],
    18:['Elusive (no advantage on attacks vs you while not incapacitated)'],
    19:['ASI','Sneak Attack 10d6'],
    20:['Stroke of Luck (1/rest: turn miss to hit, or failed check to 20)']
  },
  Wizard: {
    1:['Spellcasting','Arcane Recovery (recover slots on short rest = ¬Ω level)'],
    2:['Arcane Tradition (subclass)'],
    3:['Tradition Feature'],
    4:['ASI'],
    6:['Tradition Feature'],
    8:['ASI'],
    10:['Tradition Feature'],
    12:['ASI'],
    14:['Tradition Feature'],
    16:['ASI'],
    18:['Spell Mastery (cast 1st/2nd level spell without slot)'],
    19:['ASI'],
    20:['Signature Spells (2 free 3rd level spells per day, always prepared)']
  },
  Cleric: {
    1:['Spellcasting','Divine Domain (subclass)','Domain Spells'],
    2:['Channel Divinity (1/rest)','Domain Feature'],
    3:['Domain Feature'],
    4:['ASI'],
    5:['Destroy Undead (CR 1/2)'],
    6:['Channel Divinity (2/rest)','Domain Feature'],
    7:['Domain Feature'],
    8:['ASI','Domain Feature','Destroy Undead CR 1'],
    10:['Divine Intervention (10% chance; scales with level)'],
    11:['Destroy Undead CR 2'],
    12:['ASI'],
    14:['Destroy Undead CR 3'],
    16:['ASI'],
    17:['Destroy Undead CR 4'],
    18:['Channel Divinity (3/rest)'],
    19:['ASI'],
    20:['Divine Intervention (automatic success)']
  },
  Paladin: {
    1:['Divine Sense','Lay on Hands (5√ólevel HP pool)'],
    2:['Fighting Style','Spellcasting','Divine Smite'],
    3:['Divine Health (immune disease)','Sacred Oath (subclass)','Channel Divinity'],
    4:['ASI'],
    5:['Extra Attack'],
    6:['Aura of Protection (CHA mod to all saves, 10ft radius)'],
    7:['Oath Feature'],
    8:['ASI'],
    10:['Aura of Courage (immune fear, 10ft radius)'],
    11:['Improved Divine Smite (+1d8 radiant on all weapon attacks)'],
    12:['ASI'],
    14:['Cleansing Touch (end spells on yourself/willing creature, CHA mod/day)'],
    15:['Oath Feature'],
    16:['ASI'],
    18:['Aura Improvements (both auras extend to 30ft)'],
    19:['ASI'],
    20:['Sacred Oath Capstone']
  },
  Bard: {
    1:['Spellcasting','Bardic Inspiration d6 (CHA mod uses/rest)'],
    2:['Jack of All Trades (add half prof to unproficient checks)','Song of Rest d6'],
    3:['Bard College (subclass)','Expertise (2 skills)'],
    4:['ASI'],
    5:['Bardic Inspiration d8','Font of Inspiration (regain on short rest)'],
    6:['Countercharm','College Feature'],
    8:['ASI'],
    9:['Song of Rest d8'],
    10:['Bardic Inspiration d10','Expertise (2 more skills)','Magical Secrets (2 spells any class)'],
    12:['ASI'],
    13:['Song of Rest d10'],
    14:['Magical Secrets (2 more)','College Feature'],
    15:['Bardic Inspiration d12'],
    16:['ASI'],
    17:['Song of Rest d12'],
    18:['Magical Secrets (2 more)'],
    19:['ASI'],
    20:['Superior Inspiration (min 1 Bardic die on initiative)']
  },
  Druid: {
    1:['Druidic','Spellcasting'],
    2:['Wild Shape (CR 1/4, no fly/swim)','Druid Circle (subclass)'],
    4:['Wild Shape (CR 1/2, no fly)','ASI'],
    6:['Circle Feature'],
    8:['Wild Shape (CR 1)','ASI'],
    10:['Circle Feature'],
    12:['ASI'],
    14:['Circle Feature'],
    16:['ASI'],
    18:['Timeless Body (age 10√ó slower)','Beast Spells (cast while Wild Shaped)'],
    19:['ASI'],
    20:['Archdruid (unlimited Wild Shape)']
  },
  Sorcerer: {
    1:['Spellcasting','Sorcerous Origin (subclass)'],
    2:['Font of Magic (sorcery points = level)','Flexible Casting'],
    3:['Metamagic (choose 2)'],
    4:['ASI'],
    6:['Sorcerous Origin Feature'],
    8:['ASI'],
    10:['Metamagic (choose a 3rd)'],
    12:['ASI'],
    14:['Sorcerous Origin Feature'],
    16:['ASI'],
    17:['Metamagic (choose a 4th)'],
    18:['Sorcerous Origin Feature'],
    19:['ASI'],
    20:['Sorcerous Restoration (recover 4 sorcery points on short rest)']
  },
  Warlock: {
    1:['Otherworldly Patron (subclass)','Pact Magic (slots regain on short rest)'],
    2:['Eldritch Invocations (choose 2)'],
    3:['Pact Boon (Pact of the Blade/Chain/Tome/Talisman)'],
    4:['ASI'],
    5:['Eldritch Invocations (5 total)'],
    6:['Patron Feature'],
    8:['ASI'],
    9:['Eldritch Invocations (9 total)'],
    10:['Patron Feature'],
    11:['Mystic Arcanum (6th level spell, 1/long rest)'],
    12:['ASI','Eldritch Invocations (12 total)'],
    13:['Mystic Arcanum (7th level, 1/long rest)'],
    14:['Patron Feature'],
    15:['Mystic Arcanum (8th level, 1/long rest)','Eldritch Invocations (15 total)'],
    16:['ASI'],
    17:['Mystic Arcanum (9th level, 1/long rest)'],
    18:['Eldritch Invocations (18 total)'],
    19:['ASI'],
    20:['Eldritch Master (regain all Pact Magic slots in 1 min, 1/long rest)']
  },
  Monk: {
    1:['Unarmored Defense (AC=10+DEX+WIS)','Martial Arts d4 (unarmed strike)'],
    2:['Ki (level ki points, regain on short rest)','Flurry of Blows','Patient Defense','Step of the Wind','Unarmored Movement (+10ft)'],
    3:['Monastic Tradition (subclass)','Deflect Missiles','Stunning Strike'],
    4:['ASI','Slow Fall'],
    5:['Extra Attack','Stunning Strike (use ki to stun on hit)'],
    6:['Ki-Empowered Strikes (unarmed = magical)','Tradition Feature','Unarmored Movement (+15ft)'],
    7:['Evasion','Stillness of Mind (end charm/fear as action)'],
    8:['ASI'],
    9:['Unarmored Movement (run on walls/water while moving)'],
    10:['Purity of Body (immune disease/poison)','Tongue of the Sun and Moon'],
    11:['Tradition Feature'],
    12:['ASI'],
    14:['Diamond Soul (proficient in all saving throws; spend ki to reroll)'],
    15:['Timeless Body (no aging penalty, no food/water)'],
    16:['ASI'],
    17:['Tradition Feature','Unarmed Strike d10'],
    18:['Empty Body (invisible for 1 minute; Astral Projection)'],
    19:['ASI'],
    20:['Perfect Self (gain 4 ki on initiative if you have none)']
  },
  Ranger: {
    1:['Favored Enemy','Natural Explorer'],
    2:['Fighting Style','Spellcasting'],
    3:['Ranger Archetype (subclass)','Primeval Awareness'],
    4:['ASI'],
    5:['Extra Attack'],
    6:['Favored Enemy (2nd type)','Natural Explorer (2nd terrain)'],
    7:['Archetype Feature'],
    8:["ASI","Land's Stride (difficult terrain doesn't slow, ignore nonmagical hazards)"],
    9:['Natural Explorer (3rd terrain)'],
    10:['Hide in Plain Sight (+10 Stealth when camouflaged and still)'],
    11:['Archetype Feature'],
    12:['ASI'],
    14:['Favored Enemy (3rd type)','Vanish (Hide as bonus action; can\'t be tracked nonmagically)'],
    15:['Archetype Feature'],
    16:['ASI'],
    18:['Feral Senses (no disadvantage vs invisible, detect hidden creatures)'],
    19:['ASI'],
    20:['Foe Slayer (add WIS mod to attack or damage 1/turn vs favored enemy)']
  },
  Artificer: {
    1:['Magical Tinkering','Spellcasting'],
    2:['Infuse Item (choose 4 infusion types, imbue 2)'],
    3:['Artificer Specialist (subclass)','Right Tool for the Job'],
    4:['ASI'],
    6:['Tool Expertise (double prof on tool checks)','Specialist Feature'],
    8:['ASI','Flash of Genius (reaction: add INT mod to roll within 30ft)'],
    10:['Magic Item Adept (attune to 4 items, craft uncommon in half time)','Specialist Feature'],
    12:['ASI'],
    14:['Magic Item Savant (attune 5 items, ignore class/race/spell/level requirements)'],
    15:['Specialist Feature'],
    16:['ASI'],
    18:['Magic Item Master (attune to 6 items)'],
    19:['ASI'],
    20:['Soul of Artifice (+1 to all saving throws per attuned item; reaction vs 0 HP to drop to 1 HP)']
  }
};

/* =============================================================================
   STATIC DATA ‚Äî FEATS LIST (comprehensive)
============================================================================= */
const FEATS_LIST = [
  // PHB
  'Alert','Actor','Athlete','Charger','Crossbow Expert','Defensive Duelist','Dual Wielder',
  'Dungeon Delver','Durable','Elemental Adept','Grappler','Great Weapon Master','Healer',
  'Heavily Armored','Heavy Armor Master','Inspiring Leader','Keen Mind','Lightly Armored',
  'Linguist','Lucky','Mage Slayer','Magic Initiate','Martial Adept','Medium Armor Master',
  'Mobile','Moderately Armored','Mounted Combatant','Observant','Polearm Master','Resilient',
  'Ritual Caster','Savage Attacker','Sentinel','Sharpshooter','Shield Master','Skilled',
  'Skulker','Spell Sniper','Tavern Brawler','Tough','War Caster','Weapon Master',
  // Xanathar's
  'Bountiful Luck','Dragon Fear','Dragon Hide','Drow High Magic','Dwarven Fortitude',
  'Elven Accuracy','Fade Away','Fey Teleportation','Flames of Phlegethos','Infernal Constitution',
  'Orcish Fury','Prodigy','Second Chance','Squat Nimbleness','Wood Elf Magic',
  // Tasha's
  'Artificer Initiate','Chef','Crusher','Eldritch Adept','Fey Touched','Fighting Initiate',
  'Gunner','Metamagic Adept','Piercer','Poisoner','Shadow Touched','Skill Expert','Slasher',
  'Telekinetic','Telepathic',
  // Strixhaven
  'Strixhaven Initiate','Strixhaven Mascot',
  // Dragonlance / Other
  'Gift of the Chromatic Dragon','Gift of the Gem Dragon','Gift of the Metallic Dragon',
  'Aberrant Dragonmark','Revenant Blade','Grudge-Bearer',
  // Tashas optional class features
  'Piercer','Slasher','Crusher',
];

/* =============================================================================
   STATIC DATA ‚Äî REFERENCE (Conditions, Actions, Cover, DCs, Damage Types)
============================================================================= */
const CONDITIONS = [
  {n:'Blinded',       d:'Auto-fail sight checks. Attack rolls against you have advantage. Your attacks have disadvantage.'},
  {n:'Charmed',       d:"Can't attack the charmer. Charmer has advantage on social checks against you."},
  {n:'Deafened',      d:'Auto-fail hearing checks. Disadvantage on checks requiring sound.'},
  {n:'Exhaustion',    d:'1: Disadvantage checks. 2: Speed halved. 3: Disadvantage attacks/saves. 4: HP max halved. 5: Speed 0. 6: Death.'},
  {n:'Frightened',    d:'Disadvantage on checks/attacks while source visible. Cannot voluntarily move toward source.'},
  {n:'Grappled',      d:"Speed becomes 0. Ends if grappler is incapacitated or you're moved out of reach."},
  {n:'Incapacitated', d:"Can't take actions or reactions."},
  {n:'Invisible',     d:'Cannot be seen without special sense. Advantage on attacks. Attacks against you have disadvantage.'},
  {n:'Paralyzed',     d:'Incapacitated. Auto-fail STR/DEX saves. Attacks have advantage. Hits within 5ft are critical.'},
  {n:'Petrified',     d:'Transformed to stone. Incapacitated. Immune to all attacks. Resistant all damage. Immune poison/disease.'},
  {n:'Poisoned',      d:'Disadvantage on attack rolls and ability checks.'},
  {n:'Prone',         d:'Move only by crawling (1 extra ft per ft). Disadvantage on attacks. Melee within 5ft = advantage; ranged = disadvantage.'},
  {n:'Restrained',    d:'Speed 0. Disadvantage on attacks. Attacks have advantage. Disadvantage on DEX saves.'},
  {n:'Stunned',       d:'Incapacitated. Auto-fail STR/DEX saves. Attacks against you have advantage.'},
  {n:'Unconscious',   d:'Incapacitated, unaware. Drop held items, fall prone. Hits within 5ft are critical hits.'}
];

const COMBAT_ACTIONS = [
  {n:'Attack',                d:'Make one melee or ranged attack. More attacks with Extra Attack feature.'},
  {n:'Cast a Spell',          d:'Cast a spell with a casting time of 1 action.'},
  {n:'Dash',                  d:'Double your movement speed this turn.'},
  {n:'Disengage',             d:'Movement does not provoke opportunity attacks for the rest of your turn.'},
  {n:'Dodge',                 d:'Attacks against you have disadvantage. You have advantage on DEX saves. Loses effect if incapacitated or speed 0.'},
  {n:'Help',                  d:'Give an ally advantage on their next ability check, or an attack roll against a creature you threaten.'},
  {n:'Hide',                  d:'Make a Stealth check against the passive Perception of nearby creatures. If successful, you become hidden.'},
  {n:'Ready',                 d:'Hold an action until a specified trigger. Uses your reaction when triggered. Requires Concentration if holding a spell.'},
  {n:'Search',                d:'Devote attention to finding something. DM calls for Perception or Investigation check.'},
  {n:'Use an Object',         d:'Interact with a second object, or use an object that requires an action.'},
  {n:'Grapple',               d:"Make an Athletics check contested by target's Athletics or Acrobatics. Success: target is grappled."},
  {n:'Shove',                 d:"Make an Athletics check contested by target's Athletics or Acrobatics. Success: knock prone or push 5 feet."},
  {n:'Bonus Action',          d:'Some class features, spells, or items grant a bonus action. Only one per turn.'},
  {n:'Reaction',              d:'Opportunity attack, readied action, or specific class feature. Only one per round, recharges on your turn.'},
  {n:'Two-Weapon Fighting',   d:'When you take the Attack action with a light weapon, attack with offhand as a bonus action (no ability mod to bonus damage unless negative).'},
  {n:'Interact with Object',  d:'Free once per turn (draw weapon, open unlocked door). A second object interaction costs your action.'}
];

const COVER_INFO = [
  {n:'Half Cover (+2)',        d:'Provides +2 bonus to AC and DEX saving throws. Low walls, large furniture, another creature.'},
  {n:'Three-Quarters Cover (+5)', d:'Provides +5 bonus to AC and DEX saving throws. Portcullis, arrow slits, thick tree trunk.'},
  {n:'Total Cover',            d:"Cannot be targeted directly by attacks or spells. Must be completely obscured."},
  {n:'Lightly Obscured',       d:'Disadvantage on Perception checks. Dim light, patchy fog, moderate foliage.'},
  {n:'Heavily Obscured',       d:'Effectively blinded while in or targeting into the area. Darkness, dense fog, thick foliage.'},
  {n:'Difficult Terrain',      d:'Every foot of movement costs 1 extra foot. Ice, rubble, deep snow, shallow water, dense vegetation.'}
];

const DC_INFO = [
  {n:'DC 5 ‚Äî Very Easy',         d:'Something almost anyone could do. Untrained commoners can usually manage.'},
  {n:'DC 10 ‚Äî Easy',             d:'Requires some effort or moderate skill. Trained characters succeed routinely.'},
  {n:'DC 15 ‚Äî Medium',           d:'A real challenge for untrained individuals. Professionals may still fail.'},
  {n:'DC 20 ‚Äî Hard',             d:'Even experts may fail. Represents the edge of normal human capability.'},
  {n:'DC 25 ‚Äî Very Hard',        d:'Near the limit of trained, talented individuals. Exceptional effort required.'},
  {n:'DC 30 ‚Äî Nearly Impossible',d:'Legendary feats. Only the most powerful or lucky characters can succeed.'}
];

const DMG_TYPES = [
  {n:'Acid',          d:'Corrosive liquid. Black puddings, green dragons, Acid Splash.'},
  {n:'Bludgeoning',   d:'Blunt force trauma. Clubs, hammers, falling damage, earth elementals.'},
  {n:'Cold',          d:'Ice and freezing temperatures. White dragons, Ice Storm, Cone of Cold.'},
  {n:'Fire',          d:'Flames and heat. Red/brass dragons, Fireball, burning oil, torches.'},
  {n:'Force',         d:'Pure magical energy. Magic Missile, Eldritch Blast, Spiritual Weapon.'},
  {n:'Lightning',     d:'Electrical energy. Lightning Bolt, blue/bronze dragons, Call Lightning.'},
  {n:'Necrotic',      d:'Negative energy that withers. Undead attacks, Inflict Wounds, Vampiric Touch.'},
  {n:'Piercing',      d:'Puncture wounds. Arrows, lances, spears, bite attacks, icicles.'},
  {n:'Poison',        d:'Venoms and toxic substances. Snake bites, Poison Spray, Cloudkill.'},
  {n:'Psychic',       d:'Mental damage. Mind Flayer attacks, Psychic Scream, Dissonant Whispers.'},
  {n:'Radiant',       d:'Divine/holy energy. Sacred Flame, Guiding Bolt, Sunbeam, solar attacks.'},
  {n:'Slashing',      d:'Cutting damage. Swords, claws, axes, scimitars.'},
  {n:'Thunder',       d:'Concussive sound waves. Thunderwave, Shatter, Thunderclap, sonic attacks.'}
];

/* =============================================================================
   CAMPAIGN CODE HELPERS ‚Äî 4-character codes using server-side lookup
   (Fallback: short base62 hash maps to full data stored in localStorage)
============================================================================= */
const CODE_CHARS = '23456789ABCDEFGHJKLMNPQRSTUVWXYZ'; // 32 chars, no ambiguous chars

function generateShortCode() {
  let code = '';
  for (let i = 0; i < 4; i++) code += CODE_CHARS[Math.floor(Math.random() * CODE_CHARS.length)];
  return code;
}

/** Store a campaign under a short code in localStorage (acts as shared registry on same browser/device) */
function storeCampaignCode(code, data) {
  const codes = JSON.parse(localStorage.getItem('tl_codes') || '{}');
  codes[code] = data;
  localStorage.setItem('tl_codes', JSON.stringify(codes));
}

function lookupCampaignCode(code) {
  const codes = JSON.parse(localStorage.getItem('tl_codes') || '{}');
  return codes[code.toUpperCase()] || null;
}

/* =============================================================================
   APPLICATION STATE
============================================================================= */
let currentUser    = null;
let editingCharId  = null;
let abilityMethod  = 'standard';
// Per-character form state (reset on each open)
let customSpells   = [];
let customEquip    = [];
let customFeatures = [];
let selectedFeats  = [];
let mcClasses      = [];
let activeConditions = [];
let attackList     = [];
let deathSuccesses = 0;
let deathFailures  = 0;
let spellSlots     = {};
let inspiration    = false;
// Dice roller
let rollHistory    = [];

/* =============================================================================
   STORAGE HELPERS
   NOTE: All data is stored in localStorage. For true cross-device persistence
   you would need a backend (e.g. Firebase, Supabase, or a custom API).
   Passwords are hashed with btoa (basic obfuscation) ‚Äî not cryptographically
   secure. For production, use bcrypt on a server.
============================================================================= */
const getUsers    = () => JSON.parse(localStorage.getItem('tl_users') || '{}');
const saveUsers   = u  => localStorage.setItem('tl_users', JSON.stringify(u));
const getUserData = () => JSON.parse(localStorage.getItem('tl_data_' + currentUser) || '{"characters":[],"campaigns":[]}');
const saveUserData= d  => localStorage.setItem('tl_data_' + currentUser, JSON.stringify(d));

/* =============================================================================
   AUTH FUNCTIONS
============================================================================= */
function switchAuthTab(t, btn) {
  document.querySelectorAll('.auth-tab').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  document.getElementById('auth-login').style.display    = t === 'login'    ? 'block' : 'none';
  document.getElementById('auth-register').style.display = t === 'register' ? 'block' : 'none';
}

function doLogin() {
  const u   = document.getElementById('login-user').value.trim();
  const p   = document.getElementById('login-pass').value;
  const err = document.getElementById('login-err');
  if (!u || !p) { showErr(err, 'Please fill in all fields.'); return; }
  try {
    const users = getUsers();
    if (!users[u] || users[u].pass !== btoa(p)) { showErr(err, 'Invalid username or password.'); return; }
    err.style.display = 'none';
    currentUser = u;
    transitionToApp();
  } catch(e) {
    showErr(err, 'Login error: ' + e.message);
  }
}

function doGuest() {
  currentUser = 'Guest';
  transitionToApp();
}

function doRegister() {
  const u   = document.getElementById('reg-user').value.trim();
  const p   = document.getElementById('reg-pass').value;
  const p2  = document.getElementById('reg-pass2').value;
  const err = document.getElementById('reg-err');
  if (!u || u.length < 3)    { showErr(err, 'Username must be 3+ characters.'); return; }
  if (p.length < 6)          { showErr(err, 'Password must be 6+ characters.'); return; }
  if (p !== p2)              { showErr(err, 'Passwords do not match.'); return; }
  try {
    const users = getUsers();
    if (users[u])              { showErr(err, 'Username already taken.'); return; }
    users[u] = { pass: btoa(p), email: document.getElementById('reg-email').value };
    saveUsers(users);
    currentUser = u;
    err.style.display = 'none';
    transitionToApp();
  } catch(e) {
    showErr(err, 'Registration error: ' + e.message);
  }
}

function showErr(el, msg) { el.textContent = msg; el.style.display = 'block'; }

function transitionToApp() {
  const auth = document.getElementById('auth-page');
  const app  = document.getElementById('app-page');
  startApp();
  app.offsetHeight; // force reflow
  app.classList.add('visible');
  auth.classList.remove('visible');
  setTimeout(() => { auth.classList.remove('active'); auth.style.display = 'none'; }, 360);
}

function doLogout() {
  currentUser = null;
  const app  = document.getElementById('app-page');
  const auth = document.getElementById('auth-page');
  document.getElementById('login-user').value = '';
  document.getElementById('login-pass').value = '';
  document.getElementById('login-err').style.display = 'none';
  auth.style.display = '';
  auth.classList.add('active');
  auth.offsetHeight;
  auth.classList.add('visible');
  app.classList.remove('visible');
}

function startApp() {
  document.getElementById('nav-username').textContent = currentUser;
  renderCharList();
  renderCampaignList();
  buildReference();
  showSection('characters');
}

/* =============================================================================
   NAVIGATION
============================================================================= */
function showSection(s) {
  ['characters','dice','campaigns','reference','dmtools'].forEach(id => {
    document.getElementById('section-' + id).style.display = id === s ? 'block' : 'none';
  });
  if (s === 'dmtools') { refreshPartyView(); if (!mapCanvas) initTacticalMap(); }
  document.querySelectorAll('.nav-link').forEach(b => b.classList.remove('active'));
  const map = {characters:0, dice:1, campaigns:2, reference:3};
  const links = document.querySelectorAll('.nav-link');
  if (links[map[s]]) links[map[s]].classList.add('active');
}

function toggleNav() { document.getElementById('nav-links').classList.toggle('open'); }
function closeNav()  { document.getElementById('nav-links').classList.remove('open'); }

/* =============================================================================
   UTILITY HELPERS
============================================================================= */
const mod  = s  => Math.floor((s - 10) / 2);
const fmod = n  => (n >= 0 ? '+' : '') + n;
const pb   = l  => PROF_BONUS[Math.min(l, 20)] || 2;
const sid  = n  => n.replace(/\s/g, '');

function getScores() {
  const s = {};
  ABILITIES.forEach(a => {
    const el = document.getElementById('ability-' + a);
    s[a] = el ? parseInt(el.value) || 10 : 10;
  });
  return s;
}

/* =============================================================================
   CHARACTER LIST RENDERING
============================================================================= */
function renderCharList() {
  const data = getUserData();
  const el   = document.getElementById('char-list');
  if (!data.characters.length) {
    el.innerHTML = '<div class="muted" style="padding:20px 0">No characters yet. Create your first adventurer!</div>';
    return;
  }
  el.innerHTML = data.characters.map(c => `
    <div class="char-card">
      <div style="display:flex;gap:12px;align-items:flex-start">
        ${c.portrait ? `<img src="${c.portrait}" style="width:56px;height:70px;object-fit:cover;border:1px solid rgba(201,168,76,.4);flex-shrink:0" onerror="this.style.display='none'">` : ''}
        <div style="flex:1">
          <div class="char-name">${c.name || 'Unnamed'}</div>
          <div class="char-info">
            Level ${c.level || 1} ${c.race || '?'} ${c.cls || '?'}${c.subclass ? ' (' + c.subclass + ')' : ''}
            ${(c.mcClasses && c.mcClasses.length) ? ' / ' + c.mcClasses.map(m => m.level + ' ' + m.cls + (m.sub ? ' ('+m.sub+')' : '')).join(' / ') : ''}
          </div>
          <div class="char-info">${c.background || 'No Background'} ¬∑ ${c.alignment || 'Unaligned'}</div>
          ${renderXPBar(c)}
          <div class="tags">
            ${c.background       ? `<span class="badge badge-gold">${c.background}</span>` : ''}
            ${c.inspiration      ? `<span class="badge badge-gold">‚òÖ Inspired</span>`      : ''}
            ${c.exhaustion > 0   ? `<span class="badge badge-red">Exhausted ${c.exhaustion}</span>` : ''}
            <span class="badge badge-green">${c.curhp || 0}/${c.maxhp || 0} HP</span>
          </div>
        </div>
      </div>
      <div class="char-actions">
        <button class="btn btn-outline btn-sm" onclick="viewCharacter('${c.id}')">View Sheet</button>
        <button class="btn btn-outline btn-sm" onclick="editCharacter('${c.id}')">Edit</button>
        <button class="btn btn-red btn-sm"     onclick="deleteCharacter('${c.id}')">Delete</button>
      </div>
    </div>
  `).join('');
}

function deleteCharacter(id) {
  if (!confirm('Delete this character permanently?')) return;
  const data = getUserData();
  data.characters = data.characters.filter(c => c.id !== id);
  saveUserData(data);
  renderCharList();
}

/* =============================================================================
   CHARACTER CREATOR ‚Äî OPEN / RESET / LOAD
============================================================================= */
function openCharCreator() {
  editingCharId = null;
  document.getElementById('creator-title').textContent = 'Create New Character';
  resetCreatorForm();
  openModal('creator-modal');
  creatorTab('basics', document.querySelector('.tab-btn'));
  buildAbilityGrid();
  buildSkillsList();
  buildSavingThrows();
  buildSpellSlotUI();
  buildDeathSaves();
  buildConditionTracker();
  populateFeatPicker();
}

function editCharacter(id) {
  const data = getUserData();
  const c    = data.characters.find(x => x.id === id);
  if (!c) return;
  editingCharId = id;
  document.getElementById('creator-title').textContent = 'Edit: ' + c.name;
  resetCreatorForm();
  loadCharIntoForm(c);
  openModal('creator-modal');
  creatorTab('basics', document.querySelector('.tab-btn'));
  buildAbilityGrid();
  loadAbilitiesIntoForm(c);
  buildSkillsList(c);
  buildSavingThrows(c);
  buildSpellSlotUI(c);
  buildDeathSaves(c);
  renderAttacks();
  renderEquipList();
  renderSpellList();
  renderFeaturesPanel(c);
  buildConditionTracker(c);
  populateFeatPicker();
}

function resetCreatorForm() {
  const textFields = ['c-name','c-age','c-height','c-weight','c-eyes','c-hair','c-skin',
    'c-portrait','c-languages','c-profs','c-traits','c-ideals','c-bonds',
    'c-flaws','c-backstory','c-allies','c-extra-traits','c-notes','c-quests','c-treasure'];
  const selectFields = ['c-race','c-class','c-subclass','c-subrace','c-background','c-alignment','c-spell-ability','c-exhaustion'];
  const numberDefaults = { 'c-level':1,'c-xp':0,'c-ac':10,'c-speed':30,'c-maxhp':0,'c-curhp':0,'c-temphp':0,'c-hitdice-remain':1,'c-cp':0,'c-sp':0,'c-ep':0,'c-gp':0,'c-pp':0 };

  textFields.forEach(id  => { const el = document.getElementById(id); if (el) el.value = ''; });
  selectFields.forEach(id=> { const el = document.getElementById(id); if (el) el.selectedIndex = 0; });
  Object.entries(numberDefaults).forEach(([id, v]) => { const el = document.getElementById(id); if (el) el.value = v; });

  const hitdieEl = document.getElementById('c-hitdie');
  if (hitdieEl) hitdieEl.value = '8';

  ['prof-light','prof-medium','prof-heavy','prof-shield'].forEach(id => {
    const el = document.getElementById(id); if (el) el.checked = false;
  });

  // Reset state arrays
  customSpells = []; customEquip = []; customFeatures = [];
  selectedFeats = []; mcClasses = []; attackList = [];
  deathSuccesses = 0; deathFailures = 0; spellSlots = {};
  inspiration = false; activeConditions = [];
  abilityMethod = 'standard';

  // Reset UI labels
  ['race-info','class-info','bg-info','subrace-info'].forEach(id => {
    const el = document.getElementById(id); if (el) el.textContent = '';
  });
  const ip = document.getElementById('insp-pip'); if (ip) ip.classList.remove('active');
  const mc = document.getElementById('mc-list');  if (mc) mc.innerHTML = '';
}

function loadCharIntoForm(c) {
  const sv = (id, v) => { const el = document.getElementById(id); if (el && v !== undefined && v !== null) el.value = v; };
  sv('c-name',c.name);           sv('c-race',c.race);           sv('c-class',c.cls);
  sv('c-level',c.level);         sv('c-background',c.background);sv('c-alignment',c.alignment);
  sv('c-xp',c.xp);               sv('c-portrait',c.portrait);   sv('c-age',c.age);
  sv('c-height',c.height);       sv('c-subrace',c.subrace);     sv('c-weight',c.weight);
  sv('c-eyes',c.eyes);           sv('c-hair',c.hair);           sv('c-skin',c.skin);
  sv('c-ac',c.ac);               sv('c-speed',c.speed);         sv('c-maxhp',c.maxhp);
  sv('c-curhp',c.curhp);         sv('c-temphp',c.temphp);       sv('c-hitdice-remain',c.hitdiceRemain);
  sv('c-hitdie',c.hitdie);       sv('c-cp',c.cp);               sv('c-sp',c.sp);
  sv('c-ep',c.ep);               sv('c-gp',c.gp);               sv('c-pp',c.pp);
  sv('c-traits',c.traits);       sv('c-ideals',c.ideals);       sv('c-bonds',c.bonds);
  sv('c-flaws',c.flaws);         sv('c-backstory',c.backstory); sv('c-allies',c.allies);
  sv('c-extra-traits',c.extraTraits); sv('c-notes',c.notes);    sv('c-quests',c.quests);
  sv('c-treasure',c.treasure);   sv('c-spell-ability',c.spellAbility);
  sv('c-languages',c.languages); sv('c-profs',c.profs);         sv('c-exhaustion',c.exhaustion || 0);

  if (c.armorProfs) {
    ['light','medium','heavy','shield'].forEach(t => {
      const el = document.getElementById('prof-' + t); if (el) el.checked = c.armorProfs[t];
    });
  }

  inspiration = c.inspiration || false;
  const ip = document.getElementById('insp-pip'); if (ip) ip.classList.toggle('active', inspiration);

  if (c.cls)        updateClassInfo(c.subclass);
  if (c.race)       { updateRaceInfo(); const srEl = document.getElementById('c-subrace'); if (srEl && c.subrace) srEl.value = c.subrace; }
  if (c.background) updateBackgroundInfo();
  updateSubclassInfo();

  customSpells   = c.spells          ? JSON.parse(JSON.stringify(c.spells))         : [];
  customEquip    = c.equipment       ? JSON.parse(JSON.stringify(c.equipment))       : [];
  customFeatures = c.customFeatures  ? JSON.parse(JSON.stringify(c.customFeatures)) : [];
  selectedFeats  = c.feats           ? [...c.feats]                                  : [];
  mcClasses      = c.mcClasses       ? JSON.parse(JSON.stringify(c.mcClasses))       : [];
  attackList     = c.attacks         ? JSON.parse(JSON.stringify(c.attacks))         : [];
  deathSuccesses   = c.deathSuccesses  || 0;
  deathFailures    = c.deathFailures   || 0;
  spellSlots       = c.spellSlots      ? JSON.parse(JSON.stringify(c.spellSlots))      : {};
  activeConditions = c.activeConditions ? [...c.activeConditions] : [];
  const concEl = document.getElementById('c-concentration'); if (concEl) concEl.value = c.concentration || '';

  renderMcList();
}

function loadAbilitiesIntoForm(c) {
  if (!c.abilityScores) return;
  ABILITIES.forEach(a => {
    const el = document.getElementById('ability-' + a);
    if (el) { el.value = c.abilityScores[a] || 10; onAbilityChange(a); }
  });
  if (c.skillProfs) SKILLS_DATA.forEach(sk => { const cb = document.getElementById('skill-' + sid(sk.name)); if (cb) cb.checked = c.skillProfs.includes(sk.name); });
  if (c.skillExp)   SKILLS_DATA.forEach(sk => { const cb = document.getElementById('skill-exp-' + sid(sk.name)); if (cb) cb.checked = c.skillExp.includes(sk.name); });
  if (c.saveProfs)  ABILITIES.forEach(a   => { const cb = document.getElementById('save-' + a); if (cb) cb.checked = c.saveProfs.includes(a); });
  updateSkillsList();
  updateSavesList();
}

function collectCharData() {
  const gv = id => { const el = document.getElementById(id); return el ? el.value : ''; };
  const gn = id => { const el = document.getElementById(id); return el ? parseInt(el.value) || 0 : 0; };
  const skillProfs = SKILLS_DATA.filter(sk => { const cb = document.getElementById('skill-' + sid(sk.name)); return cb && cb.checked; }).map(sk => sk.name);
  const skillExp   = SKILLS_DATA.filter(sk => { const cb = document.getElementById('skill-exp-' + sid(sk.name)); return cb && cb.checked; }).map(sk => sk.name);
  const saveProfs  = ABILITIES.filter(a => { const cb = document.getElementById('save-' + a); return cb && cb.checked; });
  return {
    id: editingCharId || Date.now().toString(),
    name: gv('c-name'), race: gv('c-race'), subrace: gv('c-subrace'),
    cls: gv('c-class'), subclass: gv('c-subclass'), level: gn('c-level') || 1,
    background: gv('c-background'), alignment: gv('c-alignment'), xp: gn('c-xp'),
    portrait: gv('c-portrait'), age: gv('c-age'), height: gv('c-height'), weight: gv('c-weight'),
    eyes: gv('c-eyes'), hair: gv('c-hair'), skin: gv('c-skin'),
    abilityScores: getScores(), skillProfs, skillExp, saveProfs,
    languages: gv('c-languages'), profs: gv('c-profs'),
    armorProfs: {
      light:  document.getElementById('prof-light')?.checked,
      medium: document.getElementById('prof-medium')?.checked,
      heavy:  document.getElementById('prof-heavy')?.checked,
      shield: document.getElementById('prof-shield')?.checked
    },
    ac: gn('c-ac'), speed: gn('c-speed'), maxhp: gn('c-maxhp'), curhp: gn('c-curhp'),
    temphp: gn('c-temphp'), hitdie: gv('c-hitdie'), hitdiceRemain: gn('c-hitdice-remain'),
    exhaustion: gn('c-exhaustion'), inspiration,
    cp: gn('c-cp'), sp: gn('c-sp'), ep: gn('c-ep'), gp: gn('c-gp'), pp: gn('c-pp'),
    traits: gv('c-traits'), ideals: gv('c-ideals'), bonds: gv('c-bonds'), flaws: gv('c-flaws'),
    backstory: gv('c-backstory'), allies: gv('c-allies'), extraTraits: gv('c-extra-traits'),
    notes: gv('c-notes'), quests: gv('c-quests'), treasure: gv('c-treasure'),
    spellAbility: gv('c-spell-ability'), spells: customSpells, equipment: customEquip,
    attacks: attackList, customFeatures, feats: selectedFeats, mcClasses,
    deathSuccesses, deathFailures, spellSlots,
    concentration: gv('c-concentration'),
    activeConditions: activeConditions ? [...activeConditions] : []
  };
}

function saveCharacter() {
  const c = collectCharData();
  if (!c.name) { alert('Please enter a character name.'); return; }
  const data = getUserData();
  if (editingCharId) {
    const i = data.characters.findIndex(x => x.id === editingCharId);
    if (i >= 0) data.characters[i] = c; else data.characters.push(c);
  } else {
    data.characters.push(c);
  }
  saveUserData(data);
  renderCharList();
  closeModal('creator-modal');
}

/* =============================================================================
   RACE / CLASS / BACKGROUND INFO
============================================================================= */
function updateRaceInfo() {
  const r  = document.getElementById('c-race').value;
  const rd = RACE_DATA[r];
  const el = document.getElementById('race-info');
  if (!rd) {
    if (el) el.innerHTML = '';
    // Reset subrace dropdown
    const srEl = document.getElementById('c-subrace');
    if (srEl) srEl.innerHTML = '<option value="">‚Äî Select Race First ‚Äî</option>';
    const srInfo = document.getElementById('subrace-info');
    if (srInfo) srInfo.innerHTML = '';
    return;
  }
  // Show rich info panel
  const bonusStr = Object.entries(rd.bonuses).map(([k,v])=>`<span style="color:var(--gold2)">+${v} ${k}</span>`).join(' ');
  el.innerHTML = `<div style="background:var(--dark3);border:1px solid rgba(201,168,76,.25);padding:8px 10px;border-radius:2px;margin-bottom:4px">
    <div style="font-family:'Cinzel',serif;color:var(--gold);font-size:.78rem;margin-bottom:4px">${r} Traits</div>
    <div style="margin-bottom:4px">üèÉ Speed: <strong>${rd.speed}ft</strong> &nbsp;${bonusStr || '<span class="muted">Flexible bonuses</span>'}</div>
    <div style="color:var(--parch2);font-size:.88rem">${rd.info}</div>
  </div>`;
  document.getElementById('c-speed').value = rd.speed;
  // Populate subrace dropdown
  const srEl = document.getElementById('c-subrace');
  if (srEl) {
    const subraces = SUBRACE_DATA[r] || [];
    srEl.innerHTML = subraces.length
      ? '<option value="">‚Äî Select Subrace ‚Äî</option>' + subraces.map(s => `<option value="${s}">${s}</option>`).join('')
      : '<option value="">‚Äî No official subraces ‚Äî</option>';
  }
  const srInfo = document.getElementById('subrace-info');
  if (srInfo) srInfo.innerHTML = '';
  updateRacialBonuses();
  updateEncumbrance();
  updateBuildSummary();
}

function updateRacialBonuses() {
  const r  = document.getElementById('c-race').value;
  const rd = RACE_DATA[r];
  const el = document.getElementById('racial-bonuses');
  if (!el) return;
  if (!rd) { el.innerHTML = '<span class="muted">Select a race to see racial bonuses.</span>'; return; }
  const lines = Object.entries(rd.bonuses).map(([k,v]) => `<strong style="color:var(--gold)">${k}</strong> +${v}`);
  el.innerHTML = `<strong style="color:var(--gold)">${r}</strong>: ${lines.join(', ') || 'Flexible (assign as desired)'}
    <span class="muted" style="font-size:.82rem;display:block;margin-top:4px">These bonuses will be added on top of your base ability scores when the character sheet is generated.</span>`;
}

function updateSubraceInfo() {
  const sub = document.getElementById('c-subrace')?.value;
  const el  = document.getElementById('subrace-info');
  if (!el) return;
  if (!sub || sub.startsWith('Standard') || sub.startsWith('‚Äî ')) { el.innerHTML = ''; return; }
  // Show a brief note for special variants
  const notes = {
    'Variant Human (feat + 2 stats)':  'Choose +1 to two ability scores, gain one feat, gain one skill proficiency.',
    'Feral Tiefling':                   '+2 DEX instead of +1 INT. Same CHA bonus. Winged variant available.',
    'Winged':                           'Fly speed 30ft. Cannot wear armor not designed for winged creatures.',
    'Devil\'s Tongue':                 'Vicious Mockery replaced by Charm Person. Different innate spellcasting.',
    'Hellfire':                         'Hellish Rebuke replaced by Burning Hands.',
    'Ghostwise':                        '+1 WIS (same as Stout). Telepathy: speak mentally with one creature within 30ft.',
    'Deep Gnome (Svirfneblin)':         '+1 DEX instead. Superior Darkvision 120ft. Stone Camouflage (adv Stealth on rock). Svirfneblin Magic (nondetection, blindness/deafness, blur, disguise self).',
    'Aquatic Half-Elf (+swim)':         'Swim speed 30ft, breathe water in addition to Half-Elf traits.',
    'Drow Half-Elf':                    'Drow Magic spells (dancing lights, faerie fire, darkness) instead of standard cantrip.',
    'Envoy':                            'Integrated Tool: one tool built into your body (expertise with it). One extra skill or tool proficiency.',
    'Juggernaut':                       'Powerful Build. Iron Fists: unarmed 1d4 + STR. Imposing Presence: Intimidation or Persuasion proficiency.',
    'Skirmisher':                       'Swift: speed +5. Light Step: not slowed by non-magical difficult terrain. Scoot: Disengage as bonus action 1/rest.',
    'Lolth-Sworn Drow':                 'Same as base Drow. Strongly tied to Underdark factions.',
    'Seldarine Drow':                   'Same as base Drow but culturally separate from Lolth worship.',
    'Chromatic (Tasha\'s)':            'Choose chromatic dragon ancestor. Breath weapon recharges on short/long rest. Resistance + Chromatic Warding at higher levels.',
    'Metallic (Tasha\'s)':             'Choose metallic dragon ancestor. Breath weapon with secondary effect (frighten or restrain). Metallic Breath Weapon.',
    'Gem (Tasha\'s)':                  'Choose gem dragon ancestor (amethyst/crystal/emerald/sapphire/topaz). Psionic breath weapon. Gem Flight at higher levels.',
  };
  const note = notes[sub];
  el.innerHTML = note
    ? `<div style="background:var(--dark3);border:1px solid rgba(201,168,76,.2);padding:6px 10px;border-radius:2px;font-size:.84rem;color:var(--parch2)">
        <strong style="color:var(--gold2)">${sub}:</strong> ${note}
       </div>`
    : '';
}

function updateClassInfo(forceSub) {
  const cls = document.getElementById('c-class').value;
  const el  = document.getElementById('class-info');
  const cd  = CLASS_DATA[cls];
  const lvl = parseInt(document.getElementById('c-level').value) || 1;
  if (!cd) {
    el.innerHTML = '';
    document.getElementById('c-subclass').innerHTML = '<option value="">‚Äî Select Class First ‚Äî</option>';
    return;
  }
  // Build level feature summary
  const feats = CLASS_FEATURES[cls] || {};
  const earned = [];
  for (let i = 1; i <= lvl; i++) { if (feats[i]) earned.push(...feats[i].map(f => `<li>${f}</li>`)); }
  const spellType = cd.spellAb ? (cd.isHalf ? 'Half-caster' : cd.isPact ? 'Pact Magic (Short rest)' : 'Full caster') : 'No spellcasting';
  const armorP = CLASS_ARMOR_PROFS[cls];
  const armorStr = armorP ? [armorP.light&&'Light',armorP.medium&&'Medium',armorP.heavy&&'Heavy',armorP.shield&&'Shield'].filter(Boolean).join(', ')||'None' : '‚Äî';
  el.innerHTML = `<div style="background:var(--dark3);border:1px solid rgba(201,168,76,.25);padding:8px 10px;border-radius:2px;margin-bottom:4px">
    <div style="font-family:'Cinzel',serif;color:var(--gold);font-size:.78rem;margin-bottom:6px">${cls} at Level ${lvl}</div>
    <div style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:6px;font-size:.84rem">
      <span>üé≤ Hit Die: <strong>d${cd.hd}</strong></span>
      <span>üõ° Saves: <strong>${cd.saves.join(', ')}</strong></span>
      <span>‚ú® ${spellType}${cd.spellAb?' ('+cd.spellAb+')':''}</span>
      <span>üî∞ Armor: <strong>${armorStr}</strong></span>
    </div>
    ${earned.length ? `<div style="font-family:'Cinzel',serif;font-size:.72rem;color:var(--gold2);margin-bottom:4px">Features at level ${lvl}:</div><ul style="margin:0;padding-left:18px;color:var(--parch2);font-size:.84rem;line-height:1.6">${earned.join('')}</ul>` : ''}
  </div>`;
  // Auto-apply armor profs
  if (armorP && !forceSub) {
    ['light','medium','heavy','shield'].forEach(t => {
      const cb = document.getElementById('prof-'+t); if (cb) cb.checked = armorP[t];
    });
  }
  // Build subclass dropdown with tooltips
  const sub = document.getElementById('c-subclass');
  sub.innerHTML = '<option value="">‚Äî No Subclass ‚Äî</option>' + cd.subs.map(s => `<option value="${s}" title="${(SUBCLASS_INFO[s]||'').replace(/"/g,"'")}">${s}</option>`).join('');
  if (forceSub) sub.value = forceSub;
  if (cd.spellAb) document.getElementById('c-spell-ability').value = cd.spellAb;
  if (cd.spellAb) document.getElementById('c-spell-ability').value = cd.spellAb;
  updateSubclassInfo();
  renderFeaturesPanel();
  buildSavingThrows();
  buildSpellSlotUI();
  updateBuildSummary();
}

function updateSubclassInfo() {
  const sub = document.getElementById('c-subclass').value;
  let el = document.getElementById('subclass-info');
  if (!el) return;
  if (!sub) { el.innerHTML = ''; return; }
  const info = SUBCLASS_INFO[sub];
  el.innerHTML = info ? `<div style="background:var(--dark3);border:1px solid rgba(201,168,76,.2);padding:8px 10px;border-radius:2px;margin-top:-10px;margin-bottom:12px;font-size:.84rem;color:var(--parch2)">
    <strong style="color:var(--gold2);font-family:'Cinzel',serif;font-size:.72rem">${sub}</strong><br>${info}</div>` : '';
  updateBuildSummary();
}

function updateBackgroundInfo() {
  const bg = document.getElementById('c-background').value;
  const bd = BG_DATA[bg];
  const el = document.getElementById('bg-info');
  if (!bd) { if (el) el.innerHTML = ''; return; }
  el.innerHTML = `<div style="background:var(--dark3);border:1px solid rgba(201,168,76,.25);padding:8px 10px;border-radius:2px;margin-bottom:4px">
    <div style="font-family:'Cinzel',serif;color:var(--gold);font-size:.78rem;margin-bottom:4px">${bg}</div>
    <div style="font-size:.86rem"><strong style="color:var(--gold2)">Skills:</strong> ${bd.skills}</div>
    <div style="font-size:.86rem"><strong style="color:var(--gold2)">Feature:</strong> ${bd.feature}</div>
  </div>`;
  // Auto-apply skill proficiencies from background
  const bgSkills = BG_SKILLS[bg] || [];
  if (bgSkills.length > 0) {
    bgSkills.forEach(skName => {
      const id = 'skill-' + sid(skName);
      const cb = document.getElementById(id);
      if (cb) cb.checked = true;
    });
    updateSkillsList();
  }
  updateBuildSummary();
}

function updateLevel() {
  const lvl = parseInt(document.getElementById('c-level').value) || 1;
  document.getElementById('c-prof-display').textContent = fmod(pb(lvl));
  buildSpellSlotUI();
  renderFeaturesPanel();
  updateASIList();
  const cls = document.getElementById('c-class').value;
  const cd  = CLASS_DATA[cls];
  if (cd) {
    document.getElementById('c-hitdie').value = cd.hd;
    // Refresh class info panel with new level features
    updateClassInfo(document.getElementById('c-subclass').value || undefined);
  }
}

/* =============================================================================
   MULTICLASSING
============================================================================= */
function addMulticlass() {
  mcClasses.push({ cls:'', level:1 });
  renderMcList();
}

function renderMcList() {
  const el = document.getElementById('mc-list');
  if (!el) return;
  el.innerHTML = mcClasses.map((mc, i) => {
    const cd = mc.cls ? CLASS_DATA[mc.cls] : null;
    const subOptions = cd ? cd.subs.map(s =>
      `<option value="${s}" ${mc.sub===s?'selected':''}>${s}</option>`
    ).join('') : '';
    return `
    <div class="mc-entry" style="flex-wrap:wrap;gap:6px">
      <select onchange="mcClasses[${i}].cls=this.value;mcClasses[${i}].sub='';renderMcList()" style="flex:2;margin:0;min-width:120px">
        <option value="">‚Äî Class ‚Äî</option>
        ${Object.keys(CLASS_DATA).map(c => `<option value="${c}" ${mc.cls===c?'selected':''}>${c}</option>`).join('')}
      </select>
      ${cd ? `<select onchange="mcClasses[${i}].sub=this.value" style="flex:2;margin:0;min-width:140px">
        <option value="">‚Äî Subclass (optional) ‚Äî</option>
        ${subOptions}
      </select>` : ''}
      <input type="number" value="${mc.level}" min="1" max="19" style="width:60px;margin:0"
             onchange="mcClasses[${i}].level=parseInt(this.value)||1">
      <span class="muted">lvl</span>
      <button class="btn btn-red btn-sm" onclick="mcClasses.splice(${i},1);renderMcList()">‚úï</button>
    </div>`;
  }).join('');
}

/* =============================================================================
   ABILITY SCORES
============================================================================= */
function buildAbilityGrid() {
  const grid = document.getElementById('ability-grid');
  if (!grid) return;
  grid.innerHTML = ABILITIES.map((a, i) => `
    <div class="stat-box">
      <span class="stat-label">${a}</span>
      <input type="number" class="stat-input-sm" id="ability-${a}"
             value="${STANDARD_ARRAY[i] || 10}" min="1" max="30"
             onchange="onAbilityChange('${a}')">
      <div class="stat-mod" id="mod-${a}">${fmod(mod(STANDARD_ARRAY[i] || 10))}</div>
    </div>
  `).join('');
  setAbilityMethod('standard', document.querySelector('.method-btn'));
}

function onAbilityChange(a) {
  const score = parseInt(document.getElementById('ability-' + a)?.value) || 10;
  const mEl   = document.getElementById('mod-' + a);
  if (mEl) mEl.textContent = fmod(mod(score));
  updateDerivedStats();
  if (abilityMethod === 'pointbuy') updatePointBuy();
}

function setAbilityMethod(method, btn) {
  abilityMethod = method;
  document.querySelectorAll('.method-btn').forEach(b => b.classList.remove('active'));
  if (btn) btn.classList.add('active');
  const infoText = {
    standard: 'Standard Array: assign 15, 14, 13, 12, 10, 8 ‚Äî one to each ability.',
    pointbuy: 'Point Buy: 27 points. Scores range 8‚Äì15 before racial bonuses.',
    roll:     'Rolling 4d6, dropping lowest, for each ability.',
    manual:   'Manual Entry: type any values you choose.'
  };
  const infoEl = document.getElementById('ability-method-info');
  const pbEl   = document.getElementById('point-buy-remaining');
  if (infoEl) infoEl.textContent = infoText[method];

  if (method === 'standard') {
    STANDARD_ARRAY.forEach((v, i) => { const el = document.getElementById('ability-' + ABILITIES[i]); if (el) { el.value = v; el.readOnly = false; } });
    ABILITIES.forEach(a => onAbilityChange(a));
    if (pbEl) pbEl.style.display = 'none';
  } else if (method === 'pointbuy') {
    ABILITIES.forEach(a => { const el = document.getElementById('ability-' + a); if (el) { el.value = 8; el.readOnly = false; } onAbilityChange(a); });
    if (pbEl) pbEl.style.display = 'block';
    updatePointBuy();
  } else if (method === 'roll') {
    ABILITIES.forEach(a => {
      const rolls = [1,2,3,4].map(() => Math.ceil(Math.random() * 6));
      const score = rolls.sort((a,b) => b-a).slice(0,3).reduce((s,n) => s+n, 0);
      const el = document.getElementById('ability-' + a);
      if (el) { el.value = score; el.readOnly = false; }
      onAbilityChange(a);
    });
    if (pbEl) pbEl.style.display = 'none';
  } else { // manual
    ABILITIES.forEach(a => { const el = document.getElementById('ability-' + a); if (el) el.readOnly = false; });
    if (pbEl) pbEl.style.display = 'none';
  }
}

function updatePointBuy() {
  let spent = 0;
  ABILITIES.forEach(a => {
    const input = document.getElementById('ability-' + a);
    if (!input) return;
    const v = Math.min(Math.max(parseInt(input.value) || 8, 8), 15);
    const cost = PB_COSTS[v] || 0;
    spent += cost;
    // Color the input border based on cost
    input.style.borderColor = v >= 14 ? '#c9a84c' : v >= 12 ? 'rgba(201,168,76,.4)' : '';
  });
  const el = document.getElementById('point-buy-remaining');
  if (!el) return;
  const remaining = 27 - spent;
  const color = remaining < 0 ? '#e05555' : remaining === 0 ? '#55a055' : 'var(--gold)';
  el.style.color = color;
  el.innerHTML = `Points: <strong>${spent}/27</strong> &nbsp;¬∑&nbsp; Remaining: <strong style="color:${color}">${remaining}</strong>
    ${remaining < 0 ? ' <span style="color:#e05555;font-size:.8rem">‚ö† Over budget!</span>' : ''}
    ${remaining === 0 ? ' <span style="color:#55a055;font-size:.8rem">‚úì Perfect!</span>' : ''}
    <div style="font-size:.75rem;color:var(--parch2);margin-top:4px">Cost: 8=0 ¬∑ 9=1 ¬∑ 10=2 ¬∑ 11=3 ¬∑ 12=4 ¬∑ 13=5 ¬∑ 14=7 ¬∑ 15=9</div>`;
}

function updateDerivedStats() {
  const scores = getScores();
  document.getElementById('c-init-display').textContent = fmod(mod(scores.DEX));
  updateSkillsList();
  updateSavesList();
  updateSpellStats();
  updateEncumbrance();
}

function updateASIList() {
  const cls = document.getElementById('c-class').value;
  const lvl = parseInt(document.getElementById('c-level').value) || 1;
  const el  = document.getElementById('asi-list');
  if (!el) return;
  const asi    = ASI_LEVELS[cls] || [];
  const earned = asi.filter(l => l <= lvl);
  const future = asi.filter(l => l > lvl);
  if (!cls) { el.innerHTML = '<span class="muted">Select a class to see ASI opportunities.</span>'; return; }
  let html = '';
  if (earned.length) html += `<span style="color:var(--gold)">‚úì Earned (${earned.length}): Levels ${earned.join(', ')}</span>`;
  if (future.length) html += `${earned.length ? ' &nbsp;|&nbsp; ' : ''}<span class="muted">Next ASI at level ${future[0]}</span>`;
  if (!earned.length && !future.length) html = '<span class="muted">No ASIs found.</span>';
  html += `<div class="muted" style="font-size:.8rem;margin-top:4px">Each ASI: +2 to one ability, or +1/+1 to two, or choose a feat instead.</div>`;
  el.innerHTML = html;
}

/* =============================================================================
   SKILLS & SAVES
============================================================================= */
function buildSkillsList(c) {
  const el = document.getElementById('skills-list');
  if (!el) return;
  el.innerHTML = SKILLS_DATA.map(sk => `
    <div class="skill-row">
      <input type="checkbox" id="skill-${sid(sk.name)}"     onchange="updateSkillsList()">
      <input type="checkbox" id="skill-exp-${sid(sk.name)}" onchange="updateSkillsList()" title="Expertise" style="accent-color:var(--gold2)">
      <span class="prof-dot" id="skilldot-${sid(sk.name)}"></span>
      <span class="skill-name">${sk.name} <small class="muted">(${sk.ab})</small></span>
      <span class="skill-bonus" id="skillbonus-${sid(sk.name)}">+0</span>
    </div>
  `).join('');
  if (c) {
    c.skillProfs && c.skillProfs.forEach(sn => { const cb = document.getElementById('skill-' + sid(sn)); if (cb) cb.checked = true; });
    c.skillExp   && c.skillExp.forEach(sn   => { const cb = document.getElementById('skill-exp-' + sid(sn)); if (cb) cb.checked = true; });
  }
  updateSkillsList();
}

function updateSkillsList() {
  const scores = getScores();
  const lvl    = parseInt(document.getElementById('c-level').value) || 1;
  const p      = pb(lvl);
  SKILLS_DATA.forEach(sk => {
    const id  = sid(sk.name);
    const cb  = document.getElementById('skill-' + id);
    const exp = document.getElementById('skill-exp-' + id);
    const dot = document.getElementById('skilldot-' + id);
    const bon = document.getElementById('skillbonus-' + id);
    if (!cb) return;
    const profMult = (exp && exp.checked) ? 2 : cb.checked ? 1 : 0;
    const total    = mod(scores[sk.ab]) + (profMult * p);
    if (bon) bon.textContent = fmod(total);
    if (dot) dot.className   = 'prof-dot' + (cb.checked ? ' filled' : '');
  });
  updatePassiveScores();
}

function buildSavingThrows(c) {
  const el  = document.getElementById('saving-throws-list');
  if (!el) return;
  el.innerHTML = ABILITIES.map(a => `
    <div class="skill-row">
      <input type="checkbox" id="save-${a}" onchange="updateSavesList()">
      <span class="prof-dot" id="savedot-${a}"></span>
      <span class="skill-name">${ABILITY_NAMES[a]}</span>
      <span class="skill-bonus" id="savebonus-${a}">+0</span>
    </div>
  `).join('');
  const cls       = document.getElementById('c-class').value;
  const cd        = CLASS_DATA[cls];
  const classSaves = cd ? cd.saves : [];
  if (c && c.saveProfs) ABILITIES.forEach(a => { const cb = document.getElementById('save-' + a); if (cb) cb.checked = c.saveProfs.includes(a); });
  else classSaves.forEach(a => { const cb = document.getElementById('save-' + a); if (cb) cb.checked = true; });
  updateSavesList();
}

function updateSavesList() {
  const scores = getScores();
  const lvl    = parseInt(document.getElementById('c-level').value) || 1;
  const p      = pb(lvl);
  ABILITIES.forEach(a => {
    const cb  = document.getElementById('save-' + a);
    const dot = document.getElementById('savedot-' + a);
    const bon = document.getElementById('savebonus-' + a);
    if (!cb) return;
    const total = mod(scores[a]) + (cb.checked ? p : 0);
    if (bon) bon.textContent = fmod(total);
    if (dot) dot.className   = 'prof-dot' + (cb.checked ? ' filled' : '');
  });
}

function updatePassiveScores() {
  const scores  = getScores();
  const lvl     = parseInt(document.getElementById('c-level').value) || 1;
  const p       = pb(lvl);
  const percCb  = document.getElementById('skill-Perception');
  const invCb   = document.getElementById('skill-Investigation');
  const insCb   = document.getElementById('skill-Insight');
  const percProf = percCb && percCb.checked ? p : 0;
  const invProf  = invCb  && invCb.checked  ? p : 0;
  const insProf  = insCb  && insCb.checked  ? p : 0;
  const el = document.getElementById('passive-scores');
  if (el) el.innerHTML =
    `Passive Perception: <strong>${10 + mod(scores.WIS) + percProf}</strong> &nbsp;|&nbsp; ` +
    `Passive Investigation: <strong>${10 + mod(scores.INT) + invProf}</strong> &nbsp;|&nbsp; ` +
    `Passive Insight: <strong>${10 + mod(scores.WIS) + insProf}</strong>`;
}

/* =============================================================================
   ATTACKS
============================================================================= */
function addAttack() {
  attackList.push({ name:'', bonus:'+0', dmg:'1d6', type:'Slashing' });
  renderAttacks();
}

function renderAttacks() {
  const el = document.getElementById('attack-list');
  if (!el) return;
  el.innerHTML = attackList.map((a, i) => `
    <div class="attack-row">
      <input type="text"  value="${a.name}"  placeholder="Longsword"  style="margin:0;padding:5px" oninput="attackList[${i}].name=this.value">
      <input type="text"  value="${a.bonus}" style="margin:0;padding:5px;width:100%"               oninput="attackList[${i}].bonus=this.value">
      <input type="text"  value="${a.dmg}"   style="margin:0;padding:5px;width:100%"               oninput="attackList[${i}].dmg=this.value">
      <input type="text"  value="${a.type}"  style="margin:0;padding:5px;width:100%"               oninput="attackList[${i}].type=this.value">
      <button class="btn btn-red btn-sm" onclick="attackList.splice(${i},1);renderAttacks()">‚úï</button>
    </div>
  `).join('');
}

/* =============================================================================
   REST
============================================================================= */
function shortRest() {
  const hitdie = document.getElementById('c-hitdie')?.value || '8';
  const remain = parseInt(document.getElementById('c-hitdice-remain')?.value) || 0;
  const con    = mod(getScores().CON);
  if (remain <= 0) { document.getElementById('rest-msg').textContent = 'No hit dice remaining!'; return; }
  const roll  = Math.ceil(Math.random() * parseInt(hitdie)) + Math.max(con, 0);
  const cur   = parseInt(document.getElementById('c-curhp').value) || 0;
  const max   = parseInt(document.getElementById('c-maxhp').value) || 0;
  const newHp = Math.min(cur + roll, max);
  document.getElementById('c-curhp').value         = newHp;
  document.getElementById('c-hitdice-remain').value = remain - 1;
  updateHP();
  // Warlock regains pact slots on short rest
  const cls = document.getElementById('c-class').value;
  if (CLASS_DATA[cls]?.isPact) buildSpellSlotUI();
  document.getElementById('rest-msg').textContent =
    `Short rest: Spent 1d${hitdie}+${Math.max(con,0)} = ${roll} HP recovered. Now at ${newHp}/${max} HP.`;
}


function setConcentration(spellName) {
  const el = document.getElementById('c-concentration');
  if (el) { el.value = spellName; }
}
function longRest() {
  const max = parseInt(document.getElementById('c-maxhp').value) || 0;
  const lvl = parseInt(document.getElementById('c-level').value) || 1;
  document.getElementById('c-curhp').value          = max;
  document.getElementById('c-hitdice-remain').value = Math.ceil(lvl / 2);
  deathSuccesses = 0;
  deathFailures  = 0;
  buildDeathSaves();
  spellSlots = {};
  buildSpellSlotUI();
  updateHP();
  // Clear concentration on long rest
  const concEl = document.getElementById('c-concentration');
  if (concEl && concEl.value) concEl.value = '';
  // Remove conditions that end on long rest (not petrified/exhaustion)
  const clearOnRest = ['Blinded','Charmed','Frightened','Grappled','Incapacitated','Invisible','Paralyzed','Poisoned','Prone','Restrained','Stunned'];
  activeConditions = activeConditions.filter(c => !clearOnRest.includes(c));
  renderConditionTracker();
  document.getElementById('rest-msg').textContent = 'Long rest complete! HP, spell slots, hit dice, and conditions restored.';
}

/* =============================================================================
   SPELL SLOTS
============================================================================= */
function buildSpellSlotUI(c) {
  const lvl = parseInt(document.getElementById('c-level')?.value) || 1;
  const cls = document.getElementById('c-class')?.value;
  const cd  = CLASS_DATA[cls];
  const el  = document.getElementById('spell-slots-ui');
  if (!el) return;
  if (!cd || !cd.spellAb) { el.innerHTML = '<span class="muted">No spellcasting for selected class.</span>'; return; }

  if (cd.isPact) {
    const numSlots = WARLOCK_SLOTS[Math.min(lvl,20)] || [0];
    const slotLvl  = WARLOCK_SLOT_LEVEL[Math.min(lvl,20)] || 1;
    const used     = spellSlots[1]?.used || 0;
    const total    = numSlots[0];
    el.innerHTML = `<div class="slot-row">
      <span style="font-family:'Cinzel',serif;font-size:.8rem;color:var(--gold2);min-width:120px">Pact Slots (lvl ${slotLvl})</span>
      ${Array(total).fill(0).map((_,p) => `<div class="slot-pip ${p < total-used?'avail':'used'}" onclick="togglePactSlot(${p+1},${total})"></div>`).join('')}
      <span class="muted" style="margin-left:6px;font-size:.82rem">${total-used}/${total} (regain on short rest)</span>
    </div>`;
    return;
  }

  const slotsArr = SPELL_SLOTS[Math.min(lvl,20)] || [];
  if (!slotsArr.length) { el.innerHTML = '<span class="muted">No spell slots at this level.</span>'; return; }
  if (!Object.keys(spellSlots).length && c && c.spellSlots) Object.assign(spellSlots, c.spellSlots);
  slotsArr.forEach((n,i) => { if (!spellSlots[i+1]) spellSlots[i+1] = {total:n, used:0}; });
  el.innerHTML = slotsArr.map((n,i) => {
    const lvlNum = i + 1;
    const used   = spellSlots[lvlNum]?.used || 0;
    return `<div class="slot-row">
      <span style="font-family:'Cinzel',serif;font-size:.78rem;color:var(--gold2);min-width:60px">Level ${lvlNum}</span>
      ${Array(n).fill(0).map((_,p) => `<div class="slot-pip ${p<n-used?'avail':'used'}" onclick="toggleSlot(${lvlNum},${p+1},${n})"></div>`).join('')}
      <span class="muted" style="margin-left:6px;font-size:.8rem">${n-used}/${n}</span>
    </div>`;
  }).join('');
}

function toggleSlot(lvl, pip, total) {
  if (!spellSlots[lvl]) spellSlots[lvl] = {total, used:0};
  const s = spellSlots[lvl];
  s.used  = pip <= total - s.used ? total - pip + 1 : Math.max(0, s.used - 1);
  s.used  = Math.min(s.used, total);
  buildSpellSlotUI();
}

function togglePactSlot(pip, total) {
  if (!spellSlots[1]) spellSlots[1] = {total, used:0};
  const s = spellSlots[1];
  s.used  = pip <= total - s.used ? total - pip + 1 : Math.max(0, s.used - 1);
  s.used  = Math.min(s.used, total);
  buildSpellSlotUI();
}

function updateSpellStats() {
  const ability = document.getElementById('c-spell-ability')?.value;
  const scores  = getScores();
  const lvl     = parseInt(document.getElementById('c-level')?.value) || 1;
  const p       = pb(lvl);
  const dcEl    = document.getElementById('spell-dc');
  const atkEl   = document.getElementById('spell-atk');
  if (!ability || !scores[ability]) {
    if (dcEl) dcEl.textContent = '‚Äî';
    if (atkEl) atkEl.textContent = '‚Äî';
    return;
  }
  const m = mod(scores[ability]);
  if (dcEl)  dcEl.textContent  = 8 + p + m;
  if (atkEl) atkEl.textContent = fmod(p + m);
}

/* =============================================================================
   SPELLS
============================================================================= */
function openAddSpell(lvl) {
  document.getElementById('new-spell-level').value = lvl;
  ['new-spell-name','new-spell-cast','new-spell-range','new-spell-comp',
   'new-spell-dur','new-spell-dmg','new-spell-save','new-spell-desc'].forEach(id => {
    const el = document.getElementById(id); if (el) el.value = '';
  });
  openModal('spell-modal');
}

function saveSpell() {
  const name = document.getElementById('new-spell-name').value.trim();
  if (!name) return;
  customSpells.push({
    name, level: parseInt(document.getElementById('new-spell-level').value) || 0,
    school:      document.getElementById('new-spell-school').value,
    castTime:    document.getElementById('new-spell-cast').value,
    range:       document.getElementById('new-spell-range').value,
    components:  document.getElementById('new-spell-comp').value,
    duration:    document.getElementById('new-spell-dur').value,
    damage:      document.getElementById('new-spell-dmg').value,
    save:        document.getElementById('new-spell-save').value,
    concentration: document.getElementById('new-spell-conc').value,
    ritual:      document.getElementById('new-spell-ritual').value,
    desc:        document.getElementById('new-spell-desc').value
  });
  closeModal('spell-modal');
  renderSpellList();
}


/* =============================================================================
   HP AUTO-CALCULATOR
============================================================================= */
function autoCalcHP() {
  const cls = document.getElementById('c-class')?.value;
  const lvl = parseInt(document.getElementById('c-level')?.value) || 1;
  const cd  = CLASS_DATA[cls];
  if (!cd) { document.getElementById('hp-calc-hint').textContent = 'Select a class first.'; return; }
  const scores = getScores();
  const conMod = mod(scores.CON || 10);
  // Level 1: max hit die + CON. Higher levels: average (rounded up) + CON each level
  const avgPerLevel = Math.floor(cd.hd / 2) + 1;
  const maxHP = cd.hd + conMod + (lvl - 1) * (avgPerLevel + conMod);
  document.getElementById('c-maxhp').value = Math.max(1, maxHP);
  document.getElementById('c-curhp').value = Math.max(1, maxHP);
  document.getElementById('hp-calc-hint').textContent =
    `d${cd.hd} class die + ${conMod >= 0 ? '+' : ''}${conMod} CON √ó ${lvl} levels = ${maxHP} HP`;
  updateHP();
}

/* =============================================================================
   INITIATIVE ROLLER
============================================================================= */
function rollInitiative() {
  const scores = getScores();
  const dexMod = mod(scores.DEX || 10);
  const roll   = Math.ceil(Math.random() * 20);
  const total  = roll + dexMod;
  const el     = document.getElementById('c-init-display');
  if (el) el.textContent = (total >= 0 ? '+' : '') + total;
  // Also log to dice roller history if it exists
  showRoll('Initiative', [roll], total);
}

/* =============================================================================
   CONDITIONS TRACKER
============================================================================= */
const CONDITION_NAMES = [
  'Blinded','Charmed','Deafened','Exhausted','Frightened',
  'Grappled','Incapacitated','Invisible','Paralyzed','Petrified',
  'Poisoned','Prone','Restrained','Stunned','Unconscious'
];
const CONDITION_SHORT = {
  'Blinded':       'Auto-fail sight checks. Attacks against you have adv, yours have disadv.',
  'Charmed':       "Can't attack charmer. Charmer has adv on social checks vs you.",
  'Deafened':      'Auto-fail hearing checks.',
  'Exhausted':     'Level 1: disadv checks. 2: speed halved. 3: disadv attacks/saves. 4: HP max halved. 5: speed 0. 6: death.',
  'Frightened':    'Disadv on checks/attacks while source visible. Cannot move toward source.',
  'Grappled':      'Speed = 0. Ends if grappler is incapacitated.',
  'Incapacitated': "Can't take actions or reactions.",
  'Invisible':     'Can\'t be seen. Adv on attacks, attacks against you have disadv.',
  'Paralyzed':     'Incapacitated. Auto-fail STR/DEX saves. Attacks have adv, hits are crits if within 5ft.',
  'Petrified':     'Transformed to stone. Incapacitated. Adv attacks against you. Resist all damage. Immune to poison/disease.',
  'Poisoned':      'Disadv on attack rolls and ability checks.',
  'Prone':         'Disadv on attacks. Attacks vs you have adv if attacker within 5ft, else disadv. Move costs double to stand.',
  'Restrained':    'Speed = 0. Disadv on attacks. Attacks vs you have adv. Disadv on DEX saves.',
  'Stunned':       'Incapacitated. Auto-fail STR/DEX saves. Attacks against you have adv.',
  'Unconscious':   'Incapacitated, drop everything, fall prone. Auto-fail STR/DEX saves. Attacks have adv, hits within 5ft are crits.'
};

function buildConditionTracker(c) {
  if (c && c.activeConditions) activeConditions = [...c.activeConditions];
  renderConditionTracker();
}

function renderConditionTracker() {
  const el = document.getElementById('condition-tracker');
  if (!el) return;
  el.innerHTML = CONDITION_NAMES.map(cn => {
    const active = activeConditions.includes(cn);
    return `<button onclick="toggleCondition('${cn}')"
      style="padding:4px 10px;border:1px solid ${active ? '#e05555' : 'rgba(201,168,76,.35)'};
      background:${active ? 'rgba(139,32,32,.5)' : 'transparent'};
      color:${active ? '#ffaaaa' : 'var(--parch2)'};
      font-family:'Cinzel',serif;font-size:.72rem;cursor:pointer;border-radius:2px;transition:.15s"
      onmouseenter="showConditionDetail('${cn}')"
      onmouseleave="document.getElementById('condition-detail').textContent=''"
    >${active ? '‚ö† ' : ''}${cn}</button>`;
  }).join('');
}

function toggleCondition(name) {
  const idx = activeConditions.indexOf(name);
  if (idx >= 0) activeConditions.splice(idx, 1);
  else activeConditions.push(name);
  renderConditionTracker();
}

function showConditionDetail(name) {
  const el = document.getElementById('condition-detail');
  if (el) el.textContent = CONDITION_SHORT[name] || '';
}

/* =============================================================================
   XP TRACKER
============================================================================= */
const XP_THRESHOLDS = [0,300,900,2700,6500,14000,23000,34000,48000,64000,85000,100000,120000,140000,165000,195000,225000,265000,305000,355000];

function renderXPBar(c) {
  const lvl = c.level || 1;
  const xp  = c.xp    || 0;
  if (lvl >= 20) return '';
  const curr = XP_THRESHOLDS[lvl - 1] || 0;
  const next  = XP_THRESHOLDS[lvl]     || XP_THRESHOLDS[19];
  const pct   = Math.min(100, Math.round(((xp - curr) / (next - curr)) * 100));
  return `<div style="margin-top:5px">
    <div style="display:flex;justify-content:space-between;font-size:.75rem;color:var(--parch2);font-family:'Cinzel',serif;margin-bottom:3px">
      <span>XP: ${xp.toLocaleString()}</span>
      <span>Next Lvl: ${next.toLocaleString()}</span>
    </div>
    <div style="background:var(--dark4);height:5px;border-radius:2px;overflow:hidden">
      <div style="background:var(--gold);height:100%;width:${pct}%;transition:width .4s"></div>
    </div>
  </div>`;
}

/* =============================================================================
   EXPORT / IMPORT CHARACTERS
============================================================================= */
function exportCharacters() {
  const data = getUserData();
  if (!data.characters.length) { alert('No characters to export.'); return; }
  const json = JSON.stringify({ tavernLedger: true, version: 2, characters: data.characters }, null, 2);
  const blob = new Blob([json], { type: 'application/json' });
  const url  = URL.createObjectURL(blob);
  const a    = document.createElement('a');
  a.href     = url;
  a.download = `tavern-ledger-${currentUser}-${new Date().toISOString().slice(0,10)}.json`;
  a.click();
  URL.revokeObjectURL(url);
}

function importCharacters(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    try {
      const parsed = JSON.parse(e.target.result);
      const chars  = parsed.characters || (Array.isArray(parsed) ? parsed : null);
      if (!chars) { alert('Invalid file format.'); return; }
      const data = getUserData();
      // Avoid duplicates by ID
      const existingIds = new Set(data.characters.map(c => c.id));
      let added = 0;
      chars.forEach(c => {
        if (!existingIds.has(c.id)) { data.characters.push(c); added++; }
      });
      saveUserData(data);
      renderCharList();
      alert(`Imported ${added} character(s). ${chars.length - added} skipped (already exist).`);
    } catch(err) {
      alert('Failed to parse file: ' + err.message);
    }
    event.target.value = '';
  };
  reader.readAsText(file);
}

/* =============================================================================
   SPELL SEARCH FILTER (extends renderSpellList)
============================================================================= */
function renderSpellList() {
  const el = document.getElementById('spell-list');
  if (!el) return;
  const searchEl = document.getElementById('spell-search');
  const query = searchEl ? searchEl.value.toLowerCase().trim() : '';
  const byLevel = {};
  customSpells.forEach((s, i) => {
    if (query && !s.name.toLowerCase().includes(query) && !(s.school||'').toLowerCase().includes(query) && !(s.desc||'').toLowerCase().includes(query)) return;
    if (!byLevel[s.level]) byLevel[s.level] = [];
    byLevel[s.level].push({ ...s, idx: i });
  });
  if (!Object.keys(byLevel).length) {
    el.innerHTML = query ? `<div class="muted">No spells match "${query}"</div>` : '<div class="muted">No spells added yet.</div>';
    return;
  }
  el.innerHTML = Object.keys(byLevel).sort((a,b) => a-b).map(lvl => `
    <div style="margin-bottom:10px">
      <div class="section-h" style="margin:8px 0 6px">${lvl==='0' ? 'Cantrips' : 'Level ' + lvl + ' Spells'}</div>
      ${byLevel[lvl].map(s => `
        <div class="spell-item">
          <div class="spell-header" onclick="this.nextElementSibling.classList.toggle('open')">
            <span class="spell-name">${s.name}${s.ritual==='yes' ? ' (R)' : ''}</span>
            <span style="display:flex;align-items:center;gap:6px">
              ${s.concentration==='yes' ? `<span class="conc-badge" style="cursor:pointer" onclick="event.stopPropagation();setConcentration('${s.name}')" title="Click to concentrate on this spell">Conc</span>` : ''}
              <span class="muted" style="font-size:.8rem">${s.school}</span>
              <button class="btn btn-red btn-sm" onclick="event.stopPropagation();customSpells.splice(${s.idx},1);renderSpellList()">‚úï</button>
            </span>
          </div>
          <div class="spell-body">
            <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:5px;font-size:.84rem;margin-bottom:6px">
              ${s.castTime   ? `<span><b>Cast:</b> ${s.castTime}</span>`      : ''}
              ${s.range      ? `<span><b>Range:</b> ${s.range}</span>`         : ''}
              ${s.duration   ? `<span><b>Duration:</b> ${s.duration}</span>`   : ''}
              ${s.components ? `<span><b>Components:</b> ${s.components}</span>`: ''}
              ${s.damage     ? `<span><b>Damage:</b> ${s.damage}</span>`       : ''}
              ${s.save       ? `<span><b>Save:</b> ${s.save}</span>`           : ''}
            </div>
            ${s.desc ? `<p style="font-size:.86rem;color:var(--parch2)">${s.desc}</p>` : ''}
          </div>
        </div>
      `).join('')}
    </div>
  `).join('');
}

/* =============================================================================
   EQUIPMENT & CURRENCY
============================================================================= */
function addEquipItem() {
  const name = document.getElementById('new-equip-name').value.trim();
  if (!name) return;
  customEquip.push({
    name,
    qty:  parseInt(document.getElementById('new-equip-qty').value) || 1,
    wt:   parseFloat(document.getElementById('new-equip-wt').value) || 0,
    note: document.getElementById('new-equip-note').value
  });
  document.getElementById('new-equip-name').value = '';
  document.getElementById('new-equip-note').value = '';
  renderEquipList();
}

function renderEquipList() {
  const el = document.getElementById('equip-list');
  if (!el) return;
  let total = 0;
  el.innerHTML = customEquip.map((item, i) => {
    total += item.wt * item.qty;
    return `
      <div class="equip-row">
        <span class="equip-name">${item.name}${item.note ? ` <small class="muted">(${item.note})</small>` : ''}</span>
        <input type="number" class="equip-qty" value="${item.qty}" min="1"
               oninput="customEquip[${i}].qty=parseInt(this.value)||1;renderEquipList()">
        <span style="min-width:40px;text-align:right;color:var(--parch2);font-size:.88rem">${item.wt}lb</span>
        <button class="btn btn-red btn-sm" onclick="customEquip.splice(${i},1);renderEquipList()">‚úï</button>
      </div>
    `;
  }).join('');
  document.getElementById('total-weight').textContent = total.toFixed(1);
  updateCurrency();
  updateEncumbrance(total);
}

function updateCurrency() {
  const cp = parseInt(document.getElementById('c-cp')?.value) || 0;
  const sp = parseInt(document.getElementById('c-sp')?.value) || 0;
  const ep = parseInt(document.getElementById('c-ep')?.value) || 0;
  const gp = parseInt(document.getElementById('c-gp')?.value) || 0;
  const pp = parseInt(document.getElementById('c-pp')?.value) || 0;
  const el = document.getElementById('total-gp');
  if (el) el.textContent = ((cp/100) + (sp/10) + (ep/2) + gp + (pp*10)).toFixed(2);
}

function updateEncumbrance(wt) {
  const scores = getScores();
  const str    = scores.STR || 10;
  const carry  = str * 15;
  const capEl  = document.getElementById('carry-cap');
  if (capEl) capEl.textContent = carry + ' lbs';
  const statEl = document.getElementById('encumbrance-status');
  if (!statEl || wt === undefined) return;
  if (wt > str * 15)      { statEl.textContent = '‚ö† Heavily Encumbered (speed ‚àí20, disadv STR/DEX/CON)'; statEl.style.color = '#e05555'; }
  else if (wt > str * 10) { statEl.textContent = '‚ö† Encumbered (speed ‚àí10)'; statEl.style.color = '#e05555'; }
  else                    { statEl.textContent = '‚úì Not encumbered'; statEl.style.color = '#55a055'; }
}

/* =============================================================================
   FEATURES & FEATS
============================================================================= */
const FEATS_INFO = {
  'Alert':'+5 to initiative. Cannot be surprised. Hidden attackers get no advantage.',
  'Actor':'Advantage on Deception/Performance when impersonating. Mimic voices. +1 CHA.',
  'Athlete':'Reduce prone cost to 5ft. Climb at normal speed. Running jump from 5ft. +1 STR or DEX.',
  'Charger':'Dash then bonus attack (+5 damage or shove 10ft).',
  'Crossbow Expert':'No loading penalty. No disadvantage at 5ft. Bonus off-hand crossbow attack.',
  'Defensive Duelist':'Reaction +PB to AC when hit with finesse weapon. Requires DEX 13.',
  'Dual Wielder':'+1 AC dual wielding. Use non-light weapons. Draw two weapons at once.',
  'Dungeon Delver':'Advantage on traps/secret doors. Resistance to trap damage. No slow in difficult terrain (dungeons).',
  'Durable':'Min roll = 2√óCON on hit dice. +1 CON.',
  'Elemental Adept':'Ignore resistance to chosen damage type. 1s count as 2s on damage dice.',
  'Grappler':'Advantage on attacks vs grappled creature. Pin (restrain) a grappled creature.',
  'Great Weapon Master':'‚àí5 attack/+10 damage. Bonus attack on crit or kill.',
  'Healer':'Stabilize with 1 HP via healer\'s kit. Healer\'s kit restore 1d6+4+HD HP (1/creature/rest).',
  'Heavily Armored':'Heavy armor proficiency. +1 STR. Requires medium armor prof.',
  'Heavy Armor Master':'Reduce B/P/S damage by 3 while in heavy armor. +1 STR.',
  'Inspiring Leader':'10min speech grants temp HP = level+CHA to up to 6 allies.',
  'Keen Mind':'+1 INT. Remember north. Recall events up to 1 month back. Know time without a clock.',
  'Lightly Armored':'Light armor proficiency. +1 STR or DEX.',
  'Linguist':'+1 INT. Learn 3 languages. Create ciphers.',
  'Lucky':'3 luck points/day. Spend to reroll d20 on attack/check/save, or to force enemy reroll.',
  'Mage Slayer':'Reaction attack when near creature casting spell. Target has disadv on concentration. Advantage on saves vs nearby spell-casters.',
  'Magic Initiate':'Learn 2 cantrips + 1 1st-level spell (1/day) from Bard/Cleric/Druid/Sorcerer/Warlock/Wizard list.',
  'Martial Adept':'One Superiority Die (d6). Two Battle Master maneuvers.',
  'Medium Armor Master':'No disadvantage on Stealth in medium armor. Max +3 DEX to AC.',
  'Mobile':'+10 speed. Dash ignores difficult terrain. No OA vs creatures you attack.',
  'Moderately Armored':'Medium armor + shield proficiency. +1 STR or DEX.',
  'Mounted Combatant':'Advantage on melee vs unmounted smaller creatures. Redirect attacks to mount. Evasion for mount.',
  'Observant':'Read lips. +5 passive Perception/Investigation. +1 INT or WIS.',
  'Polearm Master':'Bonus attack with butt end (d4). Opportunity attack when entering reach.',
  'Resilient':'Proficiency in chosen saving throw. +1 to that ability.',
  'Ritual Caster':'Learn 2 ritual spells. Can add more ritual spells found.',
  'Savage Attacker':'Once per turn reroll weapon damage dice and use higher result.',
  'Sentinel':'OA stops movement. React to attack adjacent ally. Difficult terrain when hit.',
  'Sharpshooter':'Ignore half/3/4 cover. No disadvantage at long range. ‚àí5 attack/+10 damage.',
  'Shield Master':'Shove as bonus action. Add shield AC to DEX saves. Evasion with shield.',
  'Skilled':'Proficiency in 3 skills or tools of choice.',
  'Skulker':'Hide when lightly obscured. No reveal on missed ranged attack. No disadv in dim light.',
  'Spell Sniper':'Double range on attack spells. Ignore half/3-4 cover. One extra attack-roll cantrip.',
  'Tavern Brawler':'+1 STR or CON. Unarmed d4. Improvised weapon proficiency. Grapple as bonus action.',
  'Tough':'+2 HP per level (including past levels).',
  'War Caster':'Advantage on concentration saves. Somatic components with full hands. Reaction spell as OA.',
  'Weapon Master':'Proficiency in 4 weapons. +1 STR or DEX.',
  'Fey Touched':'+1 INT/WIS/CHA. Misty Step 1/day free. One 1st-level divination or enchantment spell 1/day.',
  'Shadow Touched':'+1 INT/WIS/CHA. Invisibility 1/day free. One 1st-level illusion or necromancy spell 1/day.',
  'Skill Expert':'+1 any ability. Proficiency in one skill. Expertise in one skill.',
  'Chef':'+1 CON or WIS. Cook delicious meals that grant temp HP. Short rest treats restore extra HP.',
  'Crusher':'+1 STR or CON. Push target 5ft on bludgeoning hit. Grant advantage to allies on crits.',
  'Piercer':'+1 STR or DEX. Reroll one die on piercing damage. Extra die on crits.',
  'Slasher':'+1 STR or DEX. Reduce speed 10ft on slashing hit. Disadvantage on attacks on crits.',
  'Telekinetic':'+1 INT/WIS/CHA. Mage Hand (invisible). Shove 5ft as bonus action. Telekinetic Shove.',
  'Telepathic':'+1 INT/WIS/CHA. Detect Thoughts 1/day. Telepathy 60ft.',
  'Eldritch Adept':'Learn one Eldritch Invocation. Must be Warlock or have Spellcasting.',
  'Fighting Initiate':'Learn one Fighting Style. Must have proficiency in martial weapons.',
  'Metamagic Adept':'2 Sorcery Points. Two Metamagic options. Must have Spellcasting.',
  'Artificer Initiate':'One artificer cantrip. One 1st-level artificer spell 1/day. Tool proficiency.',
  'Gunner':'+1 DEX. Firearms proficiency. Ignore loading. No disadv at 5ft with firearms.',
  'Poisoner':'Ignore poison resistance. Craft bonus action contact poison (2d8 for 1 min). Poisoner\'s kit proficiency.',
  'Bountiful Luck':'When ally rolls 1, use your Lucky reaction to let them reroll. Requires Halfling.',
  'Dragon Fear':'Breath weapon becomes frightening roar (WIS save). +1 STR/CON/CHA. Requires Dragonborn.',
  'Dragon Hide':'Natural armor 13+DEX. Retractable claws 1d4. +1 STR/CON/CHA. Requires Dragonborn.',
  'Elven Accuracy':'+1 INT/WIS/CHA/DEX. Triple advantage (reroll twice) on attacks when you have advantage. Requires Elf or Half-Elf.',
  'Fade Away':'+1 INT or DEX. Reaction to become invisible for 1 round when damaged. Requires Gnome.',
  'Fey Teleportation':'+1 INT or CHA. Misty Step 1/rest. Elvish language. Requires High Elf.',
  'Infernal Constitution':'+1 CON. Resist cold and poison. Adv on saves vs poison. Requires Tiefling.',
  'Orcish Fury':'+1 STR or CON. +1 die weapon damage 1/rest. Reaction attack when dropped to 0 HP. Requires Orc or Half-Orc.',
  'Prodigy':'One skill expertise, one tool prof, one language. Requires Human, Half-Elf, or Half-Orc.',
  'Second Chance':'+1 DEX/CON/CHA. Reaction to force reroll of hit against you 1/rest. Requires Halfling.',
  'Squat Nimbleness':'+1 STR or DEX. +5 speed. Proficiency in Athletics or Acrobatics. Move through large creatures. Requires Dwarf, Halfling, or Small race.',
  'Wood Elf Magic':'Druidcraft cantrip + Longstrider and Pass Without Trace 1/rest. Requires Wood Elf.',
};

function populateFeatPicker() {
  const sel = document.getElementById('feat-picker');
  if (!sel) return;
  sel.innerHTML = '<option value="">‚Äî Add a Feat ‚Äî</option>' + FEATS_LIST.map(f => {
    const info = FEATS_INFO[f] ? FEATS_INFO[f].replace(/"/g,"'") : '';
    return `<option value="${f}" title="${info}">${f}${info?' ‚ú¶':''}</option>`;
  }).join('');
}

function showFeatInfo() {
  const sel = document.getElementById('feat-picker');
  const v = sel.value;
  let el = document.getElementById('feat-picker-info');
  if (!el) {
    el = document.createElement('div');
    el.id = 'feat-picker-info';
    el.style.cssText = 'font-size:.84rem;color:var(--parch2);background:var(--dark3);border:1px solid rgba(201,168,76,.2);padding:6px 10px;border-radius:2px;margin-top:-10px;margin-bottom:10px';
    sel.parentElement.parentElement.insertBefore(el, sel.parentElement.nextSibling);
  }
  const info = FEATS_INFO[v];
  el.innerHTML = v && info ? `<strong style="color:var(--gold2)">${v}:</strong> ${info}` : '';
}

function addFeatFromList() {
  const sel = document.getElementById('feat-picker');
  const v   = sel.value;
  if (!v || selectedFeats.includes(v)) return;
  selectedFeats.push(v);
  sel.selectedIndex = 0;
  const el = document.getElementById('feat-picker-info'); if (el) el.innerHTML = '';
  renderFeatsList();
}

function renderFeatsList() {
  const el = document.getElementById('feats-list');
  if (!el) return;
  el.innerHTML = selectedFeats.map((f, i) => {
    const info = FEATS_INFO[f] || '';
    return `<div class="feature-item">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <span style="font-family:'Cinzel',serif;color:var(--gold2);font-size:.88rem">${f}</span>
        <button class="btn btn-red btn-sm" onclick="selectedFeats.splice(${i},1);renderFeatsList()">‚úï</button>
      </div>
      ${info ? `<div style="font-size:.82rem;color:var(--parch2);margin-top:3px">${info}</div>` : ''}
    </div>`;
  }).join('');
}

function updateBuildSummary() {
  const el  = document.getElementById('build-summary');
  if (!el) return;
  const race = document.getElementById('c-race')?.value;
  const cls  = document.getElementById('c-class')?.value;
  const sub  = document.getElementById('c-subclass')?.value;
  const bg   = document.getElementById('c-background')?.value;
  const lvl  = parseInt(document.getElementById('c-level')?.value) || 1;
  if (!race && !cls) { el.innerHTML = '<span class="muted">Choose a race, class, background and level to see your build summary.</span>'; return; }
  const rd = RACE_DATA[race];
  const cd = CLASS_DATA[cls];
  const bd = BG_DATA[bg];
  const feats = CLASS_FEATURES[cls] || {};
  // Key features at this level
  const keyFeats = [];
  for (let i = 1; i <= lvl; i++) { if (feats[i]) keyFeats.push(...feats[i]); }
  const bonuses = rd ? Object.entries(rd.bonuses).map(([k,v])=>`+${v} ${k}`).join(', ') : '';
  const spellType = cd ? (cd.spellAb ? (cd.isHalf?'Half-caster':cd.isPact?'Pact Magic':'Full caster') : 'Non-caster') : '';
  const profBonus = '+' + (lvl < 5 ? 2 : lvl < 9 ? 3 : lvl < 13 ? 4 : lvl < 17 ? 5 : 6);
  el.innerHTML = `<div style="background:var(--dark3);border:1px solid rgba(201,168,76,.3);padding:10px 14px;border-radius:2px;line-height:1.8">
    <div style="font-family:'Cinzel',serif;color:var(--gold);margin-bottom:6px;font-size:.9rem">
      ${race||'?'} ${cls||'?'}${sub?' ('+sub+')':''} ¬∑ Level ${lvl}${bg?' ¬∑ '+bg:''}
    </div>
    <div style="display:flex;flex-wrap:wrap;gap:14px;font-size:.86rem;margin-bottom:8px">
      ${cd ? `<span>üé≤ <strong>d${cd.hd}</strong> hit die</span>` : ''}
      ${cd ? `<span>üõ° Saves: <strong>${cd.saves.join('+')}</strong></span>` : ''}
      <span>‚öî Proficiency: <strong>${profBonus}</strong></span>
      ${spellType ? `<span>‚ú® ${spellType}${cd?.spellAb?' ('+cd.spellAb+')':''}</span>` : ''}
      ${bonuses ? `<span>üìä Racial: <strong>${bonuses}</strong></span>` : ''}
    </div>
    ${bd ? `<div style="font-size:.84rem;margin-bottom:6px"><strong style="color:var(--gold2)">Background Skills:</strong> ${bd.skills} ¬∑ Feature: ${bd.feature}</div>` : ''}
    ${keyFeats.length ? `<div style="font-size:.82rem;color:var(--parch2)"><strong style="color:var(--gold2)">Class Features:</strong> ${keyFeats.slice(0,6).join(' ¬∑ ')}${keyFeats.length>6?' + '+(keyFeats.length-6)+' more':''}</div>` : ''}
  </div>`;
}

function addCustomFeature() {
  const name = document.getElementById('new-feat-name').value.trim();
  if (!name) return;
  const desc = document.getElementById('new-feat-desc').value.trim();
  customFeatures.push({ name, desc });
  document.getElementById('new-feat-name').value = '';
  document.getElementById('new-feat-desc').value = '';
  renderFeaturesPanel();
}

function renderFeaturesPanel(c) {
  const cls  = document.getElementById('c-class')?.value;
  const sub  = document.getElementById('c-subclass')?.value;
  const lvl  = parseInt(document.getElementById('c-level')?.value) || 1;
  const el   = document.getElementById('features-list');
  const cel  = document.getElementById('custom-features-list');
  if (!el) return;
  const feats = CLASS_FEATURES[cls] || {};
  const items = [];
  for (let i = 1; i <= lvl; i++) {
    if (feats[i]) feats[i].forEach(f => items.push({lvl:i, text:f}));
  }
  el.innerHTML = items.length
    ? items.map(({lvl:l, text:f}) => {
        // Color-code feature types
        const isASI = f === 'ASI';
        const isPath = f.includes('subclass') || f.includes('Archetype') || f.includes('Path Feature') || f.includes('Domain Feature') || f.includes('College Feature') || f.includes('Circle Feature') || f.includes('Patron Feature') || f.includes('Tradition Feature') || f.includes('Oath Feature') || f.includes('Specialist Feature');
        const color = isASI ? 'var(--gold)' : isPath ? '#a0c8ff' : 'var(--parch)';
        return `<div class="feature-item" style="border-left:2px solid ${color};padding-left:8px">
          <div style="display:flex;gap:8px;align-items:baseline">
            <span style="font-family:'Cinzel',serif;font-size:.72rem;color:var(--parch2);min-width:52px">Lvl ${l}</span>
            <span style="color:${color};font-size:.9rem">${f}</span>
          </div>
        </div>`;
      }).join('')
    : '<span class="muted">No features for selected class/level.</span>';
  // Show subclass info reminder
  if (sub && SUBCLASS_INFO[sub]) {
    el.innerHTML += `<div class="feature-item" style="border-left:2px solid var(--gold2);padding-left:8px;margin-top:8px">
      <div style="font-family:'Cinzel',serif;font-size:.72rem;color:var(--gold2);margin-bottom:2px">Subclass: ${sub}</div>
      <div style="color:var(--parch2);font-size:.82rem">${SUBCLASS_INFO[sub]}</div>
    </div>`;
  }
  renderFeatsList();
  if (cel) cel.innerHTML = customFeatures.map((f, i) => `
    <div class="feature-item" style="border-left:2px solid var(--gold);padding-left:8px">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <span style="font-family:'Cinzel',serif;color:var(--gold2);font-size:.88rem">${f.name}</span>
        <button class="btn btn-red btn-sm" style="font-size:.7rem"
                onclick="event.stopPropagation();customFeatures.splice(${i},1);renderFeaturesPanel()">‚úï</button>
      </div>
      <div style="color:var(--parch2);font-size:.84rem;margin-top:2px">${f.desc}</div>
    </div>
  `).join('');
  updateASIList();
}

/* =============================================================================
   DEATH SAVES, HP & INSPIRATION
============================================================================= */
function buildDeathSaves(c) {
  if (c) { deathSuccesses = c.deathSuccesses || 0; deathFailures = c.deathFailures || 0; }
  const se = document.getElementById('death-success');
  const fe = document.getElementById('death-fail');
  if (!se || !fe) return;
  se.innerHTML = [0,1,2].map(i => `<div class="save-pip save-success ${i < deathSuccesses ? 'filled' : ''}" onclick="toggleDeathSave('success',${i})"></div>`).join('');
  fe.innerHTML = [0,1,2].map(i => `<div class="save-pip save-fail ${i < deathFailures ? 'filled' : ''}"    onclick="toggleDeathSave('fail',${i})"></div>`).join('');
}

function toggleDeathSave(type, idx) {
  if (type === 'success') deathSuccesses = deathSuccesses === idx+1 ? idx : idx+1;
  else                    deathFailures  = deathFailures  === idx+1 ? idx : idx+1;
  buildDeathSaves();
}

function updateHP() {
  const max  = parseInt(document.getElementById('c-maxhp')?.value) || 0;
  const cur  = parseInt(document.getElementById('c-curhp')?.value) || 0;
  const fill = document.getElementById('hp-fill');
  if (fill && max > 0) fill.style.width = Math.max(0, Math.min(100, (cur/max)*100)) + '%';
}

function toggleInspiration() {
  inspiration = !inspiration;
  document.getElementById('insp-pip').classList.toggle('active', inspiration);
}

/* =============================================================================
   CREATOR TAB SWITCHING
============================================================================= */
function creatorTab(tab, btn) {
  document.querySelectorAll('#creator-modal .tab-btn').forEach(b => b.classList.remove('active'));
  document.querySelectorAll('#creator-modal .tab-panel').forEach(p => p.classList.remove('active'));
  if (btn) btn.classList.add('active');
  const panel = document.getElementById('creator-' + tab);
  if (panel) panel.classList.add('active');
  // Refresh panels that need live calculation
  if (tab === 'skills')    { buildSkillsList(); updateSkillsList(); updateSavesList(); }
  if (tab === 'spells')    { buildSpellSlotUI(); renderSpellList(); updateSpellStats(); }
  if (tab === 'equipment') { renderEquipList(); }
  if (tab === 'features')  { renderFeaturesPanel(); }
  if (tab === 'combat')    { buildDeathSaves(); renderAttacks(); updateHP(); }
}

/* =============================================================================
   DICE ROLLER
============================================================================= */
function rollDice(sides) {
  const qty    = parseInt(document.getElementById('dice-qty').value) || 1;
  const modVal = parseInt(document.getElementById('dice-mod').value) || 0;
  const rolls  = Array(qty).fill(0).map(() => Math.ceil(Math.random() * sides));
  const total  = rolls.reduce((s,n) => s+n, 0) + modVal;
  showRoll(`${qty}d${sides}${modVal ? fmod(modVal) : ''}`, rolls, total);
}

function showRoll(label, rolls, total) {
  const el = document.getElementById('roll-result');
  el.innerHTML = `
    <span style="font-size:.95rem;color:var(--parch2)">${label}</span>
    <span style="font-size:2.8rem;font-weight:700">${total}</span>
    ${rolls.length > 1 ? `<span style="font-size:.85rem;color:var(--parch2)">[${rolls.join(', ')}]</span>` : ''}`;
  rollHistory.unshift({ label, rolls, total, time: new Date().toLocaleTimeString() });
  if (rollHistory.length > 50) rollHistory.pop();
  renderRollHistory();
}

function renderRollHistory() {
  const el = document.getElementById('roll-history');
  if (!el) return;
  el.innerHTML = rollHistory.map(e =>
    `<div class="roll-entry">
      <strong class="gold">${e.total}</strong> ‚Äî ${e.label}${e.rolls.length > 1 ? ' ['+e.rolls.join(',')+']' : ''}
      <span style="float:right;font-size:.78rem">${e.time}</span>
    </div>`
  ).join('');
}

function clearHistory() { rollHistory = []; renderRollHistory(); }

function quickRoll(label, sides, qty, pick) {
  const rolls = Array(qty).fill(0).map(() => Math.ceil(Math.random() * sides));
  const total = pick === 'high' ? Math.max(...rolls) : pick === 'low' ? Math.min(...rolls) : rolls.reduce((s,n) => s+n, 0);
  showRoll(label, rolls, total);
}

function rollAbilityScores() {
  const sets = Array(6).fill(0).map(() => {
    const r = [1,2,3,4].map(() => Math.ceil(Math.random() * 6));
    return r.sort((a,b) => b-a).slice(0,3).reduce((s,n) => s+n, 0);
  });
  document.getElementById('roll-result').innerHTML = `
    <div style="font-size:.9rem;width:100%">
      <div class="muted" style="margin-bottom:8px">4d6 Drop Lowest</div>
      <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px">
        ${sets.map((v,i) => `
          <div style="text-align:center">
            <div style="font-size:.75rem;color:var(--gold2)">${ABILITIES[i]}</div>
            <div class="gold" style="font-size:1.5rem;font-family:'Cinzel',serif">${v}</div>
          </div>`).join('')}
      </div>
    </div>`;
}

function rollDeathSave() {
  const roll   = Math.ceil(Math.random() * 20);
  const result = roll === 20 ? '‚≠ê Critical Success! Regain 1 HP'
               : roll >= 10  ? '‚úì Success'
               : roll === 1  ? '‚úó‚úó Critical Fail (2 failures)'
               :                '‚úó Failure';
  document.getElementById('roll-result').innerHTML = `
    <span style="font-size:.95rem;color:var(--parch2)">Death Save</span>
    <span style="font-size:2.5rem;font-weight:700">${roll}</span>
    <span style="font-size:.9rem;color:${roll >= 10 ? '#55a055' : '#e05555'}">${result}</span>`;
}

/* =============================================================================
   CAMPAIGNS
============================================================================= */
function renderCampaignList() {
  const data = getUserData();
  const el   = document.getElementById('campaign-list');
  if (!el) return;
  if (!data.campaigns || !data.campaigns.length) {
    el.innerHTML = '<div class="muted" style="padding:20px 0">No campaigns yet. Create one or join with a code!</div>';
    return;
  }
  el.innerHTML = data.campaigns.map(cp => `
    <div class="campaign-card">
      <div class="flex-between" style="flex-wrap:wrap;gap:8px">
        <div>
          <div class="campaign-name">${cp.name} ${cp.joined ? '<span class="badge badge-blue">Joined</span>' : ''}</div>
          <div class="muted">${cp.setting || 'No setting'} ¬∑ DM: ${cp.dm || 'Unknown'}
            ${cp.shareCode ? ` ¬∑ Code: <strong style="color:var(--gold);font-family:'Cinzel',serif;letter-spacing:.1em">${cp.shareCode}</strong>` : ''}
          </div>
        </div>
        <div style="display:flex;gap:6px;flex-wrap:wrap">
          ${!cp.joined ? `<button class="btn btn-outline btn-sm" onclick="showCampaignCode('${cp.id}')">üìã Code</button>` : ''}
          <button class="btn btn-red btn-sm" onclick="deleteCampaign('${cp.id}')">Delete</button>
        </div>
      </div>
      ${cp.desc ? `<p style="margin:8px 0 0;font-size:.9rem;color:var(--parch2)">${cp.desc}</p>` : ''}
      <!-- Campaign Tabs -->
      <div style="display:flex;gap:0;margin-top:14px;border-bottom:1px solid rgba(201,168,76,.2)">
        <button class="cp-tab active" onclick="cpTab('${cp.id}','journal',this)">üìñ Journal</button>
        <button class="cp-tab" onclick="cpTab('${cp.id}','quests',this)">üìú Quests</button>
        <button class="cp-tab" onclick="cpTab('${cp.id}','loot',this)">üí∞ Loot</button>
        <button class="cp-tab" onclick="cpTab('${cp.id}','recaps',this)">üìã Recaps</button>
      </div>
      <!-- Journal Panel -->
      <div id="cp-journal-${cp.id}" class="cp-panel" style="display:block;margin-top:10px">
        ${cp.journal && cp.journal.length ? cp.journal.map(j => `
          <div class="journal-entry">
            <div class="journal-date">${j.date}</div>
            <div style="font-size:.9rem">${j.text}</div>
          </div>`).join('') : '<div class="muted" style="font-size:.85rem">No journal entries yet.</div>'}
        <div style="display:flex;gap:6px;margin-top:8px">
          <textarea id="journal-input-${cp.id}" placeholder="Write a journal entry..." style="flex:1;min-height:50px;margin:0"></textarea>
          <button class="btn btn-gold btn-sm" style="align-self:flex-end" onclick="addJournalEntry('${cp.id}')">Add</button>
        </div>
      </div>
      <!-- Quests Panel -->
      <div id="cp-quests-${cp.id}" class="cp-panel" style="display:none;margin-top:10px">
        <div id="quest-list-${cp.id}">
          ${renderQuestList(cp)}
        </div>
        <div style="display:flex;gap:6px;margin-top:8px;flex-wrap:wrap">
          <input type="text" id="quest-input-${cp.id}" placeholder="Quest name..." style="flex:2;margin:0">
          <select id="quest-status-${cp.id}" style="margin:0;width:110px">
            <option value="active">Active</option>
            <option value="completed">Completed</option>
            <option value="failed">Failed</option>
          </select>
          <input type="text" id="quest-obj-${cp.id}" placeholder="Objective..." style="flex:3;margin:0">
          <button class="btn btn-gold btn-sm" onclick="addQuest('${cp.id}')">Add Quest</button>
        </div>
      </div>
      <!-- Loot Panel -->
      <div id="cp-loot-${cp.id}" class="cp-panel" style="display:none;margin-top:10px">
        <div id="loot-list-${cp.id}">
          ${renderLootList(cp)}
        </div>
        <div style="display:flex;gap:6px;margin-top:8px;flex-wrap:wrap">
          <input type="text" id="loot-input-${cp.id}" placeholder="Item name..." style="flex:2;margin:0">
          <input type="number" id="loot-qty-${cp.id}" placeholder="Qty" value="1" style="width:60px;margin:0">
          <input type="text" id="loot-owner-${cp.id}" placeholder="Holder/Unassigned" style="flex:1;margin:0">
          <button class="btn btn-gold btn-sm" onclick="addLoot('${cp.id}')">Add Loot</button>
        </div>
      </div>
      <!-- Recaps Panel -->
      <div id="cp-recaps-${cp.id}" class="cp-panel" style="display:none;margin-top:10px">
        <div id="recap-list-${cp.id}">
          ${renderRecapList(cp)}
        </div>
        <div style="display:flex;gap:6px;margin-top:8px;flex-wrap:wrap">
          <input type="text" id="recap-session-${cp.id}" placeholder="Session # or name..." style="width:130px;margin:0">
          <textarea id="recap-input-${cp.id}" placeholder="What happened this session..." style="flex:1;min-height:50px;margin:0"></textarea>
          <button class="btn btn-gold btn-sm" style="align-self:flex-end" onclick="addRecap('${cp.id}')">Save Recap</button>
        </div>
      </div>
    </div>
  `).join('');
}

function openNewCampaign() {
  document.getElementById('campaign-modal-title').textContent = 'New Campaign';
  document.getElementById('campaign-modal-body').innerHTML = `
    <label>Campaign Name</label>
    <input type="text" id="new-cp-name" placeholder="The Lost Mine of Phandelver...">
    <label>Setting / World</label>
    <input type="text" id="new-cp-setting" placeholder="Forgotten Realms...">
    <label>DM Name</label>
    <input type="text" id="new-cp-dm" placeholder="Your DM's name...">
    <label>Description</label>
    <textarea id="new-cp-desc" placeholder="Brief campaign summary..."></textarea>
    <div style="text-align:right;margin-top:12px">
      <button class="btn btn-gold" onclick="saveCampaign()">Create Campaign</button>
    </div>`;
  openModal('campaign-modal');
}

function saveCampaign() {
  const name = document.getElementById('new-cp-name').value.trim();
  if (!name) return;
  const data = getUserData();
  data.campaigns = data.campaigns || [];
  const id        = Date.now().toString();
  const shareCode = generateShortCode();
  const cp = {
    id, name, shareCode,
    setting: document.getElementById('new-cp-setting').value,
    dm:      document.getElementById('new-cp-dm').value,
    desc:    document.getElementById('new-cp-desc').value,
    journal: [], joined: false
  };
  // Register the code in the shared lookup
  storeCampaignCode(shareCode, { name: cp.name, setting: cp.setting, dm: cp.dm, desc: cp.desc, journal: cp.journal, sourceId: id });
  data.campaigns.push(cp);
  saveUserData(data);
  closeModal('campaign-modal');
  renderCampaignList();
}

function deleteCampaign(id) {
  if (!confirm('Delete this campaign?')) return;
  const data = getUserData();
  data.campaigns = data.campaigns.filter(c => c.id !== id);
  saveUserData(data);
  renderCampaignList();
}

function addJournalEntry(id) {
  const text = prompt('Journal entry:');
  if (!text) return;
  const data = getUserData();
  const cp   = data.campaigns.find(c => c.id === id);
  if (!cp) return;
  cp.journal = cp.journal || [];
  cp.journal.push({ date: new Date().toLocaleDateString(), text, author: currentUser });
  // Update code registry with latest journal
  if (cp.shareCode) storeCampaignCode(cp.shareCode, { name: cp.name, setting: cp.setting, dm: cp.dm, desc: cp.desc, journal: cp.journal, sourceId: cp.id });
  saveUserData(data);
  renderCampaignList();
}

function showCampaignCode(id) {
  const data = getUserData();
  const cp   = data.campaigns.find(c => c.id === id);
  if (!cp) return;
  const code = cp.shareCode || generateShortCode();
  // Ensure code is stored
  storeCampaignCode(code, { name: cp.name, setting: cp.setting, dm: cp.dm, desc: cp.desc, journal: cp.journal || [], sourceId: cp.id });
  if (!cp.shareCode) { cp.shareCode = code; saveUserData(data); }
  document.getElementById('campaign-modal-title').textContent = 'Campaign Share Code';
  document.getElementById('campaign-modal-body').innerHTML = `
    <p style="color:var(--parch2);margin-bottom:14px;font-size:.92rem">
      Share this 4-character code with your players. They paste it into "Join with Code" to add this campaign.
      <br><small>‚ö† Codes only work on the same browser/device. For cross-device sharing, a hosted backend is required.</small>
    </p>
    <div style="text-align:center;margin:20px 0">
      <div style="font-family:'Cinzel Decorative',serif;font-size:3rem;color:var(--gold);letter-spacing:.3em;text-shadow:0 0 20px rgba(201,168,76,.4)">${code}</div>
      <div class="muted" style="margin-top:6px">Campaign: ${cp.name}</div>
    </div>
    <div style="display:flex;gap:8px;margin-top:12px;justify-content:center;flex-wrap:wrap">
      <button class="btn btn-gold" onclick="copyToClipboard('${code}','copy-confirm')">Copy Code</button>
      <button class="btn btn-outline" onclick="closeModal('campaign-modal')">Close</button>
    </div>
    <div id="copy-confirm" class="muted" style="margin-top:8px;text-align:center;display:none">‚úì Copied to clipboard!</div>`;
  openModal('campaign-modal');
}

function copyToClipboard(text, confirmId) {
  navigator.clipboard.writeText(text)
    .then(() => {
      const el = document.getElementById(confirmId);
      if (el) { el.style.display = 'block'; setTimeout(() => el.style.display = 'none', 2000); }
    })
    .catch(() => {
      const ta = document.createElement('textarea');
      ta.value = text; document.body.appendChild(ta); ta.select(); document.execCommand('copy');
      document.body.removeChild(ta);
    });
}

function openJoinCampaign() {
  document.getElementById('campaign-modal-title').textContent = 'Join a Campaign';
  document.getElementById('campaign-modal-body').innerHTML = `
    <p style="color:var(--parch2);margin-bottom:14px;font-size:.92rem">Enter the 4-character code your DM gave you.</p>
    <div style="text-align:center;margin:20px 0">
      <input type="text" id="join-code-input" maxlength="4"
             placeholder="XXXX" autocomplete="off"
             style="text-align:center;font-family:'Cinzel Decorative',serif;font-size:2.5rem;letter-spacing:.3em;width:180px;text-transform:uppercase">
    </div>
    <div id="join-preview" style="display:none;margin:12px 0">
      <div class="card" style="margin:0">
        <div class="card-title">Campaign Preview</div>
        <div id="join-preview-content"></div>
      </div>
    </div>
    <div id="join-err" class="err" style="display:none">Code not found. Make sure you're on the same device/browser as the DM.</div>
    <div style="display:flex;gap:8px;margin-top:12px;flex-wrap:wrap;justify-content:center">
      <button class="btn btn-outline" onclick="previewJoinCode()">Preview</button>
      <button class="btn btn-gold" id="join-confirm-btn" style="display:none" onclick="confirmJoinCampaign()">Join Campaign</button>
      <button class="btn btn-outline" onclick="closeModal('campaign-modal')">Cancel</button>
    </div>`;
  openModal('campaign-modal');
}

function previewJoinCode() {
  const code = document.getElementById('join-code-input').value.trim().toUpperCase();
  const cp   = lookupCampaignCode(code);
  const errEl     = document.getElementById('join-err');
  const previewEl = document.getElementById('join-preview');
  const confirmBtn= document.getElementById('join-confirm-btn');
  if (!cp) { errEl.style.display = 'block'; previewEl.style.display = 'none'; if (confirmBtn) confirmBtn.style.display = 'none'; return; }
  errEl.style.display = 'none';
  document.getElementById('join-preview-content').innerHTML = `
    <p><strong style="color:var(--gold)">${cp.name}</strong></p>
    <p class="muted">Setting: ${cp.setting || '‚Äî'} ¬∑ DM: ${cp.dm || '‚Äî'}</p>
    ${cp.desc ? `<p style="font-size:.9rem;margin-top:6px">${cp.desc}</p>` : ''}
    ${cp.journal && cp.journal.length ? `<p class="muted" style="margin-top:6px">${cp.journal.length} journal entries included</p>` : ''}`;
  previewEl.style.display = 'block';
  if (confirmBtn) confirmBtn.style.display = 'inline-flex';
}

function confirmJoinCampaign() {
  const code = document.getElementById('join-code-input').value.trim().toUpperCase();
  const cp   = lookupCampaignCode(code);
  if (!cp) return;
  const data = getUserData();
  data.campaigns = data.campaigns || [];
  if (data.campaigns.some(c => c.sourceId === cp.sourceId || c.name === cp.name)) {
    document.getElementById('join-err').textContent = 'You already have this campaign!';
    document.getElementById('join-err').style.display = 'block';
    return;
  }
  data.campaigns.push({ id: Date.now().toString(), name: cp.name, setting: cp.setting, dm: cp.dm, desc: cp.desc, journal: cp.journal || [], joined: true, sourceId: cp.sourceId });
  saveUserData(data);
  closeModal('campaign-modal');
  renderCampaignList();
}

/* =============================================================================
   REFERENCE BUILDER
============================================================================= */

/* =============================================================================
   STATIC DATA ‚Äî WEAPONS & ARMOR TABLES
============================================================================= */
const WEAPONS_TABLE = [
  // Simple Melee
  {n:'Club',          d:'1d4 bludgeoning ¬∑ Light, Simple'},
  {n:'Dagger',        d:'1d4 piercing ¬∑ Finesse, light, thrown (20/60) ¬∑ Simple'},
  {n:'Greatclub',     d:'1d8 bludgeoning ¬∑ Two-handed ¬∑ Simple'},
  {n:'Handaxe',       d:'1d6 slashing ¬∑ Light, thrown (20/60) ¬∑ Simple'},
  {n:'Javelin',       d:'1d6 piercing ¬∑ Thrown (30/120) ¬∑ Simple'},
  {n:'Light Hammer',  d:'1d4 bludgeoning ¬∑ Light, thrown (20/60) ¬∑ Simple'},
  {n:'Mace',          d:'1d6 bludgeoning ¬∑ Simple'},
  {n:'Quarterstaff',  d:'1d6 (1d8 two-handed) bludgeoning ¬∑ Versatile ¬∑ Simple'},
  {n:'Spear',         d:'1d6 (1d8) piercing ¬∑ Thrown (20/60), versatile ¬∑ Simple'},
  {n:'Unarmed Strike',d:'1 + STR modifier bludgeoning'},
  // Simple Ranged
  {n:'Light Crossbow',d:'1d8 piercing ¬∑ Range 80/320, loading, two-handed ¬∑ Simple'},
  {n:'Shortbow',      d:'1d6 piercing ¬∑ Range 80/320, two-handed ¬∑ Simple'},
  {n:'Sling',         d:'1d4 bludgeoning ¬∑ Range 30/120 ¬∑ Simple'},
  // Martial Melee
  {n:'Battleaxe',     d:'1d8 (1d10) slashing ¬∑ Versatile ¬∑ Martial'},
  {n:'Flail',         d:'1d8 bludgeoning ¬∑ Martial'},
  {n:'Glaive',        d:'1d10 slashing ¬∑ Heavy, reach, two-handed ¬∑ Martial'},
  {n:'Greataxe',      d:'1d12 slashing ¬∑ Heavy, two-handed ¬∑ Martial'},
  {n:'Greatsword',    d:'2d6 slashing ¬∑ Heavy, two-handed ¬∑ Martial'},
  {n:'Halberd',       d:'1d10 slashing ¬∑ Heavy, reach, two-handed ¬∑ Martial'},
  {n:'Lance',         d:'1d12 piercing ¬∑ Reach (disadv within 5ft) ¬∑ Martial'},
  {n:'Longsword',     d:'1d8 (1d10) slashing ¬∑ Versatile ¬∑ Martial'},
  {n:'Maul',          d:'2d6 bludgeoning ¬∑ Heavy, two-handed ¬∑ Martial'},
  {n:'Morningstar',   d:'1d8 piercing ¬∑ Martial'},
  {n:'Pike',          d:'1d10 piercing ¬∑ Heavy, reach, two-handed ¬∑ Martial'},
  {n:'Rapier',        d:'1d8 piercing ¬∑ Finesse ¬∑ Martial'},
  {n:'Scimitar',      d:'1d6 slashing ¬∑ Finesse, light ¬∑ Martial'},
  {n:'Shortsword',    d:'1d6 piercing ¬∑ Finesse, light ¬∑ Martial'},
  {n:'Trident',       d:'1d6 (1d8) piercing ¬∑ Thrown (20/60), versatile ¬∑ Martial'},
  {n:'War Pick',      d:'1d8 piercing ¬∑ Martial'},
  {n:'Warhammer',     d:'1d8 (1d10) bludgeoning ¬∑ Versatile ¬∑ Martial'},
  {n:'Whip',          d:'1d4 slashing ¬∑ Finesse, reach ¬∑ Martial'},
  // Martial Ranged
  {n:'Hand Crossbow', d:'1d6 piercing ¬∑ Range 30/120, light, loading ¬∑ Martial'},
  {n:'Heavy Crossbow',d:'1d10 piercing ¬∑ Range 100/400, heavy, loading, two-handed ¬∑ Martial'},
  {n:'Longbow',       d:'1d8 piercing ¬∑ Range 150/600, heavy, two-handed ¬∑ Martial'},
];

const ARMOR_TABLE = [
  {n:'Padded',       d:'AC 11 + DEX ¬∑ Light ¬∑ Stealth disadvantage'},
  {n:'Leather',      d:'AC 11 + DEX ¬∑ Light'},
  {n:'Studded Leather',d:'AC 12 + DEX ¬∑ Light'},
  {n:'Hide',         d:'AC 12 + DEX (max 2) ¬∑ Medium'},
  {n:'Chain Shirt',  d:'AC 13 + DEX (max 2) ¬∑ Medium'},
  {n:'Scale Mail',   d:'AC 14 + DEX (max 2) ¬∑ Medium ¬∑ Stealth disadvantage'},
  {n:'Breastplate',  d:'AC 14 + DEX (max 2) ¬∑ Medium'},
  {n:'Half Plate',   d:'AC 15 + DEX (max 2) ¬∑ Medium ¬∑ Stealth disadvantage'},
  {n:'Ring Mail',    d:'AC 14 ¬∑ Heavy ¬∑ Stealth disadvantage'},
  {n:'Chain Mail',   d:'AC 16 ¬∑ Heavy ¬∑ Stealth disadvantage ¬∑ STR 13 required'},
  {n:'Splint',       d:'AC 17 ¬∑ Heavy ¬∑ Stealth disadvantage ¬∑ STR 15 required'},
  {n:'Plate',        d:'AC 18 ¬∑ Heavy ¬∑ Stealth disadvantage ¬∑ STR 15 required'},
  {n:'Shield',       d:'+2 AC ¬∑ Requires one free hand ¬∑ Cannot use with two-handed weapons'},
  {n:'Unarmored (Barbarian)',d:'10 + DEX + CON modifier'},
  {n:'Unarmored (Monk)',     d:'10 + DEX + WIS modifier'},
  {n:'Natural Armor (Tortle)',d:'17 (base, no DEX bonus)'},
];

function buildReference() {
  const fill = (id, arr) => {
    const el = document.getElementById(id);
    if (!el) return;
    el.innerHTML = arr.map(c => `
      <div class="ref-item">
        <div class="ref-name" onclick="this.nextElementSibling.classList.toggle('open')">${c.n} ‚ñæ</div>
        <div class="ref-desc">${c.d}</div>
      </div>`).join('');
  };
  fill('conditions-list', CONDITIONS);
  fill('actions-list',    COMBAT_ACTIONS);
  fill('cover-list',      COVER_INFO);
  fill('dc-list',         DC_INFO);
  fill('dmg-list',        DMG_TYPES);
  fill('weapons-list',    WEAPONS_TABLE);
  fill('armor-list',      ARMOR_TABLE);
}

/* =============================================================================
   VIEW CHARACTER (printable sheet, opens new window)
============================================================================= */
function viewCharacter(id) {
  const data   = getUserData();
  const c      = data.characters.find(x => x.id === id);
  if (!c) return;
  const scores = c.abilityScores || {};
  const lvl    = c.level || 1;
  const p      = pb(lvl);
  const skillRows = SKILLS_DATA.map(sk => {
    const prof  = c.skillProfs && c.skillProfs.includes(sk.name);
    const exp   = c.skillExp   && c.skillExp.includes(sk.name);
    const bonus = mod(scores[sk.ab] || 10) + (exp ? p*2 : prof ? p : 0);
    return `<tr><td>${exp ? '‚òÖ' : prof ? '‚óè' : '‚óã'}</td><td>${sk.name}</td><td style="text-align:right">${fmod(bonus)}</td></tr>`;
  }).join('');
  const saveRows = ABILITIES.map(a => {
    const prof  = c.saveProfs && c.saveProfs.includes(a);
    const bonus = mod(scores[a] || 10) + (prof ? p : 0);
    return `<tr><td>${prof ? '‚óè' : '‚óã'}</td><td>${ABILITY_NAMES[a]}</td><td style="text-align:right">${fmod(bonus)}</td></tr>`;
  }).join('');
  const win = window.open('', '_blank');
  win.document.write(`<!DOCTYPE html><html><head><title>${c.name} ‚Äî Character Sheet</title>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Crimson+Text:ital,wght@0,400;1,400&display=swap" rel="stylesheet">
  <style>
  *{box-sizing:border-box;margin:0;padding:0;}
  body{font-family:'Crimson Text',serif;background:#f5ead0;color:#1a1000;max-width:960px;margin:0 auto;padding:20px;font-size:15px;}
  h1{font-family:'Cinzel',serif;color:#7a4800;font-size:1.8rem;border-bottom:2px solid #c9a84c;padding-bottom:6px;margin-bottom:6px;}
  h2{font-family:'Cinzel',serif;color:#7a4800;font-size:1rem;margin:14px 0 8px;border-bottom:1px solid #c9a84c66;padding-bottom:4px;}
  .sub{font-style:italic;color:#555;margin-bottom:10px;font-size:.9rem;}
  .grid{display:grid;grid-template-columns:repeat(6,1fr);gap:10px;margin:14px 0;}
  .ab{background:#fff;border:2px solid #c9a84c;padding:8px;text-align:center;}
  .ab .lbl{font-family:'Cinzel',serif;font-size:.6rem;color:#7a4800;}
  .ab .sc{font-size:1.6rem;font-weight:700;}.ab .md{color:#c9a84c;font-size:.88rem;}
  .two-col{display:grid;grid-template-columns:1fr 1fr;gap:14px;}
  .sec{background:#fff;border:1px solid #c9a84c;padding:12px;margin-bottom:12px;}
  table{width:100%;border-collapse:collapse;}
  td{padding:3px 5px;border-bottom:1px solid #c9a84c22;font-size:.88rem;}
  .stats{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin:12px 0;}
  .cs{border:2px solid #c9a84c;padding:8px;text-align:center;background:#fff;}
  .cs .val{font-size:1.4rem;font-family:'Cinzel',serif;}
  .cs .lbl{font-size:.6rem;color:#7a4800;font-family:'Cinzel',serif;}
  @media print{body{max-width:none;padding:10px;}}
  .print-btn{background:#c9a84c;border:none;padding:10px 22px;font-family:'Cinzel',serif;cursor:pointer;font-size:.9rem;margin-bottom:16px;}
  </style></head><body>
  <button class="print-btn" onclick="window.print()">üñ® Print / Save PDF</button>
  <div style="display:flex;gap:14px;align-items:flex-start;margin-bottom:14px">
    <div style="flex:1">
      <h1>${c.name || 'Unnamed'}</h1>
      <div class="sub">
        Level ${lvl} ${c.race||'?'}${c.subrace?' ('+c.subrace+')':''} ${c.cls||'?'}${c.subclass?' ‚Äî '+c.subclass:''}
        ${c.mcClasses&&c.mcClasses.length?' / '+c.mcClasses.map(m=>m.level+' '+m.cls+(m.sub?' ('+m.sub+')':'')).join('/'):''}
        &nbsp;‚Ä¢&nbsp; ${c.background||'No Background'} &nbsp;‚Ä¢&nbsp; ${c.alignment||'Unaligned'}
      </div>
      <div class="sub">XP: ${c.xp||0} &nbsp;‚Ä¢&nbsp; Prof Bonus: ${fmod(p)} &nbsp;‚Ä¢&nbsp; Inspiration: ${c.inspiration?'Yes':'No'} &nbsp;‚Ä¢&nbsp; Exhaustion: ${c.exhaustion||0}</div>
    </div>
    ${c.portrait ? `<img src="${c.portrait}" style="width:80px;height:100px;object-fit:cover;border:2px solid #c9a84c" onerror="this.remove()">` : ''}
  </div>
  <div class="grid">${ABILITIES.map(a=>`<div class="ab"><div class="lbl">${ABILITY_NAMES[a]}</div><div class="sc">${scores[a]||10}</div><div class="md">${fmod(mod(scores[a]||10))}</div></div>`).join('')}</div>
  <div class="stats">
    <div class="cs"><div class="lbl">Armor Class</div><div class="val">${c.ac||10}</div></div>
    <div class="cs"><div class="lbl">Initiative</div><div class="val">${fmod(mod(scores.DEX||10))}</div></div>
    <div class="cs"><div class="lbl">Speed</div><div class="val">${c.speed||30}ft</div></div>
    <div class="cs"><div class="lbl">HP</div><div class="val" style="font-size:1rem">${c.curhp||0}<span style="font-size:.7rem;color:#7a4800">/${c.maxhp||0}</span></div></div>
  </div>
  <div class="two-col">
    <div>
      <div class="sec"><h2>Saving Throws</h2><table>${saveRows}</table></div>
      <div class="sec"><h2>Skills</h2><table>${skillRows}</table></div>
    </div>
    <div>
      ${c.languages||c.profs?`<div class="sec"><h2>Proficiencies & Languages</h2>${c.languages?`<p><b>Languages:</b> ${c.languages}</p>`:''}${c.profs?`<p><b>Tools/Weapons:</b> ${c.profs}</p>`:''}</div>`:''}
      ${c.attacks&&c.attacks.length?`<div class="sec"><h2>Attacks</h2><table><tr style="font-size:.75rem;color:#7a4800"><td>Name</td><td>Bonus</td><td>Damage</td><td>Type</td></tr>${c.attacks.map(a=>`<tr><td>${a.name}</td><td>${a.bonus}</td><td>${a.dmg}</td><td>${a.type}</td></tr>`).join('')}</table></div>`:''}
      ${c.feats&&c.feats.length?`<div class="sec"><h2>Feats</h2>${c.feats.map(f=>`<div>‚Ä¢ ${f}</div>`).join('')}</div>`:''}
    </div>
  </div>
  ${c.spells&&c.spells.length?`<div class="sec"><h2>Spells</h2><table><tr style="font-size:.75rem;color:#7a4800"><td>Name</td><td>Level</td><td>School</td><td>Cast Time</td><td>Damage</td><td>Save</td></tr>${c.spells.map(s=>`<tr><td>${s.name}${s.concentration==='yes'?' ¬©':''}${s.ritual==='yes'?' (R)':''}</td><td>${s.level===0?'Cantrip':'L'+s.level}</td><td>${s.school}</td><td>${s.castTime||'‚Äî'}</td><td>${s.damage||'‚Äî'}</td><td>${s.save||'‚Äî'}</td></tr>`).join('')}</table></div>`:''}
  ${c.equipment&&c.equipment.length?`<div class="sec"><h2>Equipment</h2><table><tr style="font-size:.75rem;color:#7a4800"><td>Item</td><td>Qty</td><td>Weight</td><td>Notes</td></tr>${c.equipment.map(e=>`<tr><td>${e.name}</td><td>${e.qty}</td><td>${e.wt}lb</td><td>${e.note||''}</td></tr>`).join('')}</table><p style="margin-top:8px;font-size:.85rem">Currency: ${c.cp||0}cp / ${c.sp||0}sp / ${c.ep||0}ep / ${c.gp||0}gp / ${c.pp||0}pp</p></div>`:''}
  ${c.traits||c.ideals||c.bonds||c.flaws?`<div class="sec"><h2>Personality</h2><div class="two-col"><div>${c.traits?`<p><b>Traits:</b> ${c.traits}</p>`:''}${c.ideals?`<p><b>Ideals:</b> ${c.ideals}</p>`:''}</div><div>${c.bonds?`<p><b>Bonds:</b> ${c.bonds}</p>`:''}${c.flaws?`<p><b>Flaws:</b> ${c.flaws}</p>`:''}</div></div></div>`:''}
  ${c.backstory?`<div class="sec"><h2>Backstory</h2><p>${c.backstory}</p></div>`:''}
  ${c.notes?`<div class="sec"><h2>Session Notes</h2><p>${c.notes}</p></div>`:''}
  </body></html>`);
}

/* =============================================================================
   MODAL HELPERS
============================================================================= */
function openModal(id)  { document.getElementById(id).classList.add('open'); }
function closeModal(id) { document.getElementById(id).classList.remove('open'); }
window.onclick = e => { if (e.target.classList.contains('modal-bg')) e.target.classList.remove('open'); };


/* =============================================================================
   CAMPAIGN TAB SYSTEM
============================================================================= */
function cpTab(cpId, panel, btn) {
  // Deactivate all tabs and panels for this campaign card
  const card = btn.closest('.campaign-card');
  card.querySelectorAll('.cp-tab').forEach(t => t.classList.remove('active'));
  card.querySelectorAll('.cp-panel').forEach(p => p.style.display = 'none');
  btn.classList.add('active');
  document.getElementById(`cp-${panel}-${cpId}`).style.display = 'block';
}

/* =============================================================================
   QUESTS
============================================================================= */
function renderQuestList(cp) {
  if (!cp.quests || !cp.quests.length) return '<div class="muted" style="font-size:.85rem">No quests yet.</div>';
  const colors = { active:'#c9a84c', completed:'#55a055', failed:'#e05555' };
  return cp.quests.map((q, i) => `
    <div style="background:var(--dark3);border-left:3px solid ${colors[q.status]||'#c9a84c'};padding:8px 10px;margin-bottom:6px;display:flex;justify-content:space-between;align-items:flex-start;gap:8px">
      <div>
        <div style="font-family:'Cinzel',serif;font-size:.82rem;color:${colors[q.status]||'var(--gold)'}">${q.name} <span style="font-size:.7rem;font-style:italic">[${q.status}]</span></div>
        ${q.objective ? `<div style="font-size:.84rem;color:var(--parch2);margin-top:2px">${q.objective}</div>` : ''}
      </div>
      <div style="display:flex;gap:4px;flex-shrink:0">
        ${q.status==='active' ? `<button class="btn btn-outline btn-sm" style="padding:2px 6px;font-size:.7rem" onclick="updateQuestStatus('${cp.id}',${i},'completed')">‚úì</button>` : ''}
        <button class="btn btn-red btn-sm" style="padding:2px 6px;font-size:.7rem" onclick="removeQuest('${cp.id}',${i})">‚úï</button>
      </div>
    </div>`).join('');
}

function addQuest(cpId) {
  const name = document.getElementById(`quest-input-${cpId}`)?.value.trim();
  if (!name) return;
  const status = document.getElementById(`quest-status-${cpId}`)?.value || 'active';
  const obj    = document.getElementById(`quest-obj-${cpId}`)?.value.trim();
  const data = getUserData();
  const cp = data.campaigns.find(c => c.id === cpId);
  if (!cp) return;
  cp.quests = cp.quests || [];
  cp.quests.push({ name, status, objective: obj });
  saveUserData(data);
  document.getElementById(`quest-input-${cpId}`).value = '';
  document.getElementById(`quest-obj-${cpId}`).value = '';
  document.getElementById(`quest-list-${cpId}`).innerHTML = renderQuestList(cp);
}

function removeQuest(cpId, idx) {
  const data = getUserData();
  const cp = data.campaigns.find(c => c.id === cpId);
  if (!cp || !cp.quests) return;
  cp.quests.splice(idx, 1);
  saveUserData(data);
  document.getElementById(`quest-list-${cpId}`).innerHTML = renderQuestList(cp);
}

function updateQuestStatus(cpId, idx, status) {
  const data = getUserData();
  const cp = data.campaigns.find(c => c.id === cpId);
  if (!cp || !cp.quests) return;
  cp.quests[idx].status = status;
  saveUserData(data);
  document.getElementById(`quest-list-${cpId}`).innerHTML = renderQuestList(cp);
}

/* =============================================================================
   LOOT TRACKER
============================================================================= */
function renderLootList(cp) {
  if (!cp.loot || !cp.loot.length) return '<div class="muted" style="font-size:.85rem">No loot tracked yet.</div>';
  return `<table style="width:100%;font-size:.84rem;border-collapse:collapse">
    <tr style="color:var(--gold2);font-family:'Cinzel',serif;font-size:.72rem">
      <td style="padding:3px 6px">Item</td><td>Qty</td><td>Holder</td><td></td>
    </tr>
    ${cp.loot.map((l,i) => `<tr style="border-top:1px solid rgba(201,168,76,.1)">
      <td style="padding:4px 6px">${l.name}</td>
      <td>${l.qty||1}</td>
      <td style="color:var(--parch2)">${l.owner||'Unassigned'}</td>
      <td><button class="btn btn-red btn-sm" style="padding:1px 6px;font-size:.7rem" onclick="removeLoot('${cp.id}',${i})">‚úï</button></td>
    </tr>`).join('')}
  </table>`;
}

function addLoot(cpId) {
  const name = document.getElementById(`loot-input-${cpId}`)?.value.trim();
  if (!name) return;
  const qty   = parseInt(document.getElementById(`loot-qty-${cpId}`)?.value) || 1;
  const owner = document.getElementById(`loot-owner-${cpId}`)?.value.trim();
  const data = getUserData();
  const cp = data.campaigns.find(c => c.id === cpId);
  if (!cp) return;
  cp.loot = cp.loot || [];
  cp.loot.push({ name, qty, owner });
  saveUserData(data);
  document.getElementById(`loot-input-${cpId}`).value = '';
  document.getElementById(`loot-owner-${cpId}`).value = '';
  document.getElementById(`loot-list-${cpId}`).innerHTML = renderLootList(cp);
}

function removeLoot(cpId, idx) {
  const data = getUserData();
  const cp = data.campaigns.find(c => c.id === cpId);
  if (!cp || !cp.loot) return;
  cp.loot.splice(idx, 1);
  saveUserData(data);
  document.getElementById(`loot-list-${cpId}`).innerHTML = renderLootList(cp);
}

/* =============================================================================
   SESSION RECAPS
============================================================================= */
function renderRecapList(cp) {
  if (!cp.recaps || !cp.recaps.length) return '<div class="muted" style="font-size:.85rem">No session recaps yet.</div>';
  return cp.recaps.map((r, i) => `
    <div style="background:var(--dark3);border:1px solid rgba(201,168,76,.15);padding:8px 12px;margin-bottom:8px">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
        <div style="font-family:'Cinzel',serif;font-size:.78rem;color:var(--gold2)">${r.session || 'Session'} <span style="color:var(--parch2);font-weight:400">¬∑ ${r.date}</span></div>
        <button class="btn btn-red btn-sm" style="padding:1px 6px;font-size:.7rem" onclick="removeRecap('${cp.id}',${i})">‚úï</button>
      </div>
      <div style="font-size:.88rem;color:var(--parch2);white-space:pre-wrap">${r.text}</div>
    </div>`).join('');
}

function addRecap(cpId) {
  const text = document.getElementById(`recap-input-${cpId}`)?.value.trim();
  if (!text) return;
  const session = document.getElementById(`recap-session-${cpId}`)?.value.trim();
  const data = getUserData();
  const cp = data.campaigns.find(c => c.id === cpId);
  if (!cp) return;
  cp.recaps = cp.recaps || [];
  cp.recaps.unshift({ session, text, date: new Date().toLocaleDateString() });
  saveUserData(data);
  document.getElementById(`recap-input-${cpId}`).value = '';
  document.getElementById(`recap-session-${cpId}`).value = '';
  document.getElementById(`recap-list-${cpId}`).innerHTML = renderRecapList(cp);
}

function removeRecap(cpId, idx) {
  const data = getUserData();
  const cp = data.campaigns.find(c => c.id === cpId);
  if (!cp || !cp.recaps) return;
  cp.recaps.splice(idx, 1);
  saveUserData(data);
  document.getElementById(`recap-list-${cpId}`).innerHTML = renderRecapList(cp);
}

/* =============================================================================
   INITIATIVE TRACKER
============================================================================= */
let initList   = [];
let initTurn   = 0;
let initRound  = 1;

function addInitEntry() {
  const name = document.getElementById('init-name')?.value.trim();
  if (!name) return;
  const roll  = parseInt(document.getElementById('init-roll')?.value) || Math.ceil(Math.random()*20);
  const hp    = parseInt(document.getElementById('init-hp')?.value)   || 0;
  const ac    = parseInt(document.getElementById('init-ac')?.value)   || 10;
  const type  = document.getElementById('init-type')?.value || 'player';
  initList.push({ name, roll, hp, maxhp: hp, ac, type, conditions: [] });
  initList.sort((a,b) => b.roll - a.roll);
  initTurn = 0;
  renderInitList();
  ['init-name','init-roll','init-hp','init-ac'].forEach(id => { const el = document.getElementById(id); if(el) el.value = ''; });
}

function rollAllInit() {
  initList.forEach(e => { e.roll = Math.ceil(Math.random()*20); });
  initList.sort((a,b) => b.roll - a.roll);
  initTurn = 0;
  renderInitList();
}

function renderInitList() {
  const el = document.getElementById('init-list');
  const rd = document.getElementById('init-round');
  if (!el) return;
  if (rd) rd.textContent = initList.length ? `Round ${initRound} ¬∑ Turn ${initTurn+1}/${initList.length}` : '';
  if (!initList.length) { el.innerHTML = '<div class="muted" style="font-size:.85rem">No combatants yet.</div>'; return; }
  const typeColors = { player:'rgba(85,160,85,.15)', enemy:'rgba(139,32,32,.2)', ally:'rgba(50,100,180,.15)' };
  el.innerHTML = initList.map((e, i) => `
    <div style="background:${typeColors[e.type]||'var(--dark3)'};border:1px solid ${i===initTurn?'var(--gold)':'rgba(201,168,76,.15)'};
      padding:8px 12px;margin-bottom:4px;display:flex;align-items:center;gap:10px;flex-wrap:wrap;
      ${i===initTurn?'box-shadow:0 0 6px rgba(201,168,76,.3)':''}">
      <div style="font-family:'Cinzel',serif;font-size:.82rem;color:var(--gold2);min-width:24px;text-align:center">${e.roll}</div>
      <div style="font-family:'Cinzel',serif;flex:1;font-size:.9rem;color:${i===initTurn?'var(--gold)':'var(--parch)'}">${i===initTurn?'‚ñ∂ ':' '}${e.name}</div>
      <div style="font-size:.8rem;color:var(--parch2)">
        HP: <input type="number" value="${e.hp}" style="width:55px;margin:0;padding:2px 4px;font-size:.8rem;display:inline-block"
          onchange="updateInitHP(${i},this.value)">/${e.maxhp} ¬∑ AC ${e.ac}
      </div>
      <div style="display:flex;gap:4px">
        <button class="btn btn-outline btn-sm" style="padding:2px 6px;font-size:.7rem" onclick="initDamage(${i},-1)">-1</button>
        <button class="btn btn-outline btn-sm" style="padding:2px 6px;font-size:.7rem" onclick="initDamage(${i},-5)">-5</button>
        <button class="btn btn-outline btn-sm" style="padding:2px 6px;font-size:.7rem;color:#55a055" onclick="initDamage(${i},5)">+5</button>
        <button class="btn btn-red btn-sm" style="padding:2px 6px;font-size:.7rem" onclick="initList.splice(${i},1);renderInitList()">‚úï</button>
      </div>
    </div>`).join('');
}

function updateInitHP(i, val) { if (initList[i]) { initList[i].hp = parseInt(val)||0; } }
function initDamage(i, amt) {
  if (!initList[i]) return;
  initList[i].hp = Math.max(0, initList[i].hp + amt);
  renderInitList();
}
function nextInitTurn()  { if (!initList.length) return; initTurn = (initTurn+1) % initList.length; renderInitList(); }
function prevInitTurn()  { if (!initList.length) return; initTurn = (initTurn - 1 + initList.length) % initList.length; renderInitList(); }
function nextInitRound() { if (!initList.length) return; initRound++; initTurn = 0; renderInitList(); }
function clearInitTracker() { initList=[]; initTurn=0; initRound=1; renderInitList(); }

/* =============================================================================
   PARTY VIEW
============================================================================= */
function refreshPartyView() {
  const el = document.getElementById('party-view-list');
  if (!el) return;
  const data = getUserData();
  if (!data.characters || !data.characters.length) {
    el.innerHTML = '<div class="muted">No characters saved yet.</div>';
    return;
  }
  const condColors = { Blinded:'#aaa', Charmed:'#e8a', Poisoned:'#8e8', Prone:'#fa8',
    Frightened:'#f66', Stunned:'#a8f', Paralyzed:'#f8a', Unconscious:'#888', Exhausted:'#fa4' };
  el.innerHTML = `<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:10px">` +
    data.characters.map(c => {
      const hpPct = c.maxhp ? Math.round((c.curhp/c.maxhp)*100) : 0;
      const hpColor = hpPct > 50 ? '#55a055' : hpPct > 25 ? '#c9a84c' : '#e05555';
      const conds = (c.activeConditions||[]).map(cn =>
        `<span style="font-size:.68rem;padding:1px 5px;background:rgba(80,80,80,.4);border-radius:2px;color:${condColors[cn]||'#ccc'}">${cn}</span>`
      ).join('');
      return `<div style="background:var(--dark3);border:1px solid rgba(201,168,76,.2);padding:10px">
        <div style="font-family:'Cinzel',serif;font-size:.85rem;color:var(--gold);margin-bottom:2px">${c.name||'Unnamed'}</div>
        <div style="font-size:.78rem;color:var(--parch2);margin-bottom:6px">Lvl ${c.level||1} ${c.race||''} ${c.cls||''}</div>
        <div style="display:flex;justify-content:space-between;font-size:.8rem;margin-bottom:4px">
          <span>HP: <strong style="color:${hpColor}">${c.curhp||0}/${c.maxhp||0}</strong></span>
          <span>AC: <strong>${c.ac||10}</strong></span>
        </div>
        <div style="background:var(--dark4);height:6px;border-radius:2px;overflow:hidden;margin-bottom:6px">
          <div style="background:${hpColor};height:100%;width:${hpPct}%;transition:width .3s"></div>
        </div>
        ${c.inspiration ? '<span style="font-size:.72rem;color:var(--gold)">‚òÖ Inspired</span>' : ''}
        ${c.exhaustion > 0 ? `<span style="font-size:.72rem;color:#f66"> ¬∑ Exhaustion ${c.exhaustion}</span>` : ''}
        ${conds ? `<div style="display:flex;flex-wrap:wrap;gap:3px;margin-top:4px">${conds}</div>` : ''}
      </div>`;
    }).join('') + '</div>';
}

/* =============================================================================
   NPC / MONSTER STAT BLOCKS
============================================================================= */
let npcList = [];

function addNPC() {
  const name = document.getElementById('npc-name')?.value.trim();
  if (!name) return;
  npcList.push({
    name,
    hp:      parseInt(document.getElementById('npc-hp')?.value) || 10,
    maxhp:   parseInt(document.getElementById('npc-hp')?.value) || 10,
    ac:      parseInt(document.getElementById('npc-ac')?.value) || 10,
    speed:   parseInt(document.getElementById('npc-speed')?.value) || 30,
    cr:      document.getElementById('npc-cr')?.value || '‚Äî',
    type:    document.getElementById('npc-type')?.value || 'Humanoid',
    attacks: document.getElementById('npc-attacks')?.value || '',
    traits:  document.getElementById('npc-traits')?.value || '',
    notes:   document.getElementById('npc-notes')?.value || '',
  });
  renderNPCList();
  ['npc-name','npc-hp','npc-ac','npc-speed','npc-cr','npc-attacks','npc-traits','npc-notes'].forEach(id => {
    const el = document.getElementById(id); if(el) el.value = '';
  });
}

function renderNPCList() {
  const el = document.getElementById('npc-list');
  if (!el) return;
  if (!npcList.length) { el.innerHTML = ''; return; }
  el.innerHTML = npcList.map((n, i) => `
    <div style="background:var(--dark3);border:1px solid rgba(201,168,76,.2);padding:10px 12px;margin-bottom:8px">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:8px;flex-wrap:wrap">
        <div>
          <div style="font-family:'Cinzel',serif;color:var(--gold);font-size:.9rem">${n.name} <span style="font-size:.72rem;color:var(--parch2);font-family:'Crimson Text',serif">¬∑ ${n.type} ¬∑ CR ${n.cr}</span></div>
          <div style="font-size:.82rem;color:var(--parch2);margin-top:2px">
            AC ${n.ac} ¬∑ Speed ${n.speed}ft ¬∑
            HP: <input type="number" value="${n.hp}" style="width:48px;margin:0;padding:1px 4px;font-size:.8rem;display:inline-block" onchange="npcList[${i}].hp=parseInt(this.value)||0">/${n.maxhp}
          </div>
          ${n.attacks ? `<div style="font-size:.82rem;margin-top:3px"><strong style="color:var(--gold2)">Attacks:</strong> ${n.attacks}</div>` : ''}
          ${n.traits  ? `<div style="font-size:.82rem;margin-top:2px"><strong style="color:var(--gold2)">Traits:</strong> ${n.traits}</div>` : ''}
          ${n.notes   ? `<div style="font-size:.8rem;color:var(--parch2);font-style:italic;margin-top:2px">${n.notes}</div>` : ''}
        </div>
        <div style="display:flex;gap:4px;align-items:flex-start">
          <button class="btn btn-outline btn-sm" style="padding:2px 6px;font-size:.7rem" onclick="npcDmg(${i},-1)">-1</button>
          <button class="btn btn-outline btn-sm" style="padding:2px 6px;font-size:.7rem" onclick="npcDmg(${i},-5)">-5</button>
          <button class="btn btn-outline btn-sm" style="padding:2px 6px;font-size:.7rem" onclick="addToInit('${n.name}',${n.hp},${n.ac})">+ Init</button>
          <button class="btn btn-red btn-sm" style="padding:2px 6px;font-size:.7rem" onclick="npcList.splice(${i},1);renderNPCList()">‚úï</button>
        </div>
      </div>
    </div>`).join('');
}

function npcDmg(i, amt) {
  if (!npcList[i]) return;
  npcList[i].hp = Math.max(0, npcList[i].hp + amt);
  renderNPCList();
}

function addToInit(name, hp, ac) {
  const roll = Math.ceil(Math.random()*20);
  initList.push({ name, roll, hp, maxhp:hp, ac, type:'enemy', conditions:[] });
  initList.sort((a,b) => b.roll - a.roll);
  renderInitList();
  showSection('dmtools');
}

/* =============================================================================
   TACTICAL MAP
============================================================================= */
let mapCanvas, mapCtx, mapSize = 20, mapCellSize = 28, mapGrid = [], mapHistory = [];
const MAP_COLORS = { wall:'#4a3825', difficult:'#1a3a1a', water:'#0a1a2e', empty:'#1a1510' };

function initTacticalMap() {
  mapCanvas = document.getElementById('tactical-map');
  if (!mapCanvas) return;
  mapCtx = mapCanvas.getContext('2d');
  resizeMap();
  mapCanvas.addEventListener('click', onMapClick);
  mapCanvas.addEventListener('contextmenu', onMapRightClick);
}

function resizeMap() {
  mapSize = parseInt(document.getElementById('map-size')?.value) || 20;
  mapCellSize = Math.min(32, Math.floor(560 / mapSize));
  mapGrid = Array(mapSize).fill(null).map(() => Array(mapSize).fill(null).map(() => ({ terrain: 'empty', token: null })));
  mapHistory = [];
  if (mapCanvas) {
    mapCanvas.width  = mapSize * mapCellSize;
    mapCanvas.height = mapSize * mapCellSize;
    drawMap();
  }
}

function drawMap() {
  if (!mapCtx) return;
  for (let r = 0; r < mapSize; r++) {
    for (let c = 0; c < mapSize; c++) {
      const cell = mapGrid[r][c];
      const x = c * mapCellSize, y = r * mapCellSize, sz = mapCellSize;
      // Terrain fill
      mapCtx.fillStyle = MAP_COLORS[cell.terrain] || MAP_COLORS.empty;
      mapCtx.fillRect(x, y, sz, sz);
      // Grid line
      mapCtx.strokeStyle = 'rgba(201,168,76,0.15)';
      mapCtx.lineWidth = 0.5;
      mapCtx.strokeRect(x, y, sz, sz);
      // Token
      if (cell.token) {
        mapCtx.fillStyle = cell.token.color || '#c9a84c';
        mapCtx.beginPath();
        mapCtx.arc(x + sz/2, y + sz/2, sz/2 - 3, 0, Math.PI*2);
        mapCtx.fill();
        mapCtx.strokeStyle = 'rgba(0,0,0,0.5)';
        mapCtx.lineWidth = 1;
        mapCtx.stroke();
        if (cell.token.label) {
          mapCtx.fillStyle = '#000';
          mapCtx.font = `bold ${Math.max(8, sz/3.5)}px sans-serif`;
          mapCtx.textAlign = 'center';
          mapCtx.textBaseline = 'middle';
          mapCtx.fillText(cell.token.label.substring(0,3), x + sz/2, y + sz/2);
        }
      }
    }
  }
}

function onMapClick(e) {
  const rect = mapCanvas.getBoundingClientRect();
  const c = Math.floor((e.clientX - rect.left) / mapCellSize);
  const r = Math.floor((e.clientY - rect.top)  / mapCellSize);
  if (r < 0 || r >= mapSize || c < 0 || c >= mapSize) return;
  const tool  = document.getElementById('map-tool')?.value || 'token';
  const label = document.getElementById('map-token-label')?.value.trim() || '';
  const color = document.getElementById('map-token-color')?.value || '#c9a84c';
  // Save undo snapshot
  mapHistory.push(JSON.parse(JSON.stringify(mapGrid)));
  if (mapHistory.length > 30) mapHistory.shift();
  const cell = mapGrid[r][c];
  if (tool === 'erase') {
    cell.terrain = 'empty';
    cell.token   = null;
  } else if (tool === 'token') {
    cell.token = cell.token ? null : { label, color };
  } else {
    cell.terrain = cell.terrain === tool ? 'empty' : tool;
  }
  drawMap();
}

function onMapRightClick(e) {
  e.preventDefault();
  const rect = mapCanvas.getBoundingClientRect();
  const c = Math.floor((e.clientX - rect.left) / mapCellSize);
  const r = Math.floor((e.clientY - rect.top)  / mapCellSize);
  if (r < 0 || r >= mapSize || c < 0 || c >= mapSize) return;
  mapHistory.push(JSON.parse(JSON.stringify(mapGrid)));
  mapGrid[r][c].token = null;
  drawMap();
}

function clearMap() { resizeMap(); }
function undoMap() {
  if (!mapHistory.length) return;
  mapGrid = mapHistory.pop();
  drawMap();
}

/* =============================================================================
   SPELL DATABASE
============================================================================= */
const SPELL_DB = [
  // Cantrips
  {name:'Fire Bolt',level:0,school:'Evocation',classes:['Artificer','Sorcerer','Wizard'],castTime:'1 action',range:'120ft',duration:'Instantaneous',components:'V,S',damage:'1d10 (2d10@5, 3d10@11, 4d10@17) fire',desc:'Ranged spell attack. Ignites flammable objects.'},
  {name:'Eldritch Blast',level:0,school:'Evocation',classes:['Warlock'],castTime:'1 action',range:'120ft',duration:'Instantaneous',components:'V,S',damage:'1d10 force per beam',desc:'1 beam at 1st, 2 at 5th, 3 at 11th, 4 at 17th. Invocations can modify.'},
  {name:'Sacred Flame',level:0,school:'Evocation',classes:['Cleric'],castTime:'1 action',range:'60ft',duration:'Instantaneous',components:'V,S',damage:'1d8 (2d8@5, 3d8@11, 4d8@17) radiant',desc:'DEX save. No cover bonus. Hits invisible creatures.'},
  {name:'Shillelagh',level:0,school:'Transmutation',classes:['Druid'],castTime:'Bonus action',range:'Touch',duration:'1 minute',components:'V,S,M',desc:'Club/quarterstaff uses WIS for attacks and deals 1d8.'},
  {name:'Mage Hand',level:0,school:'Conjuration',classes:['Artificer','Bard','Sorcerer','Warlock','Wizard'],castTime:'1 action',range:'30ft',duration:'1 minute',components:'V,S',desc:'Spectral hand to manipulate objects within 30ft. Can\'t attack or carry more than 10lbs.'},
  {name:'Vicious Mockery',level:0,school:'Enchantment',classes:['Bard'],castTime:'1 action',range:'60ft',duration:'Instantaneous',components:'V',damage:'1d4 (2d4@5, 3d4@11, 4d4@17) psychic',desc:'WIS save or take damage + disadvantage on next attack roll.'},
  {name:'Toll the Dead',level:0,school:'Necromancy',classes:['Cleric','Warlock','Wizard'],castTime:'1 action',range:'60ft',duration:'Instantaneous',components:'V,S',damage:'1d8 (or 1d12 if already injured) necrotic',desc:'WIS save. Deals more damage if target is missing HP.'},
  {name:'Minor Illusion',level:0,school:'Illusion',classes:['Bard','Sorcerer','Warlock','Wizard'],castTime:'1 action',range:'30ft',duration:'1 minute',components:'S,M',desc:'Create a sound or image within range. INT (Investigation) check to see through.'},
  {name:'Prestidigitation',level:0,school:'Transmutation',classes:['Artificer','Bard','Sorcerer','Warlock','Wizard'],castTime:'1 action',range:'10ft',duration:'1 hour',components:'V,S',desc:'Minor magical tricks: clean/soil, light, sound, flavor, symbol, small non-magical item.'},
  {name:'Guidance',level:0,school:'Divination',classes:['Artificer','Cleric','Druid'],castTime:'1 action',range:'Touch',duration:'Concentration, 1 min',components:'V,S',desc:'Willing creature adds 1d4 to one ability check.'},
  // 1st level
  {name:'Cure Wounds',level:1,school:'Evocation',classes:['Artificer','Bard','Cleric','Druid','Paladin','Ranger'],castTime:'1 action',range:'Touch',duration:'Instantaneous',components:'V,S',desc:'Touch creature regains 1d8+spellcasting modifier HP. +1d8 per slot level above 1st.'},
  {name:'Magic Missile',level:1,school:'Evocation',classes:['Sorcerer','Wizard'],castTime:'1 action',range:'120ft',duration:'Instantaneous',components:'V,S',damage:'3 darts √ó 1d4+1 force (auto-hit)',desc:'3 darts that always hit. Each dart: 1d4+1 force. +1 dart per slot level above 1st.'},
  {name:'Shield',level:1,school:'Abjuration',classes:['Sorcerer','Wizard'],castTime:'Reaction',range:'Self',duration:'1 round',components:'V,S',desc:'+5 AC until start of your next turn. Blocks magic missile.'},
  {name:'Healing Word',level:1,school:'Evocation',classes:['Bard','Cleric','Druid'],castTime:'Bonus action',range:'60ft',duration:'Instantaneous',components:'V',desc:'Creature regains 1d4+spellcasting modifier HP. +1d4 per slot above 1st.'},
  {name:'Hex',level:1,school:'Enchantment',classes:['Warlock'],castTime:'Bonus action',range:'90ft',duration:'Concentration, 1 hour',components:'V,S,M',desc:'Curse a creature. +1d6 necrotic on each of your hits. Impose disadv on chosen ability checks. Move to new target when original drops.'},
  {name:'Hunter\'s Mark',level:1,school:'Divination',classes:['Ranger'],castTime:'Bonus action',range:'90ft',duration:'Concentration, 1 hour',components:'V',desc:'+1d6 damage on weapon attacks vs marked target. Adv on Perception/Survival to find them. Move mark as bonus action.'},
  {name:'Bless',level:1,school:'Enchantment',classes:['Cleric','Paladin'],castTime:'1 action',range:'30ft',duration:'Concentration, 1 minute',components:'V,S,M',desc:'Up to 3 creatures add 1d4 to attack rolls and saving throws. +1 creature per slot above 1st.'},
  {name:'Thunderwave',level:1,school:'Evocation',classes:['Bard','Druid','Sorcerer','Wizard'],castTime:'1 action',range:'Self (15ft cube)',duration:'Instantaneous',components:'V,S',damage:'2d8 thunder',desc:'CON save. Fail: 2d8 thunder + pushed 10ft. Success: half. Unsecured objects are thrown. +2d8 per slot above 1st.'},
  {name:'Chromatic Orb',level:1,school:'Evocation',classes:['Sorcerer','Wizard'],castTime:'1 action',range:'90ft',duration:'Instantaneous',components:'V,S,M',damage:'3d8 chosen element',desc:'Ranged spell attack. Choose: acid, cold, fire, lightning, poison, or thunder. +1d8 per slot above 1st.'},
  {name:'Find Familiar',level:1,school:'Conjuration',classes:['Wizard'],castTime:'1 hour ritual',range:'10ft',duration:'Instantaneous',components:'V,S,M',desc:'Summon a familiar. Can see through its senses. Use reaction to deliver touch spells through it.'},
  {name:'Disguise Self',level:1,school:'Illusion',classes:['Bard','Sorcerer','Wizard'],castTime:'1 action',range:'Self',duration:'1 hour',components:'V,S',desc:'Change apparent appearance. INT (Investigation) DC vs spell save DC to see through.'},
  {name:'Detect Magic',level:1,school:'Divination',classes:['Artificer','Bard','Cleric','Druid','Paladin','Ranger','Sorcerer','Wizard'],castTime:'1 action (or ritual)',range:'Self (30ft sphere)',duration:'Concentration, 10 min',components:'V,S',desc:'Sense magic within 30ft. Use action to see aura and school.'},
  // 2nd level
  {name:'Misty Step',level:2,school:'Conjuration',classes:['Sorcerer','Warlock','Wizard'],castTime:'Bonus action',range:'Self',duration:'Instantaneous',components:'V',desc:'Teleport up to 30ft to an unoccupied space you can see.'},
  {name:'Hold Person',level:2,school:'Enchantment',classes:['Bard','Cleric','Druid','Sorcerer','Warlock','Wizard'],castTime:'1 action',range:'60ft',duration:'Concentration, 1 minute',components:'V,S,M',desc:'WIS save or paralyzed. Repeat save each turn. +1 target per slot above 2nd.'},
  {name:'Scorching Ray',level:2,school:'Evocation',classes:['Sorcerer','Wizard'],castTime:'1 action',range:'120ft',duration:'Instantaneous',components:'V,S',damage:'3 rays √ó 2d6 fire',desc:'3 ranged spell attack rays. Each hits for 2d6 fire. +1 ray per slot above 2nd.'},
  {name:'Spiritual Weapon',level:2,school:'Evocation',classes:['Cleric'],castTime:'Bonus action',range:'60ft',duration:'1 minute (no conc)',components:'V,S',damage:'1d8+spellcasting mod force',desc:'Create weapon. Bonus action: move 20ft + melee spell attack. +1d8 per 2 slot levels above 2nd.'},
  {name:'Invisibility',level:2,school:'Illusion',classes:['Artificer','Bard','Sorcerer','Warlock','Wizard'],castTime:'1 action',range:'Touch',duration:'Concentration, 1 hour',components:'V,S,M',desc:'Target is invisible until it attacks or casts a spell. +1 creature per slot above 2nd.'},
  {name:'Shatter',level:2,school:'Evocation',classes:['Bard','Sorcerer','Warlock','Wizard'],castTime:'1 action',range:'60ft',duration:'Instantaneous',components:'V,S,M',damage:'3d8 thunder',desc:'10ft sphere. CON save. Fail: 3d8 thunder; inorganic material has disadv. Always damages nonmagical objects. +1d8 per slot above 2nd.'},
  // 3rd level
  {name:'Fireball',level:3,school:'Evocation',classes:['Sorcerer','Wizard'],castTime:'1 action',range:'150ft',duration:'Instantaneous',components:'V,S,M',damage:'8d6 fire',desc:'20ft radius sphere. DEX save for half. +1d6 per slot above 3rd.'},
  {name:'Counterspell',level:3,school:'Abjuration',classes:['Sorcerer','Warlock','Wizard'],castTime:'Reaction',range:'60ft',duration:'Instantaneous',components:'S',desc:'Auto-counter spells ‚â§3rd level. For higher: ability check DC 10+spell level.'},
  {name:'Hypnotic Pattern',level:3,school:'Illusion',classes:['Bard','Sorcerer','Warlock','Wizard'],castTime:'1 action',range:'120ft',duration:'Concentration, 1 minute',components:'S,M',desc:'30ft cube. WIS save or incapacitated + speed 0. Broken by damage or shaking (action).'},
  {name:'Spirit Guardians',level:3,school:'Conjuration',classes:['Cleric'],castTime:'1 action',range:'Self (15ft)',duration:'Concentration, 10 min',components:'V,S,M',damage:'3d8 radiant/necrotic',desc:'15ft radius aura. WIS save on entry/start of turn. Difficult terrain for enemies. +1d8 per slot above 3rd.'},
  {name:'Lightning Bolt',level:3,school:'Evocation',classes:['Sorcerer','Wizard'],castTime:'1 action',range:'Self (100ft line)',duration:'Instantaneous',components:'V,S,M',damage:'8d6 lightning',desc:'100ft √ó 5ft line. DEX save for half. +1d6 per slot above 3rd.'},
  {name:'Fly',level:3,school:'Transmutation',classes:['Artificer','Sorcerer','Warlock','Wizard'],castTime:'1 action',range:'Touch',duration:'Concentration, 10 min',components:'V,S,M',desc:'Fly speed 60ft. +1 creature per slot above 3rd.'},
  {name:'Animate Dead',level:3,school:'Necromancy',classes:['Cleric','Wizard'],castTime:'1 minute',range:'10ft',duration:'Instantaneous',components:'V,S,M',desc:'Create undead skeleton or zombie from bones/corpse. Commands on bonus action. +2 undead per slot above 3rd.'},
  // 4th level
  {name:'Banishment',level:4,school:'Abjuration',classes:['Cleric','Paladin','Sorcerer','Warlock','Wizard'],castTime:'1 action',range:'60ft',duration:'Concentration, 1 minute',components:'V,S,M',desc:'CHA save or banished. Native creatures: temp incapacitated. Extraplanar: permanently if held 1 min. +1 creature per slot above 4th.'},
  {name:'Greater Invisibility',level:4,school:'Illusion',classes:['Bard','Sorcerer','Wizard'],castTime:'1 action',range:'Touch',duration:'Concentration, 1 minute',components:'V,S',desc:'Invisible even while attacking or casting.'},
  {name:'Polymorph',level:4,school:'Transmutation',classes:['Bard','Druid','Sorcerer','Wizard'],castTime:'1 action',range:'60ft',duration:'Concentration, 1 hour',components:'V,S,M',desc:'WIS save. Transform creature into beast (CR ‚â§ target\'s CR or level). New HP pool. Reverts if reduced to 0 HP.'},
  {name:'Dimension Door',level:4,school:'Conjuration',classes:['Bard','Sorcerer','Warlock','Wizard'],castTime:'1 action',range:'500ft',duration:'Instantaneous',components:'V',desc:'Teleport up to 500ft. Can bring one willing creature of your size or smaller.'},
  // 5th level
  {name:'Hold Monster',level:5,school:'Enchantment',classes:['Bard','Sorcerer','Warlock','Wizard'],castTime:'1 action',range:'90ft',duration:'Concentration, 1 minute',components:'V,S,M',desc:'Like Hold Person but works on any creature. WIS save or paralyzed. +1 creature per slot above 5th.'},
  {name:'Cone of Cold',level:5,school:'Evocation',classes:['Sorcerer','Wizard'],castTime:'1 action',range:'Self (60ft cone)',duration:'Instantaneous',components:'V,S,M',damage:'8d8 cold',desc:'60ft cone. CON save for half. Creatures killed become frozen statues. +1d8 per slot above 5th.'},
  {name:'Wall of Force',level:5,school:'Evocation',classes:['Wizard'],castTime:'1 action',range:'120ft',duration:'Concentration, 10 min',components:'V,S,M',desc:'Invisible impenetrable force wall. Up to ten 10√ó10 panels. Immune to all damage. Dispel magic or disintegrate destroys it.'},
  {name:'Mass Cure Wounds',level:5,school:'Evocation',classes:['Bard','Cleric','Druid'],castTime:'1 action',range:'60ft',duration:'Instantaneous',components:'V,S',desc:'Up to 6 creatures within 30ft sphere each regain 3d8+spellcasting modifier HP. +1d8 per slot above 5th.'},
  // 6th+
  {name:'Disintegrate',level:6,school:'Transmutation',classes:['Sorcerer','Wizard'],castTime:'1 action',range:'60ft',duration:'Instantaneous',components:'V,S,M',damage:'10d6+40 force',desc:'DEX save or 10d6+40 force. Creature reduced to 0 HP: disintegrated. +3d6 per slot above 6th.'},
  {name:'Chain Lightning',level:6,school:'Evocation',classes:['Sorcerer','Wizard'],castTime:'1 action',range:'150ft',duration:'Instantaneous',components:'V,S,M',damage:'10d8 lightning',desc:'Primary target + 3 secondary. DEX save for half. +1 secondary per slot above 6th.'},
  {name:'Finger of Death',level:7,school:'Necromancy',classes:['Sorcerer','Wizard'],castTime:'1 action',range:'60ft',duration:'Instantaneous',components:'V,S',damage:'7d8+30 necrotic',desc:'CON save for half. Humanoid killed rises as zombie under your permanent control.'},
  {name:'Power Word Kill',level:9,school:'Enchantment',classes:['Sorcerer','Warlock','Wizard'],castTime:'1 action',range:'60ft',duration:'Instantaneous',components:'V',desc:'Creature with 100 HP or fewer dies instantly. No save.'},
  {name:'Wish',level:9,school:'Conjuration',classes:['Sorcerer','Wizard'],castTime:'1 action',range:'Self',duration:'Instantaneous',components:'V',desc:'The most powerful spell. Duplicate any spell ‚â§8th level. Or attempt any effect. 33% chance of losing Wish permanently after non-duplication use.'},
];

function filterSpellDB() {
  const el = document.getElementById('spell-db-results');
  if (!el) return;
  const q      = (document.getElementById('spell-search-db')?.value || '').toLowerCase();
  const cls    = document.getElementById('spell-filter-class')?.value || '';
  const lvl    = document.getElementById('spell-filter-level')?.value;
  const school = document.getElementById('spell-filter-school')?.value || '';

  const filtered = SPELL_DB.filter(s => {
    if (q && !s.name.toLowerCase().includes(q) && !s.desc.toLowerCase().includes(q)) return false;
    if (cls    && !s.classes.includes(cls))          return false;
    if (lvl !== '' && lvl !== undefined && s.level !== parseInt(lvl)) return false;
    if (school && s.school !== school)               return false;
    return true;
  });

  if (!filtered.length) { el.innerHTML = '<div class="muted" style="padding:20px">No spells match your filters.</div>'; return; }

  el.innerHTML = filtered.map(s => `
    <div style="background:var(--dark3);border:1px solid rgba(201,168,76,.15);padding:10px 12px;margin-bottom:6px">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:8px;flex-wrap:wrap">
        <div>
          <span style="font-family:'Cinzel',serif;color:var(--gold);font-size:.9rem">${s.name}</span>
          <span style="font-size:.75rem;color:var(--parch2);margin-left:8px">${s.level===0?'Cantrip':s.level+'th-level'} ${s.school}</span>
        </div>
        <div style="display:flex;gap:4px;flex-wrap:wrap">
          ${s.classes.map(c => `<span style="font-size:.68rem;padding:1px 5px;background:rgba(201,168,76,.1);border:1px solid rgba(201,168,76,.2);color:var(--gold2)">${c}</span>`).join('')}
        </div>
      </div>
      <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:4px;font-size:.8rem;margin:6px 0;color:var(--parch2)">
        <span>‚è± ${s.castTime}</span>
        <span>üìç ${s.range}</span>
        <span>‚è≥ ${s.duration}</span>
        <span>‚úã ${s.components}</span>
        ${s.damage ? `<span>üí• ${s.damage}</span>` : ''}
      </div>
      <div style="font-size:.85rem;color:var(--parch2)">${s.desc}</div>
    </div>`).join('');
}

/* =============================================================================
   EQUIPMENT SHOP
============================================================================= */
const SHOP_ITEMS = [
  // Simple Weapons
  {name:'Club',cat:'Simple Weapons',cost:'1 sp',wt:2,desc:'1d4 bludgeoning ¬∑ Light'},
  {name:'Dagger',cat:'Simple Weapons',cost:'2 gp',wt:1,desc:'1d4 piercing ¬∑ Finesse, light, thrown (20/60)'},
  {name:'Handaxe',cat:'Simple Weapons',cost:'5 gp',wt:2,desc:'1d6 slashing ¬∑ Light, thrown (20/60)'},
  {name:'Javelin',cat:'Simple Weapons',cost:'5 sp',wt:2,desc:'1d6 piercing ¬∑ Thrown (30/120)'},
  {name:'Quarterstaff',cat:'Simple Weapons',cost:'2 sp',wt:4,desc:'1d6/1d8 bludgeoning ¬∑ Versatile'},
  {name:'Shortbow',cat:'Simple Weapons',cost:'25 gp',wt:2,desc:'1d6 piercing ¬∑ Range 80/320, two-handed'},
  {name:'Sling',cat:'Simple Weapons',cost:'1 sp',wt:0,desc:'1d4 bludgeoning ¬∑ Range 30/120'},
  // Martial Weapons
  {name:'Longsword',cat:'Martial Weapons',cost:'15 gp',wt:3,desc:'1d8/1d10 slashing ¬∑ Versatile'},
  {name:'Rapier',cat:'Martial Weapons',cost:'25 gp',wt:2,desc:'1d8 piercing ¬∑ Finesse'},
  {name:'Greatsword',cat:'Martial Weapons',cost:'50 gp',wt:6,desc:'2d6 slashing ¬∑ Heavy, two-handed'},
  {name:'Greataxe',cat:'Martial Weapons',cost:'30 gp',wt:7,desc:'1d12 slashing ¬∑ Heavy, two-handed'},
  {name:'Hand Crossbow',cat:'Martial Weapons',cost:'75 gp',wt:3,desc:'1d6 piercing ¬∑ Range 30/120, light, loading'},
  {name:'Longbow',cat:'Martial Weapons',cost:'50 gp',wt:2,desc:'1d8 piercing ¬∑ Range 150/600, heavy, two-handed'},
  {name:'Shortsword',cat:'Martial Weapons',cost:'10 gp',wt:2,desc:'1d6 piercing ¬∑ Finesse, light'},
  {name:'Scimitar',cat:'Martial Weapons',cost:'25 gp',wt:3,desc:'1d6 slashing ¬∑ Finesse, light'},
  {name:'Warhammer',cat:'Martial Weapons',cost:'15 gp',wt:2,desc:'1d8/1d10 bludgeoning ¬∑ Versatile'},
  {name:'Glaive',cat:'Martial Weapons',cost:'20 gp',wt:6,desc:'1d10 slashing ¬∑ Heavy, reach, two-handed'},
  {name:'Battleaxe',cat:'Martial Weapons',cost:'10 gp',wt:4,desc:'1d8/1d10 slashing ¬∑ Versatile'},
  // Light Armor
  {name:'Padded Armor',cat:'Light Armor',cost:'5 gp',wt:8,desc:'AC 11+DEX ¬∑ Stealth disadvantage'},
  {name:'Leather Armor',cat:'Light Armor',cost:'10 gp',wt:10,desc:'AC 11+DEX'},
  {name:'Studded Leather',cat:'Light Armor',cost:'45 gp',wt:13,desc:'AC 12+DEX'},
  // Medium Armor
  {name:'Hide Armor',cat:'Medium Armor',cost:'10 gp',wt:12,desc:'AC 12+DEX (max 2)'},
  {name:'Chain Shirt',cat:'Medium Armor',cost:'50 gp',wt:20,desc:'AC 13+DEX (max 2)'},
  {name:'Scale Mail',cat:'Medium Armor',cost:'50 gp',wt:45,desc:'AC 14+DEX (max 2) ¬∑ Stealth disadvantage'},
  {name:'Breastplate',cat:'Medium Armor',cost:'400 gp',wt:20,desc:'AC 14+DEX (max 2)'},
  {name:'Half Plate',cat:'Medium Armor',cost:'750 gp',wt:40,desc:'AC 15+DEX (max 2) ¬∑ Stealth disadvantage'},
  // Heavy Armor
  {name:'Ring Mail',cat:'Heavy Armor',cost:'30 gp',wt:40,desc:'AC 14 ¬∑ Stealth disadvantage'},
  {name:'Chain Mail',cat:'Heavy Armor',cost:'75 gp',wt:55,desc:'AC 16 ¬∑ STR 13 req ¬∑ Stealth disadvantage'},
  {name:'Splint Armor',cat:'Heavy Armor',cost:'200 gp',wt:60,desc:'AC 17 ¬∑ STR 15 req ¬∑ Stealth disadvantage'},
  {name:'Plate Armor',cat:'Heavy Armor',cost:'1,500 gp',wt:65,desc:'AC 18 ¬∑ STR 15 req ¬∑ Stealth disadvantage'},
  // Shields
  {name:'Shield',cat:'Shields',cost:'10 gp',wt:6,desc:'+2 AC ¬∑ Requires one free hand'},
  // Adventuring Gear
  {name:'Backpack',cat:'Adventuring Gear',cost:'2 gp',wt:5,desc:'Holds 30lbs / 1 cubic ft'},
  {name:'Bedroll',cat:'Adventuring Gear',cost:'1 gp',wt:7,desc:'For sleeping outdoors'},
  {name:'Rope (50ft)',cat:'Adventuring Gear',cost:'1 gp',wt:10,desc:'Hempen rope, 2 HP, AC 11'},
  {name:'Torch',cat:'Adventuring Gear',cost:'1 cp',wt:1,desc:'Bright light 20ft, dim 40ft ¬∑ 1 hour'},
  {name:'Lantern (hooded)',cat:'Adventuring Gear',cost:'5 gp',wt:2,desc:'Bright 30ft, dim 60ft ¬∑ 6hr/pint oil'},
  {name:'Healing Potion',cat:'Adventuring Gear',cost:'50 gp',wt:0.5,desc:'Restore 2d4+2 HP as action or bonus action'},
  {name:'Thieves\' Tools',cat:'Tools',cost:'25 gp',wt:1,desc:'Required for picking locks and disarming traps'},
  {name:'Herbalism Kit',cat:'Tools',cost:'5 gp',wt:3,desc:'Create antitoxin and healing potions'},
  {name:'Alchemist\'s Supplies',cat:'Tools',cost:'50 gp',wt:8,desc:'Create alchemical items. Craft healing potions.'},
  {name:'Tinker\'s Tools',cat:'Tools',cost:'50 gp',wt:10,desc:'Construct and repair small devices'},
  // Mounts
  {name:'Horse (riding)',cat:'Mounts',cost:'75 gp',wt:0,desc:'Speed 60ft ¬∑ Carry 480lbs'},
  {name:'Warhorse',cat:'Mounts',cost:'400 gp',wt:0,desc:'Speed 60ft ¬∑ AC 11 ¬∑ STR 18'},
  {name:'Pony',cat:'Mounts',cost:'30 gp',wt:0,desc:'Speed 40ft ¬∑ Carry 225lbs'},
  {name:'Mule',cat:'Mounts',cost:'8 gp',wt:0,desc:'Speed 40ft ¬∑ Carry 420lbs ¬∑ Sure-footed'},
];

function filterShop() {
  const el = document.getElementById('shop-results');
  if (!el) return;
  const q   = (document.getElementById('shop-search')?.value || '').toLowerCase();
  const cat = document.getElementById('shop-filter-cat')?.value || '';
  const filtered = SHOP_ITEMS.filter(s => {
    if (q && !s.name.toLowerCase().includes(q) && !s.desc.toLowerCase().includes(q)) return false;
    if (cat && s.cat !== cat) return false;
    return true;
  });
  if (!filtered.length) { el.innerHTML = '<div class="muted" style="padding:20px">No items found.</div>'; return; }
  const grouped = {};
  filtered.forEach(s => { if (!grouped[s.cat]) grouped[s.cat]=[]; grouped[s.cat].push(s); });
  el.innerHTML = Object.entries(grouped).map(([cat, items]) => `
    <div style="margin-bottom:12px">
      <div style="font-family:'Cinzel',serif;font-size:.78rem;color:var(--gold2);border-bottom:1px solid rgba(201,168,76,.2);padding-bottom:4px;margin-bottom:6px">${cat}</div>
      ${items.map(s => `
        <div style="display:flex;justify-content:space-between;align-items:center;padding:5px 0;border-bottom:1px solid rgba(201,168,76,.06);gap:8px">
          <div style="flex:1">
            <span style="font-size:.88rem;color:var(--parch)">${s.name}</span>
            <span style="font-size:.78rem;color:var(--parch2);margin-left:8px">${s.desc}</span>
          </div>
          <div style="display:flex;gap:8px;align-items:center;flex-shrink:0">
            <span style="font-size:.82rem;color:var(--gold);font-family:'Cinzel',serif">${s.cost}</span>
            <span style="font-size:.75rem;color:var(--parch2)">${s.wt}lb</span>
            <button class="btn btn-outline btn-sm" style="padding:2px 8px;font-size:.72rem"
              onclick="addShopItemToChar('${s.name.replace(/'/g,"\\'")}',${s.wt})">+ Add</button>
          </div>
        </div>`).join('')}
    </div>`).join('');
}

function addShopItemToChar(name, wt) {
  // Add directly to current character's equipment if creator is open
  const modal = document.getElementById('creator-modal');
  if (modal && modal.classList.contains('open')) {
    customEquip.push({ name, qty:1, wt, note:'' });
    renderEquipList();
    // Flash feedback
    const btn = event.target;
    const orig = btn.textContent;
    btn.textContent = '‚úì Added'; btn.style.color = '#55a055';
    setTimeout(() => { btn.textContent = orig; btn.style.color = ''; }, 1200);
  } else {
    alert(`Open a character first, then browse the shop to add "${name}" to their inventory.`);
  }
}
/* =============================================================================
   INITIALIZATION
============================================================================= */
buildAbilityGrid();
</script>
</body>
</html>
